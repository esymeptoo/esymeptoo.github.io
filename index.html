<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>周小e丶的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="周小e丶的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="周小e丶的博客">
<meta property="og:locale">
<meta property="article:author" content="周小e丶">
<meta property="article:tag" content="前端、吹比">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="周小e丶的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">周小e丶的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">coding...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-electron使用教程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/06/electron%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2023-05-06T07:00:01.000Z" itemprop="datePublished">2023-05-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/06/electron%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">Electron使用教程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="electron官网"><a href="#electron官网" class="headerlink" title="electron官网"></a><a target="_blank" rel="noopener" href="https://www.electronjs.org/">electron官网</a></h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ul>
<li>新建项目目录</li>
<li>yarn add electron</li>
<li>yarn add @electron-forge&#x2F;cli electron-rebuild -D</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><h5 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h5><ul>
<li>main.js 应用入口文件<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createWindow</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 加载UI代码</span></span><br><span class="line">    <span class="keyword">const</span> mainWindow = <span class="keyword">new</span> <span class="title class_">BrowserWindow</span>(&#123;</span><br><span class="line">        <span class="attr">fullscreen</span>: <span class="literal">true</span>,  <span class="comment">// 全屏窗口</span></span><br><span class="line">        <span class="comment">// kiosk: true,  // 服务亭模式</span></span><br><span class="line">        <span class="comment">// frame: false,  // 是否显示窗口边缘框架</span></span><br><span class="line">        <span class="comment">// resizable: false,  // 不可更改窗口尺寸</span></span><br><span class="line">        <span class="comment">// maximizable: true, // 支持最大化</span></span><br><span class="line">        <span class="comment">// show: false,  // 为了让初始化窗口显示无闪烁，先关闭显示，等待加载完成后再显示。</span></span><br><span class="line">        <span class="comment">// width: 800,</span></span><br><span class="line">        <span class="comment">// height: 600,</span></span><br><span class="line">        <span class="comment">// ...windowOpenConfig,</span></span><br><span class="line">        <span class="attr">webPreferences</span>: &#123;</span><br><span class="line">            <span class="comment">// 用于读取本地语音文件</span></span><br><span class="line">            <span class="attr">webSecurity</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="comment">// 是否能能在渲染页面中使用node模块</span></span><br><span class="line">            <span class="attr">nodeIntegration</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">nodeIntegrationInWorker</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// contextBridge usage 开启后打开沙盒模式 无法直接通过preload挂在在global上</span></span><br><span class="line">            <span class="comment">// contextIsolation: true,</span></span><br><span class="line">            <span class="attr">preload</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;preload.js&#x27;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 加载html代码 也可以是http链接 可以是个单页应用服务入口url</span></span><br><span class="line">    mainWindow.<span class="title function_">loadFile</span>(<span class="string">&#x27;./demo.html&#x27;</span>)</span><br><span class="line">    <span class="comment">// mainWindow.loadURL(&#x27;http://localhost:3000/demo.html&#x27;)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// This method will be called when Electron has finished</span></span><br><span class="line"><span class="comment">// initialization and is ready to create browser windows.</span></span><br><span class="line"><span class="comment">// Some APIs can only be used after this event occurs.</span></span><br><span class="line">app.<span class="title function_">whenReady</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">createWindow</span>()</span><br><span class="line">  <span class="comment">// 隐藏系统菜单</span></span><br><span class="line">  <span class="title class_">Menu</span>.<span class="title function_">setApplicationMenu</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  app.<span class="title function_">on</span>(<span class="string">&#x27;activate&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// On macOS it&#x27;s common to re-create a window in the app when the</span></span><br><span class="line">    <span class="comment">// dock icon is clicked and there are no other windows open.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">BrowserWindow</span>.<span class="title function_">getAllWindows</span>().<span class="property">length</span> === <span class="number">0</span>) <span class="title function_">createWindow</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Quit when all windows are closed, except on macOS. There, it&#x27;s common</span></span><br><span class="line"><span class="comment">// for applications and their menu bar to stay active until the user quits</span></span><br><span class="line"><span class="comment">// explicitly with Cmd + Q.</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;window-all-closed&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  systemLogger.<span class="title function_">info</span>(<span class="string">&#x27;主程序关闭&#x27;</span>)</span><br><span class="line">  <span class="comment">// 手动销毁子进程 经测试子进程内的socket会自动随子进程一起销毁</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">platform</span> !== <span class="string">&#x27;darwin&#x27;</span>) &#123;</span><br><span class="line">    app.<span class="title function_">quit</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>preload.js 负责与渲染进程进行通信<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The preload script runs before. It has access to web APIs</span></span><br><span class="line"><span class="comment"> * as well as Electron&#x27;s renderer process modules and some</span></span><br><span class="line"><span class="comment"> * polyfilled Node.js functions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * https://www.electronjs.org/docs/latest/tutorial/sandbox</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> &#123; contextBridge, ipcRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>)</span><br><span class="line"></span><br><span class="line">contextBridge.<span class="title function_">exposeInMainWorld</span>(<span class="string">&#x27;electronAPI&#x27;</span>, &#123;</span><br><span class="line">  </span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 主进程主动推送</span><br><span class="line">```js</span><br><span class="line">// 在main.js中主动发送</span><br><span class="line">mainWindow.webContents.send(&#x27;ui-receive-message&#x27;, &#123;</span><br><span class="line">    msg: &#x27;hello&#x27;,</span><br><span class="line">&#125;)</span><br><span class="line">// preload.js中</span><br><span class="line">contextBridge.exposeInMainWorld(&#x27;electronAPI&#x27;, &#123;</span><br><span class="line">    receive: (cb) =&gt; ipcRenderer.on(&#x27;ui-receive-message&#x27;, cb),</span><br><span class="line">&#125;)</span><br><span class="line">// UI层</span><br><span class="line">window.electronAPI.receive((sender, data) =&gt; &#123;</span><br><span class="line">    console.log(data.msg) // hello</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>渲染进程主动通信<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// preload.js</span></span><br><span class="line">contextBridge.<span class="title function_">exposeInMainWorld</span>(<span class="string">&#x27;electronAPI&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">logToFile</span>: <span class="function">(<span class="params">payload</span>) =&gt;</span> ipcRenderer.<span class="title function_">invoke</span>(<span class="string">&#x27;log-to-file&#x27;</span>, payload),</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// main.js 订阅消息</span></span><br><span class="line">ipcMain.<span class="title function_">handle</span>(<span class="string">&#x27;log-to-file&#x27;</span>, <span class="function">(<span class="params">event, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 打印日志到本地</span></span><br><span class="line">    logger.<span class="title function_">info</span>(data.<span class="property">msg</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// UI层</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">electronAPI</span>.<span class="title function_">logToFile</span>(&#123; <span class="attr">msg</span>: <span class="string">&#x27;操作失败&#x27;</span> &#125;)</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="自启动"><a href="#自启动" class="headerlink" title="自启动"></a>自启动</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">AutoLaunch</span> = <span class="built_in">require</span>(<span class="string">&#x27;auto-launch&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AppAutoLaunch</span> = <span class="keyword">new</span> <span class="title class_">AutoLaunch</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: app.<span class="title function_">getName</span>(),</span><br><span class="line">    <span class="comment">// path: &#x27;&#x27;,</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">AppAutoLaunch</span>.<span class="title function_">enable</span>()</span><br><span class="line"><span class="title class_">AppAutoLaunch</span>.<span class="title function_">isEnabled</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">isEnabled</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(isEnabled)&#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">AppAutoLaunch</span>.<span class="title function_">enable</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        systemLogger.<span class="title function_">error</span>(<span class="string">`自启动设置失败：<span class="subst">$&#123;parseError(err)&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>electron应用打包需要依赖 <code>@electron-forge/cli</code><br>可在<code>forge.config.js</code>文件中进行配置不同平台的打包设置<br>通过<code>electron-forge package</code>命令进行对应平台的打包操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; name &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./package.json&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">rebuildConfig</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">makers</span>: [</span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   name: &#x27;@electron-forge/maker-squirrel&#x27;,</span></span><br><span class="line">    <span class="comment">//   config: &#123;&#125;,</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   name: &#x27;@electron-forge/maker-zip&#x27;,</span></span><br><span class="line">    <span class="comment">//   platforms: [&#x27;darwin&#x27;],</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;@electron-forge/maker-deb&#x27;</span>,</span><br><span class="line">      <span class="attr">config</span>: &#123;</span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">productName</span>: name,</span><br><span class="line">          name,</span><br><span class="line">          <span class="attr">icon</span>: <span class="string">&#x27;image/logo.png&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   name: &#x27;@electron-forge/maker-rpm&#x27;,</span></span><br><span class="line">    <span class="comment">//   config: &#123;&#125;,</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CI-CD基础镜像搭建-以linux平台为例"><a href="#CI-CD基础镜像搭建-以linux平台为例" class="headerlink" title="CI&#x2F;CD基础镜像搭建 (以linux平台为例)"></a>CI&#x2F;CD基础镜像搭建 (以linux平台为例)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM node:14.20.0-alpine</span><br><span class="line"></span><br><span class="line">RUN apk update</span><br><span class="line">RUN apk add dpkg</span><br><span class="line">RUN apk add fakeroot</span><br><span class="line">RUN apk add rpm</span><br><span class="line">RUN apk add git</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/06/electron%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" data-id="cm54yagl00005b3hg0fzqhdde" data-title="Electron使用教程" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker%E3%80%81node/" rel="tag">docker、node</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-悲观锁-乐观锁" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/12/18/%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81/" class="article-date">
  <time class="dt-published" datetime="2020-12-18T06:40:19.000Z" itemprop="datePublished">2020-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/12/18/%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81/">悲观锁/乐观锁</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="什么场景需要加锁"><a href="#什么场景需要加锁" class="headerlink" title="什么场景需要加锁"></a>什么场景需要加锁</h4><p>在并发的场景下经常会出现多个请求同时打进服务，导致出现资源抢占的问题，比如库存、匹配的场景。</p>
<blockquote>
<p>举个库存的栗子，请求A和请求B同时进行下单操作，导致两个请求在获取库存余量的时候都是原始值，分别进行了库存-1的update操作，<br>但是最后我们会发现，原本库存应该减2，实际上只减了1，这就是并发带来的读写不一致问题，这时候就需要加锁操作。</p>
</blockquote>
<h4 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h4><blockquote>
<p>悲观锁认为任何时候都会有并发的资源抢占，也可以理解为独占锁，所以在加锁期间别的请求会处于等待中并重复请求该锁是否被释放。</p>
</blockquote>
<h5 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h5><ol>
<li>直接通过内存加锁 <a target="_blank" rel="noopener" href="https://github.com/neosmart/AsyncLock">asyncLock</a><blockquote>
<p>这种加锁方式是直接在内存里通过变量控制，将请求的执行回调通过一个key保存在队列(FIFO)里，</p>
</blockquote>
</li>
</ol>
<p>比如请求A进来：</p>
<blockquote>
<ul>
<li>如果队列为空，将回调A打进队列，并执行回调A，回调A执行完后会检查该队列中是否存在别的任务，如果存在则会循环调用</li>
<li>如果队列不为空，将回调A打进队列，等待前面的循环调用</li>
</ul>
</blockquote>
<p>直到该队列没有任务了，会通过key删除这个队列</p>
<p>看个简单的demo</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  private <span class="attr">pending</span>: boolean = <span class="literal">false</span></span><br><span class="line">  public <span class="attr">list</span>: any[] = []</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setPending</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">pending</span> = val</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">register</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="title function_">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">list</span>.<span class="title function_">push</span>([fn, resolve, reject])</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">pending</span>) <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">execute</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">execute</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPending</span>(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> [fn, resolve, reject] = <span class="variable language_">this</span>.<span class="property">list</span>.<span class="title function_">pop</span>()</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">fn</span>(resolve, reject)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setPending</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">list</span>.<span class="property">length</span>) <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">execute</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> <span class="title class_">Queue</span>()</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/xxx&#x27;</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> queue.<span class="title function_">register</span>(<span class="title function_">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">2000</span>)</span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">  ctx.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">data</span>: result,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这种加锁的方式优点成本比较低，对于并发不高的业务可以使用，但是缺点也很明显</p>
<ol>
<li>任务都是串行的，并发多了会造成阻塞</li>
<li>对于集群服务而言内存是不共享的，多台机器就不能这么玩了</li>
</ol>
</blockquote>
<ol start="2">
<li>引入redis锁<br>redis加分布式锁方法是通过原子操作实现的，众所周知原子操作是不可分割的，在执行完毕之前不会被任何其它任务或事件中断。<blockquote>
<p>所以我们在请求A打进来的时候对库存操作的加锁，这样请求B进来会先去读锁是否被释放，等锁释放了再去操作库存，这样就能够避免读写不一样的问题</p>
</blockquote>
</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RedisLock</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">expireTime</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">lockTimeout</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">expireUnit</span>: <span class="string">&#x27;PX&#x27;</span> | <span class="string">&#x27;EX&#x27;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">expireMode</span>: <span class="string">&#x27;NX&#x27;</span> | <span class="string">&#x27;XX&#x27;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">client</span>: <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">client, <span class="attr">options</span>: <span class="title class_">LockOption</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!client) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;缺少redis客户端&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expireTime</span> = options.<span class="property">expireTime</span> || <span class="number">2</span> <span class="comment">// 锁的有效期</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lockTimeout</span> = options.<span class="property">lockTimeout</span> || <span class="number">5</span> <span class="comment">// 锁超时时间</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expireUnit</span> = options.<span class="property">expireUnit</span> || <span class="string">&#x27;EX&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expireMode</span> = options.<span class="property">expireMode</span> || <span class="string">&#x27;NX&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">client</span> = client</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加锁</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">lock</span>(<span class="params">key, val, expire?</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">retry</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 加锁</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> self.<span class="property">client</span>.<span class="title function_">set</span>(key, val, self.<span class="property">expireUnit</span>, expire || self.<span class="property">expireTime</span>, self.<span class="property">expireMode</span>)</span><br><span class="line">        <span class="keyword">if</span> (result === <span class="string">&#x27;OK&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">200</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">retry</span>()</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解锁</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">unlock</span>(<span class="params">key, val</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> script = <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then&quot;</span> +</span><br><span class="line">      <span class="string">&quot;   return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">      <span class="string">&quot;else&quot;</span> +</span><br><span class="line">      <span class="string">&quot;   return 0 &quot;</span> +</span><br><span class="line">      <span class="string">&quot;end&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">client</span>.<span class="built_in">eval</span>(script, <span class="number">1</span>, key, val)</span><br><span class="line">      <span class="keyword">return</span> result === <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码加锁的时候使用了’NX’，保证锁存在时再有进程进行加锁会执行失败，且解锁过程是需要执行lua脚本进行原子操作<br>如何使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> lock = <span class="keyword">new</span> <span class="title class_">RedisLock</span>(redis)</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/xxx&#x27;</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> lock.<span class="title function_">lock</span>(<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;val&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">sleep</span>(xxx)</span><br><span class="line">  <span class="keyword">await</span> lock.<span class="title function_">unlock</span>(<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;val&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>使用redis分布式锁的好处是redis读取速度快且能在集群中使用，当然并发量高了也能在使用redis加锁的同时做一层redis缓存提升服务性能。</p>
<h4 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h4><p>乐观锁是一种极其乐观的加锁方式，它认为不会出现资源抢占的情况，常见的策略比如CAS(Compare and Swap)，在执行写操作前我们记录数据的初始值和预期值，<br>更新时check一下初始值和数据库当前的值 如果一样就将预期值更新进去，否则就认为是过期请求，再次尝试。</p>
<p>乐观锁的使用成本比较高，因为会出现ABA的情况，库存可能被请求B从3修改成2，又从2修改成3，这样A的原始值和预期值是一样的，就需要在表里增加version标记每次更新的版本。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/12/18/%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81/" data-id="cm54yagl5000wb3hgdwu5c06p" data-title="悲观锁/乐观锁" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs-%E9%94%81-%E5%B9%B6%E5%8F%91/" rel="tag">nodejs 锁 并发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-qiankun微前端初探" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/23/qiankun%E5%BE%AE%E5%89%8D%E7%AB%AF%E5%88%9D%E6%8E%A2/" class="article-date">
  <time class="dt-published" datetime="2020-11-23T07:01:26.000Z" itemprop="datePublished">2020-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/23/qiankun%E5%BE%AE%E5%89%8D%E7%AB%AF%E5%88%9D%E6%8E%A2/">qiankun微前端实践</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="什么微前端？"><a href="#什么微前端？" class="headerlink" title="什么微前端？"></a>什么微前端？</h3><p>这几年微前端还是比较火的概念，旨在将后端微服务的理念应用于浏览器端，<br>把Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用</p>
<h3 id="微前端的价值"><a href="#微前端的价值" class="headerlink" title="微前端的价值"></a>微前端的价值</h3><h5 id="场景一"><a href="#场景一" class="headerlink" title="场景一"></a>场景一</h5><p>作为项目管理者，我希望降低单体项目的维护成本(子应用拆分场景&#x2F;在业务系统聚合的同时降低复杂度)</p>
<h5 id="场景二"><a href="#场景二" class="headerlink" title="场景二"></a>场景二</h5><p>作为开发，我希望使用在保持老业务代码不动的情况下使用新的技术(子应用技术栈无关&#x2F;避免全量升级版本)</p>
<h5 id="场景三"><a href="#场景三" class="headerlink" title="场景三"></a>场景三</h5><p>作为开发，我希望在不同的项目技术环境中复用相同的代码模块以提升开发效率(微前端模块)</p>
<h3 id="为什么不用iframe"><a href="#为什么不用iframe" class="headerlink" title="为什么不用iframe"></a>为什么不用iframe</h3><ol>
<li>子项目需要改造，需要提供一组不带导航的功能</li>
<li>iframe嵌入的显示区大小不容易控制，存在一定局限性</li>
<li>URL的记录完全无效，页面刷新不能够被记忆，刷新会返回首页</li>
<li>iframe功能之间的跳转是无效的</li>
<li>iframe的样式显示、兼容性等都具有局限性</li>
</ol>
<h3 id="通过这篇文章你将了解到"><a href="#通过这篇文章你将了解到" class="headerlink" title="通过这篇文章你将了解到"></a>通过这篇文章你将了解到</h3><ol>
<li>qiankun是怎样运行的</li>
<li>qiankun沙盒是如何实现的</li>
<li>qiankun是通过什么方式获取到子应用入口文件的钩子函数的</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://qiankun.umijs.org/zh/api#registermicroappsapps-lifecycles">官网文档</a></p>
<h2 id="qiankun运行机制"><a href="#qiankun运行机制" class="headerlink" title="qiankun运行机制"></a>qiankun运行机制</h2><h3 id="single-spa"><a href="#single-spa" class="headerlink" title="single-spa"></a>single-spa</h3><p><a target="_blank" rel="noopener" href="https://github.com/single-spa/single-spa">不多讲</a></p>
<h3 id="HTML-Entry"><a href="#HTML-Entry" class="headerlink" title="HTML-Entry"></a>HTML-Entry</h3><p><a target="_blank" rel="noopener" href="https://github.com/kuitos/import-html-entry">import-html-entry</a></p>
<blockquote>
<p>qiankun支持通过html直接加载子应用，需要子应用在应用入口处暴露出相应的钩子函数并通过webpack打包成umd格式，<br>qiankun会在执行子应用js代码时通过<a href="#magic">magic</a>获取到子应用的钩子函数并执行。</p>
</blockquote>
<blockquote>
<p>相比于JS-Entry，好处是更加灵活，不需要在主应用声明很多scripts地址，<br>也不需要担心external库的更新问题，坏处是把解析消耗放在用户端</p>
</blockquote>
<h3 id="sandbox"><a href="#sandbox" class="headerlink" title="sandbox"></a>sandbox</h3><h4 id="js沙箱"><a href="#js沙箱" class="headerlink" title="js沙箱"></a>js沙箱</h4><h5 id="snapShotSandbox"><a href="#snapShotSandbox" class="headerlink" title="snapShotSandbox"></a>snapShotSandbox</h5><blockquote>
<p>非proxy沙箱用于兼容不支持proxy的浏览器，原理就是在子应用加载前保存window对象的快照，<br>子应用销毁之后使用快照对比window，获取到子应用加载期间的增量并保存，等子应用再次被加载时重新挂在window上</p>
</blockquote>
<h5 id="legacySandbox"><a href="#legacySandbox" class="headerlink" title="legacySandbox"></a>legacySandbox</h5><blockquote>
<p>基于proxy实现的沙箱，用于单例模式，也是qiankun初代版本的沙箱，该版本由singular字段控制是否使用legacySandbox，2.2版本之后使用设置loose为true</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sandbox</span>: &#123; <span class="attr">loose</span>: <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>该沙箱通过一个空对象fakeWindow去劫持全局window，重写空对象的set和get，</li>
</ol>
<ul>
<li>1.1 获取fakeWindow某个值触发 get 就从window上取，</li>
<li>1.2 增加window属性触发set就会记录到addedPropsMapInSandbox，</li>
<li>1.3 修改window属性触发set，将key和window[key]记录到modifiedPropsOriginalValueMapInSandbox，第二次修改这个属性不会再做记录</li>
<li>1.4 将变化的数据记录到currentUpdatedPropsValueMap</li>
<li>1.5 映射到window上以便下次 get 时能拿到已更新的数据</li>
</ul>
<ol start="2">
<li>子应用卸载时，将增量的数据从window上删除，将修改过的key对应的原数据还原到window上</li>
<li>子应用第二次加载时，通过currentUpdatedPropsValueMap恢复</li>
</ol>
<blockquote>
<p>这种沙箱会影响到全局window，因为会将proxy变化映射到window上，并没有做到真正意义上的js隔离，只适用于单例模式</p>
</blockquote>
<h5 id="proxySandbox"><a href="#proxySandbox" class="headerlink" title="proxySandbox"></a>proxySandbox</h5><ol>
<li>新的proxy沙箱在legacySandbox上进行了改进</li>
</ol>
<ul>
<li>1.1 先记录window上不可配置的属性(Infinity、NaN、undefined、document、location等)，创建一个空的fakeWindow，浅拷贝这些不可枚举属性的值</li>
<li>1.2 增加或者修改window属性时触发set将值记录到fakeWindow，如果这个值之前存在，直接赋值，不存在就通过Object.defineProperty创建一个descriptor</li>
<li>1.3 get操作则会从fakeWindow或者window取</li>
</ul>
<blockquote>
<p>新的proxy不会污染全局window，因为一些不可配置的属性已经被复制到fakeWindow上</p>
</blockquote>
<h4 id="css沙箱-css隔离"><a href="#css沙箱-css隔离" class="headerlink" title="css沙箱(css隔离)"></a>css沙箱(css隔离)</h4><p>experimentalStyleIsolation开启会让子应用的css添加scope</p>
<h4 id="dom沙箱-shadowDom"><a href="#dom沙箱-shadowDom" class="headerlink" title="dom沙箱(shadowDom)"></a>dom沙箱(shadowDom)</h4><p>开启strictStyleIsolation可使用shadowDom对子应用进行隔离</p>
<h3 id="应用通信"><a href="#应用通信" class="headerlink" title="应用通信"></a>应用通信</h3><h4 id="GlobalState"><a href="#GlobalState" class="headerlink" title="GlobalState"></a>GlobalState</h4><blockquote>
<p>qiankun提供了全局state的功能，子应用可以订阅主应用的全局state，<br>globalState变化检测方法类似redux管理state树的实现，只会检测第一层数据的变化。</p>
</blockquote>
<blockquote>
<p>问题是目前只适用于单例模式，只能同时存在一个订阅者</p>
</blockquote>
<h3 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h3><h4 id="qiankun如何在html内容里找到项目的入口文件呢"><a href="#qiankun如何在html内容里找到项目的入口文件呢" class="headerlink" title="qiankun如何在html内容里找到项目的入口文件呢?"></a>qiankun如何在html内容里找到项目的入口文件呢?</h4><blockquote>
<p>通过import-html-entry解析出所有的script标签 会找出带有 「entry」属性的script标签</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://r.xxx.com/xxx/vendor.xxxx.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://r.xxx.com/xxx/xxx.app.js&quot;</span> <span class="attr">entry</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上情况就会知道到xxx.app.js是我们的入口文件，那如果没有设置entry呢？</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://r.xxx.com/xxx/vendor.xxxx.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://r.xxx.com/xxx/xxx.app.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果没有设置entry，就会默认取最后一个script标签作为入口文件，这就牵扯到打包的顺序问题了<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/45979159/how-to-use-chunkssortmode-in-htmlwebpackplugin-webpack-2">chunksSortMode</a></p>
<h4 id="如何获取到子应用的钩子函数呢？"><a href="#如何获取到子应用的钩子函数呢？" class="headerlink" title="如何获取到子应用的钩子函数呢？"></a>如何获取到子应用的钩子函数呢？</h4><blockquote>
<p>上面我们获取到了子应用entry，import-html-entry采用了<a target="_blank" rel="noopener" href="https://github.com/systemjs/systemjs/blob/master/src/extras/global.js">systemjs</a>加载动态文件的方式，<br>执行入口文件代码前记录window的第一个属性、第二个属性和最后一个属性，执行完再对比这三个属性，如果第一个第二个属性一样但是最后一个属性变化，表示是entry执行的结果，<br>则会将这个属性对应的值作为子应用入口文件export出来的钩子。</p>
</blockquote>
<blockquote>
<p>然鹅这样实现有些漏洞，由于副作用或者浏览器兼容性问题<br><a target="_blank" rel="noopener" href="https://github.com/umijs/qiankun/issues/485">import-html-entry的getGlobalProp实现不合理</a><br><a target="_blank" rel="noopener" href="https://github.com/umijs/qiankun/issues/1013">global遍历顺序变化，导致子应用entry无法找到导出的生命周期函数</a><br>于是乎，qiankun增加了fallback方案，统一子应用注册的name和子应用打包时的libraryName，可在上面方案找不到时进行fallback</p>
</blockquote>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p><a target="_blank" rel="noopener" href="https://qiankun.umijs.org/zh/faq">常见问题汇总</a></p>
<h2 id="RFC"><a href="#RFC" class="headerlink" title="RFC"></a>RFC</h2><p><a target="_blank" rel="noopener" href="https://github.com/umijs/qiankun/issues/442">不算完善的RFC</a></p>
<h2 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h2><ol>
<li>官网文档不是很明确，demo也不是很清晰</li>
<li>官网文档跟新速度跟不上release发布</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/78362028">qiankun作者讲微前端</a></li>
<li><a target="_blank" rel="noopener" href="https://xiaomi-info.github.io/2020/04/14/fe-microfrontends-practice/">微前端在小米的实践</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/23/qiankun%E5%BE%AE%E5%89%8D%E7%AB%AF%E5%88%9D%E6%8E%A2/" data-id="cm54yagl2000bb3hgdxu76ir5" data-title="qiankun微前端实践" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qiankun%E3%80%81micro-frontend/" rel="tag">qiankun、micro-frontend</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Vue2-x之v-model详解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/19/Vue2-x%E4%B9%8Bv-model%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2019-12-19T08:39:16.000Z" itemprop="datePublished">2019-12-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/19/Vue2-x%E4%B9%8Bv-model%E8%AF%A6%E8%A7%A3/">Vue2.x之v-model详解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="传送门"><a href="#传送门" class="headerlink" title="传送门"></a>传送门</h4><p>在看本篇之前，你可以看看博主的另两篇文章，有助于对本篇的理解</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://esymeptoo.github.io/2019/12/16/Vue2-x%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E7%AF%87/">Vue2.x数据响应篇</a></li>
<li><a target="_blank" rel="noopener" href="https://esymeptoo.github.io/2019/12/18/Vue2-x-%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94Watcher%E7%AF%87%E8%AF%A6%E8%A7%A3/">Vue2.x-Watcher篇</a></li>
</ol>
<h4 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h4><p>传送门的两章详细讲述了Vue在处理数据响应的过程，但关于Vue在runtime时期的compile还没梳理，这章我们先从v-model开始吧。<br>v-model是Vue提供给用户做双向绑定的一个指令语法 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#v-model">原文传送门</a><br>官网对于用法讲得很清楚，可以给input、select、checkbox、radio和自定义组件使用v-model指令</p>
<h4 id="上demo"><a href="#上demo" class="headerlink" title="上demo"></a>上demo</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;root&quot;&gt;</span><br><span class="line">  &lt;input v-model=&quot;input.value&quot; type=&quot;text&quot; /&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script src=&quot;./vue.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  new Vue(&#123;</span><br><span class="line">    el: &#x27;#root&#x27;,</span><br><span class="line">    data() &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        value: &#x27;demo&#x27;,</span><br><span class="line">        input: &#123;</span><br><span class="line">          value: &#x27;demo&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>以上是我们常见的v-model用法，当我们再input内输入内容时 组件实例上的数据也会随之修改，这就实现了数据的双向绑定</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>在模板编译阶段，v-model会被解析到el.directives中，我们从genDirectives方法看起</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genDirectives</span> (<span class="params">el, state</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> dirs = el.<span class="property">directives</span>;</span><br><span class="line">  <span class="keyword">if</span> (!dirs) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="string">&#x27;directives:[&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> hasRuntime = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> i, l, dir, needRuntime;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = dirs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    dir = dirs[i];</span><br><span class="line">    needRuntime = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">var</span> gen = state.<span class="property">directives</span>[dir.<span class="property">name</span>];</span><br><span class="line">    <span class="keyword">if</span> (gen) &#123;</span><br><span class="line">      <span class="comment">// compile-time directive that manipulates AST.</span></span><br><span class="line">      <span class="comment">// returns true if it also needs a runtime counterpart.</span></span><br><span class="line">      needRuntime = !!<span class="title function_">gen</span>(el, dir, state.<span class="property">warn</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needRuntime) &#123;</span><br><span class="line">      hasRuntime = <span class="literal">true</span>;</span><br><span class="line">      res += <span class="string">&quot;&#123;name:\&quot;&quot;</span> + (dir.<span class="property">name</span>) + <span class="string">&quot;\&quot;,rawName:\&quot;&quot;</span> + (dir.<span class="property">rawName</span>) + <span class="string">&quot;\&quot;&quot;</span> + (dir.<span class="property">value</span> ? (<span class="string">&quot;,value:(&quot;</span> + (dir.<span class="property">value</span>) + <span class="string">&quot;),expression:&quot;</span> + (<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(dir.<span class="property">value</span>))) : <span class="string">&#x27;&#x27;</span>) + (dir.<span class="property">arg</span> ? (<span class="string">&quot;,arg:&quot;</span> + (dir.<span class="property">isDynamicArg</span> ? dir.<span class="property">arg</span> : (<span class="string">&quot;\&quot;&quot;</span> + (dir.<span class="property">arg</span>) + <span class="string">&quot;\&quot;&quot;</span>))) : <span class="string">&#x27;&#x27;</span>) + (dir.<span class="property">modifiers</span> ? (<span class="string">&quot;,modifiers:&quot;</span> + (<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(dir.<span class="property">modifiers</span>))) : <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;&#125;,&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasRuntime) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) + <span class="string">&#x27;]&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的目的是遍历el.directives里的指令，并用state里提供<br>el.directives的类型如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;model&#x27;</span>,</span><br><span class="line">    <span class="attr">rawName</span>: <span class="string">&#x27;v-model&#x27;</span>,</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;input.value&#x27;</span>,  <span class="comment">// v-mode后的的expression</span></span><br><span class="line">    ...rest, <span class="comment">// 其余属性 有兴趣可以打印出来看看</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>state.directives也提供了处理个指令的方法，对应如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="title function_">on</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="title function_">bind</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="title function_">text</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="title function_">html</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="title function_">model</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="title function_">cloak</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由此可见Vue提供了以上6中内置指令，有兴趣的同学可以到官网了解一下这几种常见指令的用法<br>回到正题，这里我们需要的是model处理指令的代码，如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">model</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el,</span></span><br><span class="line"><span class="params">  dir,</span></span><br><span class="line"><span class="params">  _warn</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  warn$1 = _warn;</span><br><span class="line">  <span class="keyword">var</span> value = dir.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">var</span> modifiers = dir.<span class="property">modifiers</span>;</span><br><span class="line">  <span class="keyword">var</span> tag = el.<span class="property">tag</span>;</span><br><span class="line">  <span class="keyword">var</span> type = el.<span class="property">attrsMap</span>.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// inputs with type=&quot;file&quot; are read only and setting the input&#x27;s</span></span><br><span class="line">    <span class="comment">// value will throw an error.</span></span><br><span class="line">    <span class="keyword">if</span> (tag === <span class="string">&#x27;input&#x27;</span> &amp;&amp; type === <span class="string">&#x27;file&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">warn$1</span>(</span><br><span class="line">        <span class="string">&quot;&lt;&quot;</span> + (el.<span class="property">tag</span>) + <span class="string">&quot; v-model=\&quot;&quot;</span> + value + <span class="string">&quot;\&quot; type=\&quot;file\&quot;&gt;:\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;File inputs are read only. Use a v-on:change listener instead.&quot;</span>,</span><br><span class="line">        el.<span class="property">rawAttrsMap</span>[<span class="string">&#x27;v-model&#x27;</span>]</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">component</span>) &#123;</span><br><span class="line">    <span class="title function_">genComponentModel</span>(el, value, modifiers);</span><br><span class="line">    <span class="comment">// component v-model doesn&#x27;t need extra runtime</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">&#x27;select&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">genSelect</span>(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">&#x27;input&#x27;</span> &amp;&amp; type === <span class="string">&#x27;checkbox&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">genCheckboxModel</span>(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">&#x27;input&#x27;</span> &amp;&amp; type === <span class="string">&#x27;radio&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">genRadioModel</span>(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">&#x27;input&#x27;</span> || tag === <span class="string">&#x27;textarea&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">genDefaultModel</span>(el, value, modifiers);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!config.<span class="title function_">isReservedTag</span>(tag)) &#123;</span><br><span class="line">    <span class="title function_">genComponentModel</span>(el, value, modifiers);</span><br><span class="line">    <span class="comment">// component v-model doesn&#x27;t need extra runtime</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">warn$1</span>(</span><br><span class="line">      <span class="string">&quot;&lt;&quot;</span> + (el.<span class="property">tag</span>) + <span class="string">&quot; v-model=\&quot;&quot;</span> + value + <span class="string">&quot;\&quot;&gt;: &quot;</span> +</span><br><span class="line">      <span class="string">&quot;v-model is not supported on this element type. &quot;</span> +</span><br><span class="line">      <span class="string">&#x27;If you are working with contenteditable, it\&#x27;s recommended to &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;wrap a library dedicated for that purpose inside a custom component.&#x27;</span>,</span><br><span class="line">      el.<span class="property">rawAttrsMap</span>[<span class="string">&#x27;v-model&#x27;</span>]</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ensure runtime directive metadata</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码不难看出不同类型的组件使用v-model，解析的方式也不一样，demo我们使用的是input，根据匹配规则我们先看第五个branch，genDefaultModel代码如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genDefaultModel</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el,</span></span><br><span class="line"><span class="params">  value,</span></span><br><span class="line"><span class="params">  modifiers</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> type = el.<span class="property">attrsMap</span>.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// warn if v-bind:value conflicts with v-model</span></span><br><span class="line">  <span class="comment">// except for inputs with v-bind:type</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> value$1 = el.<span class="property">attrsMap</span>[<span class="string">&#x27;v-bind:value&#x27;</span>] || el.<span class="property">attrsMap</span>[<span class="string">&#x27;:value&#x27;</span>];</span><br><span class="line">    <span class="keyword">var</span> typeBinding = el.<span class="property">attrsMap</span>[<span class="string">&#x27;v-bind:type&#x27;</span>] || el.<span class="property">attrsMap</span>[<span class="string">&#x27;:type&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (value$1 &amp;&amp; !typeBinding) &#123;</span><br><span class="line">      <span class="keyword">var</span> binding = el.<span class="property">attrsMap</span>[<span class="string">&#x27;v-bind:value&#x27;</span>] ? <span class="string">&#x27;v-bind:value&#x27;</span> : <span class="string">&#x27;:value&#x27;</span>;</span><br><span class="line">      <span class="title function_">warn$1</span>(</span><br><span class="line">        binding + <span class="string">&quot;=\&quot;&quot;</span> + value$1 + <span class="string">&quot;\&quot; conflicts with v-model on the same element &quot;</span> +</span><br><span class="line">        <span class="string">&#x27;because the latter already expands to a value binding internally&#x27;</span>,</span><br><span class="line">        el.<span class="property">rawAttrsMap</span>[binding]</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> ref = modifiers || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> lazy = ref.<span class="property">lazy</span>;</span><br><span class="line">  <span class="keyword">var</span> number = ref.<span class="property">number</span>;</span><br><span class="line">  <span class="keyword">var</span> trim = ref.<span class="property">trim</span>;</span><br><span class="line">  <span class="keyword">var</span> needCompositionGuard = !lazy &amp;&amp; type !== <span class="string">&#x27;range&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> event = lazy</span><br><span class="line">    ? <span class="string">&#x27;change&#x27;</span></span><br><span class="line">    : type === <span class="string">&#x27;range&#x27;</span></span><br><span class="line">      ? <span class="variable constant_">RANGE_TOKEN</span></span><br><span class="line">      : <span class="string">&#x27;input&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> valueExpression = <span class="string">&#x27;$event.target.value&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">    valueExpression = <span class="string">&quot;$event.target.value.trim()&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (number) &#123;</span><br><span class="line">    valueExpression = <span class="string">&quot;_n(&quot;</span> + valueExpression + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> code = <span class="title function_">genAssignmentCode</span>(value, valueExpression);</span><br><span class="line">  <span class="keyword">if</span> (needCompositionGuard) &#123;</span><br><span class="line">    code = <span class="string">&quot;if($event.target.composing)return;&quot;</span> + code;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addProp</span>(el, <span class="string">&#x27;value&#x27;</span>, (<span class="string">&quot;(&quot;</span> + value + <span class="string">&quot;)&quot;</span>));</span><br><span class="line">  <span class="title function_">addHandler</span>(el, event, code, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (trim || number) &#123;</span><br><span class="line">    <span class="title function_">addHandler</span>(el, <span class="string">&#x27;blur&#x27;</span>, <span class="string">&#x27;$forceUpdate()&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先判断el上是否也存在v-bind:value，为了防止和v-model冲突，会抛出错误<br>lazy、number、trim是v-model指令自带的修饰符，有兴趣的同学可以参考官网的用法</p>
<ol>
<li>lazy的目的是为了取代 input 监听 change 事件</li>
<li>number的目的是为了将字符串转化为有效数字</li>
<li>trim目的是为了去除首尾的空格<br>根据上面三个修饰符对valueExpression赋予了不同的值<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> code = <span class="title function_">genAssignmentCode</span>(value, valueExpression);</span><br></pre></td></tr></table></figure>
我们先看genAssignmentCode的代码<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genAssignmentCode</span> (<span class="params"></span></span><br><span class="line"><span class="params">  value,</span></span><br><span class="line"><span class="params">  assignment</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="title function_">parseModel</span>(value);</span><br><span class="line">  <span class="keyword">if</span> (res.<span class="property">key</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (value + <span class="string">&quot;=&quot;</span> + assignment)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">&quot;$set(&quot;</span> + (res.<span class="property">exp</span>) + <span class="string">&quot;, &quot;</span> + (res.<span class="property">key</span>) + <span class="string">&quot;, &quot;</span> + assignment + <span class="string">&quot;)&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
parseModal的代码我就不贴了，大致意思就是分析v-model的value，比如demo传入的是”input.value”，会被parseModal转化成<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">exp</span>: <span class="string">&#x27;input&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
众所周知，v-model后面可以传入模板字符串，比如name，也可以传入对象取值的表达式，比如person.name等，<br>如果我们v-model传的是”value”，返回结果是这样的<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">exp</span>: <span class="string">&#x27;value&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
如果我们传入的是”person.chinese.name”，返回如下<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">exp</span>: <span class="string">&#x27;person.chinese&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
接着看代码，根据我们的demo来看<br>如果v-model后面跟的是纯字符串”value”，返回”value &#x3D; $event.target.value”<br>如果v-model后面跟的对象模板字符串”input.value”，返回”$set(‘input’, ‘value’, $event.target.value)”<br>看到这儿，你应该能知道v-model是通过什么方式同步修改组件实例上的值了吧<br>回到getDefaultModel方法:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (needCompositionGuard) &#123;</span><br><span class="line">  code = <span class="string">&quot;if($event.target.composing)return;&quot;</span> + code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">addProp</span>(el, <span class="string">&#x27;value&#x27;</span>, (<span class="string">&quot;(&quot;</span> + value + <span class="string">&quot;)&quot;</span>));</span><br><span class="line"><span class="title function_">addHandler</span>(el, event, code, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span> (trim || number) &#123;</span><br><span class="line">  <span class="title function_">addHandler</span>(el, <span class="string">&#x27;blur&#x27;</span>, <span class="string">&#x27;$forceUpdate()&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
needCompositionGuard作用是处理了中文输入法的问题，并将’if($event.target.composing)return;’拼接到genAssignmentCode的结果前面<br>addProp:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addProp</span> (<span class="params">el, name, value, range, dynamic</span>) &#123;</span><br><span class="line">  (el.<span class="property">props</span> || (el.<span class="property">props</span> = [])).<span class="title function_">push</span>(<span class="title function_">rangeSetItem</span>(&#123; <span class="attr">name</span>: name, <span class="attr">value</span>: value, <span class="attr">dynamic</span>: dynamic &#125;, range));</span><br><span class="line">  el.<span class="property">plain</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
执行到这儿就相当于把v-model转换正v-bind:value&#x3D;”input.value”了<br>下一步addHandler的目的就是在el.events上增加input方法，把我们的code结果添加到input方法上，得到以下节点<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input v-bind:value=&quot;input.value&quot; type=&quot;text&quot; @input=&quot;if($event.target.composing)return;$set(&#x27;input&#x27;, &#x27;value&#x27;, $event.target.value)&quot; /&gt;</span><br></pre></td></tr></table></figure>
当然实际代码并不会直接生成这个dom节点，首先生成的应该是dom的ast结构，然后通过编译拼接成如下代码结构:<br>方便阅读，就不展示字符串了<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">with</span>(<span class="params"><span class="variable language_">this</span></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_c</span>(</span><br><span class="line">    <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">attrs</span>:&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;root&quot;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [</span><br><span class="line">      <span class="title function_">_c</span>(</span><br><span class="line">        <span class="string">&#x27;input&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">directives</span>:[&#123;<span class="attr">name</span>:<span class="string">&quot;model&quot;</span>,<span class="attr">rawName</span>:<span class="string">&quot;v-model&quot;</span>,<span class="attr">value</span>:(input.<span class="property">value</span>),<span class="attr">expression</span>:<span class="string">&quot;input.value&quot;</span>&#125;],</span><br><span class="line">          <span class="attr">attrs</span>:&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">          <span class="attr">domProps</span>:&#123;<span class="string">&quot;value&quot;</span>:(input.<span class="property">value</span>)&#125;,</span><br><span class="line">          <span class="attr">on</span>:&#123;<span class="string">&quot;input&quot;</span>:<span class="keyword">function</span>(<span class="params">$event</span>)&#123;<span class="keyword">if</span>($event.<span class="property">target</span>.<span class="property">composing</span>)<span class="keyword">return</span>;$set(input, <span class="string">&quot;value&quot;</span>, $event.<span class="property">target</span>.<span class="property">value</span>)&#125;</span><br><span class="line">        &#125;&#125;)</span><br><span class="line">    ]</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
以上的代码会通过new Function()进行封装并赋值给options.render，上一章讲到的render-watcher调用更新的时候实际调用的就是这段代码</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>v-model的原理现在看来其实很明确了，就是在编译过程中会将v-model装换成v-bind:value(当然，这点因组件而异)，并在el上添加input事件，<br>如果是深层的字符串模板，会生成$set对应的方法，若是单个字符串，会直接将value &#x3D; $event.target.value拼接到input方法上。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/12/19/Vue2-x%E4%B9%8Bv-model%E8%AF%A6%E8%A7%A3/" data-id="cm54yagky0001b3hgcvxggmqr" data-title="Vue2.x之v-model详解" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue2-x%E3%80%81%E6%8C%87%E4%BB%A4%E3%80%81v-model/" rel="tag">Vue2.x、指令、v-model</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Vue2-x-数据响应Watcher篇详解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/18/Vue2-x-%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94Watcher%E7%AF%87%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2019-12-18T07:45:39.000Z" itemprop="datePublished">2019-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/18/Vue2-x-%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94Watcher%E7%AF%87%E8%AF%A6%E8%A7%A3/">Vue2.x-数据响应Watcher篇详解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>上一章已经简单介绍了Vue2.x的数据响应系统的三个重要角色Observer、Dep、Watcher<br>本篇主要想讲述用户每次操作或者数据变动到底会发生什么？换个说法Watcher是如何收到通知去进行更新操作的?</p>
<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>上一章也提到了Watcher的三种类型</p>
<ol>
<li>computed-watcher</li>
<li>normal-watcher</li>
<li>render-watcher</li>
</ol>
<h3 id="computed-watcher"><a href="#computed-watcher" class="headerlink" title="computed-watcher"></a>computed-watcher</h3><p>在组件初始化的过程中，Vue会为每个计算属性都会生成一个Watcher，并且存到当前组件实例的_watchers里，但是这类watchers不会被立即和数据的Dep进行关联，这类watcher声明时使用了lazy属性<br>意味着在第一次调用的时候才会去添加依赖 初始化代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initState</span> (<span class="params">vm</span>) &#123;</span><br><span class="line">  vm.<span class="property">_watchers</span> = [];</span><br><span class="line">  <span class="keyword">var</span> opts = vm.<span class="property">$options</span>;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">props</span>) &#123; <span class="title function_">initProps</span>(vm, opts.<span class="property">props</span>); &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">methods</span>) &#123; <span class="title function_">initMethods</span>(vm, opts.<span class="property">methods</span>); &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">observe</span>(vm.<span class="property">_data</span> = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">computed</span>) &#123; <span class="title function_">initComputed</span>(vm, opts.<span class="property">computed</span>); &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点看initComputed</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> computedWatcherOptions = &#123; <span class="attr">lazy</span>: <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initComputed</span> (<span class="params">vm, computed</span>) &#123;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">var</span> watchers = vm.<span class="property">_computedWatchers</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// computed properties are just getters during SSR</span></span><br><span class="line">  <span class="keyword">var</span> isSSR = <span class="title function_">isServerRendering</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">    <span class="keyword">var</span> userDef = computed[key];</span><br><span class="line">    <span class="keyword">var</span> getter = <span class="keyword">typeof</span> userDef === <span class="string">&#x27;function&#x27;</span> ? userDef : userDef.<span class="property">get</span>;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; getter == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        (<span class="string">&quot;Getter is missing for computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot;.&quot;</span>),</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!isSSR) &#123;</span><br><span class="line">      <span class="comment">// create internal watcher for the computed property.</span></span><br><span class="line">      watchers[key] = <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">        vm,</span><br><span class="line">        getter || noop,</span><br><span class="line">        noop,</span><br><span class="line">        computedWatcherOptions</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// component-defined computed properties are already defined on the</span></span><br><span class="line">    <span class="comment">// component prototype. We only need to define computed properties defined</span></span><br><span class="line">    <span class="comment">// at instantiation here.</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">defineComputed</span>(vm, key, userDef);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> vm.<span class="property">$data</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>((<span class="string">&quot;The computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; is already defined in data.&quot;</span>), vm);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">props</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">props</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>((<span class="string">&quot;The computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; is already defined as a prop.&quot;</span>), vm);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码会遍历computed内的键值对，为每个计算属性声明一个Watcher并将该watcher以键值对的形式存在vm.<em>computedWatchers里，<br>注意lazy传的true，所以在执行构造函数的时候不会执行watcher.get，不会将该watcher收集到经过Observe劫持的数据的__ob</em>_.dep.subs里<br>再看defineComputed这个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sharedPropertyDefinition = &#123;</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">get</span>: noop,</span><br><span class="line">  <span class="attr">set</span>: noop</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defineComputed</span> (<span class="params"></span></span><br><span class="line"><span class="params">  target,</span></span><br><span class="line"><span class="params">  key,</span></span><br><span class="line"><span class="params">  userDef</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> shouldCache = !<span class="title function_">isServerRendering</span>();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> userDef === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = shouldCache</span><br><span class="line">      ? <span class="title function_">createComputedGetter</span>(key)</span><br><span class="line">      : <span class="title function_">createGetterInvoker</span>(userDef);</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = noop;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = userDef.<span class="property">get</span></span><br><span class="line">      ? shouldCache &amp;&amp; userDef.<span class="property">cache</span> !== <span class="literal">false</span></span><br><span class="line">        ? <span class="title function_">createComputedGetter</span>(key)</span><br><span class="line">        : <span class="title function_">createGetterInvoker</span>(userDef.<span class="property">get</span>)</span><br><span class="line">      : noop;</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = userDef.<span class="property">set</span> || noop;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">      sharedPropertyDefinition.<span class="property">set</span> === noop) &#123;</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        (<span class="string">&quot;Computed property \&quot;&quot;</span> + key + <span class="string">&quot;\&quot; was assigned to but it has no setter.&quot;</span>),</span><br><span class="line">        <span class="variable language_">this</span></span><br><span class="line">      );</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, sharedPropertyDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>defineComputed主要目的是在组件实例上定义该计算书型的getter和setter，还区分了用户有没有手写set&#x2F;get，<br>在页面调用这个计算属性的时候会调用createComputedGetter，代码如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createComputedGetter</span> (<span class="params">key</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">computedGetter</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> watcher = <span class="variable language_">this</span>.<span class="property">_computedWatchers</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_computedWatchers</span>[key];</span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="keyword">if</span> (watcher.<span class="property">dirty</span>) &#123;</span><br><span class="line">        watcher.<span class="title function_">evaluate</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        watcher.<span class="title function_">depend</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> watcher.<span class="property">value</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们关注watcher.evaluate()，evaluate内部会重新执行watcher.get()进行依赖收集，<br><a target="_blank" rel="noopener" href="https://esymeptoo.github.io/2019/12/16/Vue2-x%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E7%AF%87/">上一章提到过</a>，并且返回最终计算结果</p>
<h5 id="normal-watcher"><a href="#normal-watcher" class="headerlink" title="normal-watcher"></a>normal-watcher</h5><p>这类watcher是指watch钩子里声明的观察函数，当然也可以通过在组件mounted手动通过this.$watch()手动去声明，后面我们会讲述这两者的区别<br>看initWatch代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initWatch</span> (<span class="params">vm, watch</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> watch) &#123;</span><br><span class="line">    <span class="keyword">var</span> handler = watch[key];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(handler)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; handler.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">createWatcher</span>(vm, key, handler[i]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">createWatcher</span>(vm, key, handler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initWatch会遍历每个watch钩子里的键值对，创建一个Watcher实例，从以上代码可以分析出watcher可以有<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#watch">三种声明方式</a><br>createWatcher如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createWatcher</span> (<span class="params"></span></span><br><span class="line"><span class="params">  vm,</span></span><br><span class="line"><span class="params">  expOrFn,</span></span><br><span class="line"><span class="params">  handler,</span></span><br><span class="line"><span class="params">  options</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(handler)) &#123;</span><br><span class="line">    options = handler;</span><br><span class="line">    handler = handler.<span class="property">handler</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    handler = vm[handler];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm.$watch(expOrFn, handler, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而vm.$watch执行的就是new Watcher的操作了，此类型的watcher实例在执行构造函数的时候就会去调用watcher.get()，这点和computed-watcher不一样哦~</p>
<h3 id="render-watcher"><a href="#render-watcher" class="headerlink" title="render-watcher"></a>render-watcher</h3><p>上一章讲到过，这类watcher只会在每个组件$mount时声明，意味着每个组件实例都会有一个此类型的watcher，代码就不展示了，<br>这类watcher的作用就是提供组件内部更新的回调函数</p>
<h3 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;root&quot;&gt;</span><br><span class="line">  &lt;span&gt;&#123;&#123; name &#125;&#125;&lt;/span&gt;</span><br><span class="line">  &lt;span&gt;&#123;&#123; name &#125;&#125;&lt;/span&gt;</span><br><span class="line">  &lt;span&gt;&#123;&#123; age &#125;&#125;&lt;/span&gt;</span><br><span class="line">  &lt;button @click=&quot;handleAddAge&quot;&gt;add&lt;/button&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  new Vue(&#123;</span><br><span class="line">    el: &#x27;#root&#x27;,</span><br><span class="line">    data() &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        name: &#x27;demo&#x27;,</span><br><span class="line">        age: 12,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    computed: &#123;</span><br><span class="line">      res() &#123;</span><br><span class="line">        return this.name + this.age</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">      age() &#123;</span><br><span class="line">        this.name += 1</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">      handleAddAge() &#123;</span><br><span class="line">        this.age += 1</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>上面是一个简单的demo，以此demo我们分析一下初始化过程的依赖收集和用户点击按钮会发生什么吧hah</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><ol>
<li>initComputed</li>
<li>initWatch</li>
</ol>
<p>当然这两个步骤都是发生在Vue劫持了data、props之后的<br>我们打印出组件实例 依赖收集的情况如下图所示:<br><img src="https://s2.ax1x.com/2019/12/18/Q7jLGQ.md.jpg" alt="依赖"></p>
<ol>
<li>_computedWatchers存放就是每个计算属性的观察者实例</li>
<li>_watcher存放的是当前组件初始收集依赖和更新所以要的观察者</li>
<li>_watchers存放的是组件声明所有的watchers队列</li>
</ol>
<p>示例图最下面，Vue会为data里的每个值声明getter和setter，在使用defineReactive定义的时候，会创建Dep实例</p>
<blockquote>
<ol>
<li>所以初始化的结束后，name创建的Dep实例的subs里会存放一个watcher，为render-watcher，用于更新组件</li>
<li>而age也声明在watch里，所以它对应的Dep实例subs会存放两个watcher，一个normal-watcher和一个render-watcher</li>
<li>而在res被使用后，age和name创建的Dep实例的subs都会多一个computed-watcher</li>
</ol>
</blockquote>
<h3 id="数据变化"><a href="#数据变化" class="headerlink" title="数据变化"></a>数据变化</h3><p>点击add按钮会让age实现自增，相应会触发watch，同时更新视图，这是给开发者看到的情况，那更往下呢，我们慢慢分析</p>
<blockquote>
<p>执行了this.age +&#x3D; 1会触发age的setter 代码如下:</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (<span class="params">newVal</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val;</span><br><span class="line">  <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">  <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">  <span class="keyword">if</span> (customSetter) &#123;</span><br><span class="line">    <span class="title function_">customSetter</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">  <span class="keyword">if</span> (getter &amp;&amp; !setter) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">    setter.<span class="title function_">call</span>(obj, newVal);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    val = newVal;</span><br><span class="line">  &#125;</span><br><span class="line">  childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(newVal);</span><br><span class="line">  dep.<span class="title function_">notify</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">notify</span> () &#123;</span><br><span class="line">  <span class="comment">// stabilize the subscriber list first</span></span><br><span class="line">  <span class="keyword">const</span> subs = <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">slice</span>()</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !config.<span class="property">async</span>) &#123;</span><br><span class="line">    <span class="comment">// subs aren&#x27;t sorted in scheduler if not running async</span></span><br><span class="line">    <span class="comment">// we need to sort them now to make sure they fire in correct</span></span><br><span class="line">    <span class="comment">// order</span></span><br><span class="line">    subs.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">id</span> - b.<span class="property">id</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    subs[i].<span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>触发dep.notify从而触发watcher.update<br>注意是先排序再触发，id是自增的，说明watcher触发的顺序是一定的，也就是声明顺序的computed-watcher &gt; normal-watcher &gt; render-watcher</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Watcher</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">update</span> = <span class="keyword">function</span> <span class="title function_">update</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">lazy</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sync</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">run</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">queueWatcher</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>queueWatcher</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueWatcher</span> (<span class="params">watcher: Watcher</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = watcher.<span class="property">id</span></span><br><span class="line">  <span class="keyword">if</span> (has[id] == <span class="literal">null</span>) &#123;</span><br><span class="line">    has[id] = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (!flushing) &#123;</span><br><span class="line">      queue.<span class="title function_">push</span>(watcher)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// if already flushing, splice the watcher based on its id</span></span><br><span class="line">      <span class="comment">// if already past its id, it will be run next immediately.</span></span><br><span class="line">      <span class="keyword">let</span> i = queue.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">      <span class="keyword">while</span> (i &gt; index &amp;&amp; queue[i].<span class="property">id</span> &gt; watcher.<span class="property">id</span>) &#123;</span><br><span class="line">        i--</span><br><span class="line">      &#125;</span><br><span class="line">      queue.<span class="title function_">splice</span>(i + <span class="number">1</span>, <span class="number">0</span>, watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// queue the flush</span></span><br><span class="line">    <span class="keyword">if</span> (!waiting) &#123;</span><br><span class="line">      waiting = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !config.<span class="property">async</span>) &#123;</span><br><span class="line">        <span class="title function_">flushSchedulerQueue</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">nextTick</span>(flushSchedulerQueue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码里有个has集合，用于存放本次更新触发的watcher，避免了同一个watcher被触发两次，也算是节省了性能<br>nextTick大家应该都不陌生，这个api作用实际上就是把更新任务方法放到微任务去做，这样做的好处我们用代码说明吧<br>demo里触发了按钮的回调，修改了this.age正常来说，this.age修改后就应该调用render-watcher的更新回调来更新视图，然后触发watch钩子里的age监听修改name，重复操作再次更新视图<br>这样就导致了可能一次操作要重新调好几次update，而且更新视图是比较消耗性能的，其间包括了重新生成vnode，与oldVnode进行diff比较，updateChildren等一系列操作。</p>
<h4 id="如何让一个一次改动所带来watcher的执行共用一次更新操作呢？"><a href="#如何让一个一次改动所带来watcher的执行共用一次更新操作呢？" class="headerlink" title="如何让一个一次改动所带来watcher的执行共用一次更新操作呢？"></a>如何让一个一次改动所带来watcher的执行共用一次更新操作呢？</h4><p>nextTick起到了重大的作用，拿demo来讲，在age变化触发normal-watcher，queueWatcher方法后把这个任务方法放到微任务里，这样这个微任务不会立马执行，<br>主线程会继续执行，会触发age对应的render-watcher，但是此时waiting为true，render-watcher不会触发flushSchedulerQueue，但是此时render-watcher已经存在于执行队列里了<br>所以<br>看flushSchedulerQueue的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushSchedulerQueue</span> (<span class="params"></span>) &#123;</span><br><span class="line">  currentFlushTimestamp = <span class="title function_">getNow</span>();</span><br><span class="line">  flushing = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">var</span> watcher, id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sort queue before flush.</span></span><br><span class="line">  <span class="comment">// This ensures that:</span></span><br><span class="line">  <span class="comment">// 1. Components are updated from parent to child. (because parent is always</span></span><br><span class="line">  <span class="comment">//    created before the child)</span></span><br><span class="line">  <span class="comment">// 2. A component&#x27;s user watchers are run before its render watcher (because</span></span><br><span class="line">  <span class="comment">//    user watchers are created before the render watcher)</span></span><br><span class="line">  <span class="comment">// 3. If a component is destroyed during a parent component&#x27;s watcher run,</span></span><br><span class="line">  <span class="comment">//    its watchers can be skipped.</span></span><br><span class="line">  queue.<span class="title function_">sort</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123; <span class="keyword">return</span> a.<span class="property">id</span> - b.<span class="property">id</span>; &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// do not cache length because more watchers might be pushed</span></span><br><span class="line">  <span class="comment">// as we run existing watchers</span></span><br><span class="line">  <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; queue.<span class="property">length</span>; index++) &#123;</span><br><span class="line">    watcher = queue[index];</span><br><span class="line">    <span class="keyword">if</span> (watcher.<span class="property">before</span>) &#123;</span><br><span class="line">      watcher.<span class="title function_">before</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    id = watcher.<span class="property">id</span>;</span><br><span class="line">    has[id] = <span class="literal">null</span>;</span><br><span class="line">    watcher.<span class="title function_">run</span>();</span><br><span class="line">    <span class="comment">// in dev build, check and stop circular updates.</span></span><br><span class="line">    <span class="keyword">if</span> (has[id] != <span class="literal">null</span>) &#123;</span><br><span class="line">      circular[id] = (circular[id] || <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (circular[id] &gt; <span class="variable constant_">MAX_UPDATE_COUNT</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&#x27;You may have an infinite update loop &#x27;</span> + (</span><br><span class="line">            watcher.<span class="property">user</span></span><br><span class="line">              ? (<span class="string">&quot;in watcher with expression \&quot;&quot;</span> + (watcher.<span class="property">expression</span>) + <span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">              : <span class="string">&quot;in a component render function.&quot;</span></span><br><span class="line">          ),</span><br><span class="line">          watcher.<span class="property">vm</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// keep copies of post queues before resetting state</span></span><br><span class="line">  <span class="keyword">var</span> activatedQueue = activatedChildren.<span class="title function_">slice</span>();</span><br><span class="line">  <span class="keyword">var</span> updatedQueue = queue.<span class="title function_">slice</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resetSchedulerState</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// call component updated and activated hooks</span></span><br><span class="line">  <span class="title function_">callActivatedHooks</span>(activatedQueue);</span><br><span class="line">  <span class="title function_">callUpdatedHooks</span>(updatedQueue);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// devtool hook</span></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (devtools &amp;&amp; config.<span class="property">devtools</span>) &#123;</span><br><span class="line">    devtools.<span class="title function_">emit</span>(<span class="string">&#x27;flush&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一步就是直接遍历queue，触发watcher.run去执行watcher的回调函数<br>我们先看看watcher.run的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">run</span> () &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      value !== <span class="variable language_">this</span>.<span class="property">value</span> ||</span><br><span class="line">      <span class="comment">// Deep watchers and watchers on Object/Arrays should fire even</span></span><br><span class="line">      <span class="comment">// when the value is the same, because the value may</span></span><br><span class="line">      <span class="comment">// have mutated.</span></span><br><span class="line">      <span class="title function_">isObject</span>(value) ||</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// set new value</span></span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">value</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>, value, oldValue)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="title function_">handleError</span>(e, <span class="variable language_">this</span>.<span class="property">vm</span>, <span class="string">`callback for watcher &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.expression&#125;</span>&quot;`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分代码目的就是执行watcher的回调<br>对于render-watcher来说，this.get()执行的是组件的更新方法<br>对于normal-watcher来说，this.get()执行的是watcher的handler</p>
<p>按上述demo的执行顺序</p>
<ol>
<li>执行age对应的normal-watcher，执行了this.name +&#x3D; 1，此时又会触发name的setter，而name对应的Dep实例里只有render-watcher</li>
<li>但是此时age变化导致的render-watcher还没有触发，has集合里毅依然存在组件更新的回调，所以age对应的render-watcher不会被加到queue队列里</li>
<li>最后才会执行render-watcher一顿更新操作</li>
<li>queue里的watcher都执行完毕会重置has、waiting等属性，表示次轮更新结束</li>
</ol>
<p>讲到这儿，可能还是有点懵逼吧，看图<br><img src="https://s2.ax1x.com/2019/12/18/QHYzdA.md.jpg" alt="queueWatcher"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/12/18/Vue2-x-%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94Watcher%E7%AF%87%E8%AF%A6%E8%A7%A3/" data-id="cm54yagkv0000b3hgc1eddbtd" data-title="Vue2.x-数据响应Watcher篇详解" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Watcher%E7%AF%87/" rel="tag">Watcher篇</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Vue2-x之数据响应篇" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/16/Vue2-x%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E7%AF%87/" class="article-date">
  <time class="dt-published" datetime="2019-12-16T12:01:22.000Z" itemprop="datePublished">2019-12-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/16/Vue2-x%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E7%AF%87/">Vue2.x之数据响应篇</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>vue-next的推出吸引了大批用户的目光，网上也随之出现了很多介绍原理的篇幅，那是不是就意味着Vue2.x在3的版本出现后就会淡出人们的视野呢？<br>答案是否定的 Vue2.x还是有很多值得我们去学习的地方，本篇主讲Vue2.x版本是如何做数据响应视图的</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>提到Vue的响应原理就不得不说到三个重要人物 分别是Observer、Dep和Watcher<br>这三者各司其职，完成了Vue对于数据和视图的链接，通过观察者模式打通了数据驱动视图的桥梁</p>
<ol>
<li>Observer负责对Vue实例data、props、computed里的数据进行数据劫持</li>
<li>Watcher负责提供数据更新的回调</li>
<li>Dep则是Observer和Watcher的桥梁 会存放某个数据变化的订阅者 在被Observer劫持的数据变化时会去通知所有订阅的Watcher进行更新</li>
</ol>
<p>下面我们分别介绍这几个点以及他们所扮演的重要角色吧<br>以下的代码都是编译过的!!! 没有flow看的舒服一点~</p>
<h3 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h3><p>先看Observer的源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Observer</span> = <span class="keyword">function</span> <span class="title function_">Observer</span> (<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = value;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Dep</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">vmCount</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="title function_">def</span>(value, <span class="string">&#x27;__ob__&#x27;</span>, <span class="variable language_">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">      <span class="title function_">protoAugment</span>(value, arrayMethods);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">copyAugment</span>(value, arrayMethods, arrayKeys);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">observeArray</span>(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">walk</span>(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Observer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">walk</span> = <span class="keyword">function</span> <span class="title function_">walk</span> (<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">defineReactive$$1</span>(obj, keys[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Observer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">observeArray</span> = <span class="keyword">function</span> <span class="title function_">observeArray</span> (<span class="params">items</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = items.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="title function_">observe</span>(items[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defineReactive$$1</span> (<span class="params"></span></span><br><span class="line"><span class="params">  obj,</span></span><br><span class="line"><span class="params">  key,</span></span><br><span class="line"><span class="params">  val,</span></span><br><span class="line"><span class="params">  customSetter,</span></span><br><span class="line"><span class="params">  shallow</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> property = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, key);</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.<span class="property">configurable</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cater for pre-defined getter/setters</span></span><br><span class="line">  <span class="keyword">var</span> getter = property &amp;&amp; property.<span class="property">get</span>;</span><br><span class="line">  <span class="keyword">var</span> setter = property &amp;&amp; property.<span class="property">set</span>;</span><br><span class="line">  <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">    val = obj[key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(val);</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        dep.<span class="title function_">depend</span>();</span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.<span class="property">dep</span>.<span class="title function_">depend</span>();</span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">            <span class="title function_">dependArray</span>(value);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (<span class="params">newVal</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val;</span><br><span class="line">      <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (customSetter) &#123;</span><br><span class="line">        <span class="title function_">customSetter</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">      <span class="keyword">if</span> (getter &amp;&amp; !setter) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.<span class="title function_">call</span>(obj, newVal);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal;</span><br><span class="line">      &#125;</span><br><span class="line">      childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(newVal);</span><br><span class="line">      dep.<span class="title function_">notify</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Observe.js的代码很简单<br>首先是个构造函数，主要作用是对一个对象或者数组递归的通过Object.defineProperty进行处理<br>有一点值得注意的是，由于Object.defineProperty无法通过setter检测到push等方法导致数组的变化<br>Vue巧妙的在Array.prototype前面加了个拦截器 下面是拦截器的内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arrayProto = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">  <span class="keyword">var</span> arrayMethods = <span class="title class_">Object</span>.<span class="title function_">create</span>(arrayProto);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> methodsToPatch = [</span><br><span class="line">    <span class="string">&#x27;push&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pop&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;shift&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;unshift&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;splice&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sort&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;reverse&#x27;</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Intercept mutating methods and emit events</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  methodsToPatch.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">method</span>) &#123;</span><br><span class="line">    <span class="comment">// cache original method</span></span><br><span class="line">    <span class="keyword">var</span> original = arrayProto[method];</span><br><span class="line">    <span class="title function_">def</span>(arrayMethods, method, <span class="keyword">function</span> <span class="title function_">mutator</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> args = [], len = <span class="variable language_">arguments</span>.<span class="property">length</span>;</span><br><span class="line">      <span class="keyword">while</span> ( len-- ) args[ len ] = <span class="variable language_">arguments</span>[ len ];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> result = original.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">      <span class="keyword">var</span> ob = <span class="variable language_">this</span>.<span class="property">__ob__</span>;</span><br><span class="line">      <span class="keyword">var</span> inserted;</span><br><span class="line">      <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;push&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;unshift&#x27;</span>:</span><br><span class="line">          inserted = args;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;splice&#x27;</span>:</span><br><span class="line">          inserted = args.<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (inserted) &#123; ob.<span class="title function_">observeArray</span>(inserted); &#125;</span><br><span class="line">      <span class="comment">// notify change</span></span><br><span class="line">      ob.<span class="property">dep</span>.<span class="title function_">notify</span>();</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">def</span> (<span class="params">obj, key, val, enumerable</span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">      <span class="attr">value</span>: val,</span><br><span class="line">      <span class="attr">enumerable</span>: !!enumerable,</span><br><span class="line">      <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码不难看出 Vue在Array.prototype上用Object.defineProperty加了一层拦截 被劫持的数组只要调用methodsToPatch里的方法就会触发defineProperty的value方法<br>在保持数组原操作的同时也能获取到变化的内容并调用ob.dep.notify进行更新通知</p>
<h3 id="依赖中心-Dep"><a href="#依赖中心-Dep" class="headerlink" title="依赖中心(Dep)"></a>依赖中心(Dep)</h3><p>上面讲了Vue里面针对data、props、computed的数据劫持 那我们怎么知道什么这些数据变化要通知谁呢，这就要引出我们的中间角色Dep<br>看看Dep的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> uid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A dep is an observable that can have multiple</span></span><br><span class="line"><span class="comment"> * directives subscribing to it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Dep</span> = <span class="keyword">function</span> <span class="title function_">Dep</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">id</span> = uid++;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subs</span> = [];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">addSub</span> = <span class="keyword">function</span> <span class="title function_">addSub</span> (<span class="params">sub</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">removeSub</span> = <span class="keyword">function</span> <span class="title function_">removeSub</span> (<span class="params">sub</span>) &#123;</span><br><span class="line">  <span class="title function_">remove</span>(<span class="variable language_">this</span>.<span class="property">subs</span>, sub);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">depend</span> = <span class="keyword">function</span> <span class="title function_">depend</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">notify</span> = <span class="keyword">function</span> <span class="title function_">notify</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// stabilize the subscriber list first</span></span><br><span class="line">  <span class="keyword">var</span> subs = <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">slice</span>();</span><br><span class="line">  <span class="keyword">if</span> (!config.<span class="property">async</span>) &#123;</span><br><span class="line">    <span class="comment">// subs aren&#x27;t sorted in scheduler if not running async</span></span><br><span class="line">    <span class="comment">// we need to sort them now to make sure they fire in correct</span></span><br><span class="line">    <span class="comment">// order</span></span><br><span class="line">    subs.<span class="title function_">sort</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123; <span class="keyword">return</span> a.<span class="property">id</span> - b.<span class="property">id</span>; &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = subs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    subs[i].<span class="title function_">update</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The current target watcher being evaluated.</span></span><br><span class="line"><span class="comment">// This is globally unique because only one watcher</span></span><br><span class="line"><span class="comment">// can be evaluated at a time.</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> targetStack = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pushTarget</span> (<span class="params">target</span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">push</span>(target);</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">popTarget</span> (<span class="params"></span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">pop</span>();</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = targetStack[targetStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dep的代码也相当精简，内部就存储了id和subs(订阅者队列，相关的watcher)<br>它的原型上有几个方法</p>
<ol>
<li>addSub: 添加watcher</li>
<li>removeSub: 移除watcher</li>
<li>depend: 后面讲</li>
<li>notify: 遍历subs数组 通知每个watcher进行update</li>
</ol>
<p>Dep的重点是最后的Dep.target 这个在defineReactive时也有用到 如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">      dep.<span class="title function_">depend</span>()</span><br><span class="line">      <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">        childOb.<span class="property">dep</span>.<span class="title function_">depend</span>()</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">          <span class="title function_">dependArray</span>(value)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Dep.target的作用是在这里还看不出来 我们往下watcher就会明白了</p>
<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>现在有了(观察者)数据劫持和依赖收集，那自然少不了订阅者啦，Watcher核心代码如下<br>精简版代码如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Watcher</span> = <span class="keyword">function</span> <span class="title function_">Watcher</span> (<span class="params"></span></span><br><span class="line"><span class="params">  vm,</span></span><br><span class="line"><span class="params">  expOrFn,</span></span><br><span class="line"><span class="params">  cb,</span></span><br><span class="line"><span class="params">  options,</span></span><br><span class="line"><span class="params">  isRenderWatcher</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">vm</span> = vm;</span><br><span class="line">  <span class="keyword">if</span> (isRenderWatcher) &#123;</span><br><span class="line">    vm.<span class="property">_watcher</span> = <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  vm.<span class="property">_watchers</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="comment">// options</span></span><br><span class="line">  <span class="keyword">if</span> (options) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deep</span> = !!options.<span class="property">deep</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">user</span> = !!options.<span class="property">user</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lazy</span> = !!options.<span class="property">lazy</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sync</span> = !!options.<span class="property">sync</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">before</span> = options.<span class="property">before</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deep</span> = <span class="variable language_">this</span>.<span class="property">user</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> = <span class="variable language_">this</span>.<span class="property">sync</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">cb</span> = cb;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">id</span> = ++uid$2; <span class="comment">// uid for batching</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="variable language_">this</span>.<span class="property">lazy</span>; <span class="comment">// for lazy watchers</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">deps</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDeps</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="keyword">new</span> <span class="title function_">_Set</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">newDepIds</span> = <span class="keyword">new</span> <span class="title function_">_Set</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">expression</span> = expOrFn.<span class="title function_">toString</span>();</span><br><span class="line">  <span class="comment">// parse expression for getter</span></span><br><span class="line">  <span class="comment">// render-watcher</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">getter</span> = expOrFn;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 在组件内使用watch监听</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">getter</span> = <span class="title function_">parsePath</span>(expOrFn);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">getter</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = noop;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&quot;Failed watching path: \&quot;&quot;</span> + expOrFn + <span class="string">&quot;\&quot; &quot;</span> +</span><br><span class="line">        <span class="string">&#x27;Watcher only accepts simple dot-delimited paths. &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;For full control, use a function instead.&#x27;</span>,</span><br><span class="line">        vm</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">lazy</span></span><br><span class="line">    ? <span class="literal">undefined</span></span><br><span class="line">    : <span class="variable language_">this</span>.<span class="title function_">get</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上是Watcher的构造函数 重点关注expOrFn和isRenderWatcher这两个参数<br>先介绍一下Watcher是个啥吧<br>有三种Watcher</p>
<ol>
<li>computed-watcher: 定义在钩子computed，每个计算属性都会通过initComputed生成一个watcher</li>
<li>normal-watcher: 在钩子watch里定义的，每个watch都会通过initWatch调用vm.$watch生成一个watcher</li>
<li>render-watcher: 组件在调用$mount时会实例化一个组件级别的watcher 用于组件内部的更新</li>
</ol>
<p>当然执行顺序也是 computed-watcher -&gt; normal-watcher -&gt; render-watcher 这样能保证每次更新时computed的属性是及时的<br>看到构造函数最后执行了this.get() 这个方法就是依赖收集的关键 我们会从上面三种watcher的角度分别阐述<br>先看get代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Watcher</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">get</span> = <span class="keyword">function</span> <span class="title function_">get</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">pushTarget</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="keyword">var</span> value;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="variable language_">this</span>.<span class="property">vm</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    value = <span class="variable language_">this</span>.<span class="property">getter</span>.<span class="title function_">call</span>(vm, vm);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">      <span class="title function_">handleError</span>(e, vm, (<span class="string">&quot;getter for watcher \&quot;&quot;</span> + (<span class="variable language_">this</span>.<span class="property">expression</span>) + <span class="string">&quot;\&quot;&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// &quot;touch&quot; every property so they are all tracked as</span></span><br><span class="line">    <span class="comment">// dependencies for deep watching</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">deep</span>) &#123;</span><br><span class="line">      <span class="title function_">traverse</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">popTarget</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cleanupDeps</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>看到pushTarget和popTarget是不是很眼熟，这不就是Dep里提供的两个方法嘛<br>这两个方法的作用就是形成一个闭包 value &#x3D; this.getter.call(vm, vm)<br>这一步会触发被劫持数据的get钩子 此时Dep.target就是当前的watcher实例<br>所有触发getter的对象都会触发dep.depend() 如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">depend</span> () &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进而触发当前watcher的addDep方法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addDep</span> (dep) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = dep.<span class="property">id</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">add</span>(id)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="title function_">push</span>(dep)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">depIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">      dep.<span class="title function_">addSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后在调用dep.addSub将数据依赖到的watcher收集到dep.subs里了，等该数据的setter被触发后再调用dep.notify()通知所有订阅者要更新视图啦</p>
<p>实际上在一个vue组件初始化的过程中会有以下几个操作 这里只讲本篇用到的hah</p>
<h5 id="初始化computed-通过initComputed给每个计算属性生成对应的Watcher"><a href="#初始化computed-通过initComputed给每个计算属性生成对应的Watcher" class="headerlink" title="初始化computed 通过initComputed给每个计算属性生成对应的Watcher"></a>初始化computed 通过initComputed给每个计算属性生成对应的Watcher</h5><blockquote>
<ol>
<li>此时expOrFn作为参数传进来是个function 并且isRenderWatcher为false 在构造函数会直接赋值给this.getter 在需要用到的时候会调用get方法获取到value</li>
<li>但是这类Watcher有个特点：当计算属性依赖于其他数据时，属性并不会立即重新计算，只有之后其他地方需要读取属性的时候，它才会真正计算，即具备lazy（懒计算）特性</li>
<li>实际上，在组件初始化的过程中，会把computed的watcher存在vm._computedWatchers里，真正用到的时候才会将依赖存进dep 详情代码请看defineComputed</li>
</ol>
</blockquote>
<h5 id="如果钩子函数watch存在监听-会调用initWatch-createWactehr-vm-watch对每个监听创建对应的watcher"><a href="#如果钩子函数watch存在监听-会调用initWatch-createWactehr-vm-watch对每个监听创建对应的watcher" class="headerlink" title="如果钩子函数watch存在监听 会调用initWatch -&gt; createWactehr -&gt; vm.$watch对每个监听创建对应的watcher"></a>如果钩子函数watch存在监听 会调用initWatch -&gt; createWactehr -&gt; vm.$watch对每个监听创建对应的watcher</h5><blockquote>
<ol>
<li>此时expOrFn是string类型 会执行this.getter &#x3D; parsePath(expOrFn) parsePath代码如下 这个方法的目的就是通过watch的名字循环的触发数据的getter达到依赖收集的作用</li>
<li>其他逻辑和computed一致</li>
</ol>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parsePath</span> (<span class="params">path: string</span>): any &#123;</span><br><span class="line">  <span class="keyword">if</span> (bailRE.<span class="title function_">test</span>(path)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> segments = path.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; segments.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!obj) <span class="keyword">return</span></span><br><span class="line">      obj = obj[segments[i]]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="组件在真正渲染之前会调用-mount-该步骤的目的是生成vnode-并且给每个组件生成一个render-watcher作为内部更新的方法-代码如下"><a href="#组件在真正渲染之前会调用-mount-该步骤的目的是生成vnode-并且给每个组件生成一个render-watcher作为内部更新的方法-代码如下" class="headerlink" title="组件在真正渲染之前会调用$mount 该步骤的目的是生成vnode 并且给每个组件生成一个render-watcher作为内部更新的方法 代码如下:"></a>组件在真正渲染之前会调用$mount 该步骤的目的是生成vnode 并且给每个组件生成一个render-watcher作为内部更新的方法 代码如下:</h5><blockquote>
<ol>
<li>此时expOrFn是一个函数updateComponent 如下</li>
<li>updateComponent负责组件的编译 编译过程中替换模板内的变量是也会触发变量的getter，从而达到收集依赖的作用，这里牵扯到compile部分，不多讲 抽时间单独介绍</li>
<li>其他逻辑与上面一致</li>
</ol>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountComponent</span> (<span class="params"></span></span><br><span class="line"><span class="params">    vm,</span></span><br><span class="line"><span class="params">    el,</span></span><br><span class="line"><span class="params">    hydrating</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    vm.<span class="property">$el</span> = el;</span><br><span class="line">    <span class="keyword">if</span> (!vm.<span class="property">$options</span>.<span class="property">render</span>) &#123;</span><br><span class="line">      vm.<span class="property">$options</span>.<span class="property">render</span> = createEmptyVNode;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">        <span class="keyword">if</span> ((vm.<span class="property">$options</span>.<span class="property">template</span> &amp;&amp; vm.<span class="property">$options</span>.<span class="property">template</span>.<span class="title function_">charAt</span>(<span class="number">0</span>) !== <span class="string">&#x27;#&#x27;</span>) ||</span><br><span class="line">          vm.<span class="property">$options</span>.<span class="property">el</span> || el) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">&#x27;You are using the runtime-only build of Vue where the template &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;compiler is not available. Either pre-compile the templates into &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;render functions, or use the compiler-included build.&#x27;</span>,</span><br><span class="line">            vm</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">&#x27;Failed to mount component: template or render function not defined.&#x27;</span>,</span><br><span class="line">            vm</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeMount&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> updateComponent;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">      updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = vm.<span class="property">_name</span>;</span><br><span class="line">        <span class="keyword">var</span> id = vm.<span class="property">_uid</span>;</span><br><span class="line">        <span class="keyword">var</span> startTag = <span class="string">&quot;vue-perf-start:&quot;</span> + id;</span><br><span class="line">        <span class="keyword">var</span> endTag = <span class="string">&quot;vue-perf-end:&quot;</span> + id;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">mark</span>(startTag);</span><br><span class="line">        <span class="keyword">var</span> vnode = vm.<span class="title function_">_render</span>();</span><br><span class="line">        <span class="title function_">mark</span>(endTag);</span><br><span class="line">        <span class="title function_">measure</span>((<span class="string">&quot;vue &quot;</span> + name + <span class="string">&quot; render&quot;</span>), startTag, endTag);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">mark</span>(startTag);</span><br><span class="line">        vm.<span class="title function_">_update</span>(vnode, hydrating);</span><br><span class="line">        <span class="title function_">mark</span>(endTag);</span><br><span class="line">        <span class="title function_">measure</span>((<span class="string">&quot;vue &quot;</span> + name + <span class="string">&quot; patch&quot;</span>), startTag, endTag);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we set this to vm._watcher inside the watcher&#x27;s constructor</span></span><br><span class="line">    <span class="comment">// since the watcher&#x27;s initial patch may call $forceUpdate (e.g. inside child</span></span><br><span class="line">    <span class="comment">// component&#x27;s mounted hook), which relies on vm._watcher being already defined</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, &#123;</span><br><span class="line">      <span class="attr">before</span>: <span class="keyword">function</span> <span class="title function_">before</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">          <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>);</span><br><span class="line">    hydrating = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// manually mounted instance, call mounted on self</span></span><br><span class="line">    <span class="comment">// mounted is called for render-created child components in its inserted hook</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$vnode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">      vm.<span class="property">_isMounted</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="title function_">callHook</span>(vm, <span class="string">&#x27;mounted&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vm</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="最后上一张图-帮助理解"><a href="#最后上一张图-帮助理解" class="headerlink" title="最后上一张图 帮助理解"></a>最后上一张图 帮助理解</h3><p><img src="https://esymeptoo.github.io/images/dep.jpeg" alt="reactive"></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://juejin.im/post/5df5d78151882512701d6a6c#heading-18">Vue 数据响应式原理</a></p>
<h3 id="其他链接"><a href="#其他链接" class="headerlink" title="其他链接"></a>其他链接</h3><p>看了数据响应这块的你 也可以看看Vue2.x关于patch的解读哦</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://esymeptoo.github.io/2019/07/03/vue-patch/">vue-patch</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/12/16/Vue2-x%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E7%AF%87/" data-id="cm54yagkz0003b3hgfibfaaw6" data-title="Vue2.x之数据响应篇" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue2-x%E3%80%81Observer%E3%80%81Dep%E3%80%81Watcher%E3%80%81%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" rel="tag">vue2.x、Observer、Dep、Watcher、个人笔记</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-next-js初探" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/25/next-js%E5%88%9D%E6%8E%A2/" class="article-date">
  <time class="dt-published" datetime="2019-11-25T07:38:35.000Z" itemprop="datePublished">2019-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/25/next-js%E5%88%9D%E6%8E%A2/">next.js从入门到重新入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="服务器端渲染-SSR"><a href="#服务器端渲染-SSR" class="headerlink" title="服务器端渲染-SSR"></a>服务器端渲染-SSR</h4><p>服务端渲染（SSR: Server Side Rendering）,用户请求服务器，服务器上直接生成 HTML 内容并返回给浏览器。服务器端渲染来，页面的内容是由 Server 端生成的。一般来说，服务器端渲染的页面交互能力有限，如果要实现复杂交互，还是要通过引入 JavaScript 文件来辅助实现。服务器端渲染这个概念，适用于任何后端语言。。</p>
<h4 id="为什么要使用SSR技术"><a href="#为什么要使用SSR技术" class="headerlink" title="为什么要使用SSR技术"></a>为什么要使用SSR技术</h4><p>CSR 项目的 SEO 能力极弱，在搜索引擎中基本上不可能有好的排名。因为目前大多数搜索引擎主要识别的内容还是 HTML，对 JavaScript 文件内容的识别都还比较弱。如果一个项目的流量入口来自于搜索引擎，这个时候你使用 CSR 进行开发，就非常不合适了</p>
<p>SSR 的产生，主要就是为了解决上面所说的问题。在 React 中使用 SSR 技术，我们让 React 代码在服务器端先执行一次，使得用户下载的 HTML 已经包含了所有的页面展示内容，这样，页面展示的过程只需要经历一个 HTTP 请求周期，TTFP 时间得到一倍以上的缩减。</p>
<p>同时，由于 HTML 中已经包含了网页的所有内容，所以网页的 SEO 效果也会变的非常好。之后，我们让 React 代码在客户端再次执行，为 HTML 网页中的内容添加数据及事件的绑定，页面就具备了 React 的各种交互能力。</p>
<h4 id="来张图先"><a href="#来张图先" class="headerlink" title="来张图先"></a>来张图先</h4><p><img src="https://raw.githubusercontent.com/esymeptoo/next-demo/master/assets/next-detail.png" alt="next"></p>
<h4 id="安装next-js"><a href="#安装next-js" class="headerlink" title="安装next.js"></a>安装next.js</h4><ol>
<li>yarn add next react react-dom</li>
<li>在package.json-scripts添加            <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;next&quot;</span>,</span><br><span class="line">  <span class="string">&quot;build&quot;</span>: <span class="string">&quot;next build&quot;</span>,</span><br><span class="line">  <span class="string">&quot;start&quot;</span>: <span class="string">&quot;next start&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><ul>
<li>pages</li>
<li>public</li>
<li>node_modules</li>
<li>.next</li>
<li>next.config.js</li>
<li>server.js</li>
<li>package.json</li>
</ul>
<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><ol>
<li>Next.js没有路由配置文件 是通过node文件系统的读取到的路径作为页面的路由 在pages下新增index.js 启动项目就能在localhost:3000下面看到index页</li>
<li>使用next提供了Link组件和Router进行路由跳转 </li>
<li>withRouter</li>
</ol>
<h4 id="Dynamic-Routing"><a href="#Dynamic-Routing" class="headerlink" title="Dynamic Routing"></a>Dynamic Routing</h4><ol>
<li>使用query</li>
<li>不能真正支持params模式</li>
</ol>
<h4 id="meta配置"><a href="#meta配置" class="headerlink" title="meta配置"></a>meta配置</h4><p>nuxt.js将页面的head集中到了nuxt.config.js配置文件 next提供了Head组件用于配置页面的meta</p>
<h4 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h4><ol>
<li>Built-in CSS support:<style jsx></li>
<li>CSS-in-JS</li>
<li>importing css&#x2F;Sass&#x2F;Less&#x2F;Stylus files</li>
</ol>
<h4 id="Custom-Api"><a href="#Custom-Api" class="headerlink" title="Custom-Api"></a>Custom-Api</h4><p>pages下的文件目录除了注册页面路由以外 还可以在pages下面新建api文件夹 *.js文件的路径即为请求路径</p>
<h4 id="Custom-Server"><a href="#Custom-Server" class="headerlink" title="Custom-Server"></a>Custom-Server</h4><p>项目根目录新建server.js</p>
<h4 id="next-config-js"><a href="#next-config-js" class="headerlink" title="next.config.js"></a>next.config.js</h4><p>设置一些webpack的配置或者next的配置</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/25/next-js%E5%88%9D%E6%8E%A2/" data-id="cm54yagl4000pb3hgfzpd087y" data-title="next.js从入门到重新入门" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React%E3%80%81SSR/" rel="tag">React、SSR</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-浅析webpack异步模块导入原理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/09/24/%E6%B5%85%E6%9E%90webpack%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%9D%97%E5%AF%BC%E5%85%A5%E5%8E%9F%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2019-09-24T09:11:11.000Z" itemprop="datePublished">2019-09-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/09/24/%E6%B5%85%E6%9E%90webpack%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%9D%97%E5%AF%BC%E5%85%A5%E5%8E%9F%E7%90%86/">浅析webpack异步模块导入原理</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h4><p>随着项目越来越大，性能问题已经成为了困扰业务发展的重要因素。<br>功能不停地累加后，核心页面已经不堪重负，访问速度愈来愈慢。<br>业务发展、用户体验都非常迫切的需要释放页面的负载，提高页面加载速度。</p>
<h4 id="目前几种主流异步加载的方式"><a href="#目前几种主流异步加载的方式" class="headerlink" title="目前几种主流异步加载的方式"></a>目前几种主流异步加载的方式</h4><blockquote>
<p>Webpack2:</p>
</blockquote>
<ol>
<li>require.ensure(dependencies, callback, chunName) 已废弃但保留 链接<blockquote>
<p>ES提案:</p>
</blockquote>
</li>
<li>() &#x3D;&gt; import()<blockquote>
<p>Vue:</p>
</blockquote>
</li>
<li>component: resolve &#x3D;&gt; require(‘xxx.&#x2F;vue’, resolve)<blockquote>
<p>React:</p>
</blockquote>
</li>
<li>react-loadable</li>
</ol>
<h4 id="希望通过这篇文章能带来以下的帮助"><a href="#希望通过这篇文章能带来以下的帮助" class="headerlink" title="希望通过这篇文章能带来以下的帮助?"></a>希望通过这篇文章能带来以下的帮助?</h4><ol>
<li>webpack是如何将异步代码插入到页面上的</li>
<li>如何检测到异步代码已经查到页面上了?</li>
</ol>
<h4 id="有关webpack的code-Spliting"><a href="#有关webpack的code-Spliting" class="headerlink" title="有关webpack的code Spliting"></a>有关webpack的code Spliting</h4><p>本章主要是通过一个简单的异步加载的demo解读一下webpack打包后的代码是如何动态加载页面上的</p>
<blockquote>
<p>webpack配置相关代码我就不贴了<br>main.js如下:</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">asyncAddWrapper</span> = (<span class="params"></span>) =&gt; <span class="keyword">import</span>(<span class="string">&#x27;./add&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">default</span>: add &#125; = <span class="keyword">await</span> <span class="title function_">asyncAddWrapper</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">1</span>, <span class="number">0</span>))</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>打包入口文件就是一个简单的通过es提案import动态引入add.js的内容并且打印计算结果</p>
<blockquote>
<p>add.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">add</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add.js 默认暴露了一个两个数相加的函数</p>
<p>ok 我们运行打包命令 得到以下几个打包后的文件</p>
<ol>
<li>0.js</li>
<li>index.html</li>
<li>main.js</li>
</ol>
<p>用过异步组件的同学都知道 像这种0.js&#x2F;1.js之类的文件都是我们的异步代码 只在需要的时候引入到页面上 从而达到减少首屏资源引入的效果<br>我们看看打包后的main.js是怎么样的 打包后的代码比较难看 我选了重要的片段</p>
<blockquote>
<p>main.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params">modules</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">webpackJsonpCallback</span>(<span class="params">data</span>) &#123;</span><br><span class="line">   		<span class="keyword">var</span> chunkIds = data[<span class="number">0</span>];</span><br><span class="line">   		<span class="keyword">var</span> moreModules = data[<span class="number">1</span>];</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">   		<span class="comment">// add &quot;moreModules&quot; to the modules object,</span></span><br><span class="line">   		<span class="comment">// then flag all &quot;chunkIds&quot; as loaded and fire callback</span></span><br><span class="line">   		<span class="keyword">var</span> moduleId, chunkId, i = <span class="number">0</span>, resolves = [];</span><br><span class="line">   		<span class="keyword">for</span>(;i &lt; chunkIds.<span class="property">length</span>; i++) &#123;</span><br><span class="line">   			chunkId = chunkIds[i];</span><br><span class="line">   			<span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(installedChunks, chunkId) &amp;&amp; installedChunks[chunkId]) &#123;</span><br><span class="line">   				resolves.<span class="title function_">push</span>(installedChunks[chunkId][<span class="number">0</span>]); <span class="comment">// installedChunks[chunkId][0] 为 resolve</span></span><br><span class="line">   			&#125;</span><br><span class="line">   			installedChunks[chunkId] = <span class="number">0</span>;  <span class="comment">// 设置为已加载</span></span><br><span class="line">   		&#125;</span><br><span class="line">   		<span class="keyword">for</span>(moduleId <span class="keyword">in</span> moreModules) &#123;</span><br><span class="line">   			<span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(moreModules, moduleId)) &#123;</span><br><span class="line">   				modules[moduleId] = moreModules[moduleId];</span><br><span class="line">   			&#125;</span><br><span class="line">   		&#125;</span><br><span class="line">   		<span class="keyword">if</span>(parentJsonpFunction) <span class="title function_">parentJsonpFunction</span>(data); <span class="comment">// 将data push到window[webpackJsonp]里</span></span><br><span class="line">  </span><br><span class="line">   		<span class="keyword">while</span>(resolves.<span class="property">length</span>) &#123;</span><br><span class="line">   			resolves.<span class="title function_">shift</span>()();   <span class="comment">// 挨个执行resolve</span></span><br><span class="line">   		&#125;</span><br><span class="line">  </span><br><span class="line">   	&#125;</span><br><span class="line">   	 	<span class="comment">// The module cache</span></span><br><span class="line">     	<span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// object to store loaded and loading chunks</span></span><br><span class="line">     	<span class="comment">// undefined = chunk not loaded, null = chunk preloaded/prefetched</span></span><br><span class="line">     	<span class="comment">// Promise = chunk loading, 0 = chunk loaded</span></span><br><span class="line">     	<span class="keyword">var</span> installedChunks = &#123;</span><br><span class="line">     		<span class="string">&quot;index&quot;</span>: <span class="number">0</span></span><br><span class="line">     	&#125;;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// script path function</span></span><br><span class="line">     	<span class="keyword">function</span> <span class="title function_">jsonpScriptSrc</span>(<span class="params">chunkId</span>) &#123;</span><br><span class="line">     		<span class="keyword">return</span> __webpack_require__.<span class="property">p</span> + <span class="string">&quot;&quot;</span> + (&#123;&#125;[chunkId]||chunkId) + <span class="string">&quot;.js&quot;</span></span><br><span class="line">     	&#125;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// The require function</span></span><br><span class="line">     	<span class="keyword">function</span> <span class="title function_">__webpack_require__</span>(<span class="params">moduleId</span>) &#123;</span><br><span class="line">    </span><br><span class="line">     		<span class="comment">// Check if module is in cache</span></span><br><span class="line">     		<span class="keyword">if</span>(installedModules[moduleId]) &#123;</span><br><span class="line">     			<span class="keyword">return</span> installedModules[moduleId].<span class="property">exports</span>;</span><br><span class="line">     		&#125;</span><br><span class="line">     		<span class="comment">// Create a new module (and put it into the cache)</span></span><br><span class="line">     		<span class="keyword">var</span> <span class="variable language_">module</span> = installedModules[moduleId] = &#123;</span><br><span class="line">     			<span class="attr">i</span>: moduleId,</span><br><span class="line">     			<span class="attr">l</span>: <span class="literal">false</span>,</span><br><span class="line">     			<span class="attr">exports</span>: &#123;&#125;</span><br><span class="line">     		&#125;;</span><br><span class="line">    </span><br><span class="line">     		<span class="comment">// Execute the module function</span></span><br><span class="line">     		modules[moduleId].<span class="title function_">call</span>(<span class="variable language_">module</span>.<span class="property">exports</span>, <span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>, __webpack_require__);</span><br><span class="line">    </span><br><span class="line">     		<span class="comment">// Flag the module as loaded</span></span><br><span class="line">     		<span class="variable language_">module</span>.<span class="property">l</span> = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">     		<span class="comment">// Return the exports of the module</span></span><br><span class="line">     		<span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">     	&#125;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// This file contains only the entry chunk.</span></span><br><span class="line">     	<span class="comment">// The chunk loading function for additional chunks</span></span><br><span class="line">     	__webpack_require__.<span class="property">e</span> = <span class="keyword">function</span> <span class="title function_">requireEnsure</span>(<span class="params">chunkId</span>) &#123;</span><br><span class="line">     		<span class="keyword">var</span> promises = [];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">     		<span class="comment">// JSONP chunk loading for javascript</span></span><br><span class="line">    </span><br><span class="line">     		<span class="keyword">var</span> installedChunkData = installedChunks[chunkId];</span><br><span class="line">     		<span class="keyword">if</span>(installedChunkData !== <span class="number">0</span>) &#123; <span class="comment">// 0 means &quot;already installed&quot;.</span></span><br><span class="line">    </span><br><span class="line">     			<span class="comment">// a Promise means &quot;currently loading&quot;.</span></span><br><span class="line">     			<span class="keyword">if</span>(installedChunkData) &#123;</span><br><span class="line">     				promises.<span class="title function_">push</span>(installedChunkData[<span class="number">2</span>]);</span><br><span class="line">     			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     				<span class="comment">// setup Promise in chunk cache</span></span><br><span class="line">     				<span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">     					installedChunkData = installedChunks[chunkId] = [resolve, reject];</span><br><span class="line">     				&#125;);</span><br><span class="line">     				promises.<span class="title function_">push</span>(installedChunkData[<span class="number">2</span>] = promise); <span class="comment">// installedChunkData = [resolve, reject, promise]</span></span><br><span class="line">    </span><br><span class="line">     				<span class="comment">// start chunk loading</span></span><br><span class="line">     				<span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">     				<span class="keyword">var</span> onScriptComplete;</span><br><span class="line">    </span><br><span class="line">     				script.<span class="property">charset</span> = <span class="string">&#x27;utf-8&#x27;</span>;</span><br><span class="line">     				script.<span class="property">timeout</span> = <span class="number">120</span>;</span><br><span class="line">     				<span class="keyword">if</span> (__webpack_require__.<span class="property">nc</span>) &#123;</span><br><span class="line">     					script.<span class="title function_">setAttribute</span>(<span class="string">&quot;nonce&quot;</span>, __webpack_require__.<span class="property">nc</span>);</span><br><span class="line">     				&#125;</span><br><span class="line">     				script.<span class="property">src</span> = <span class="title function_">jsonpScriptSrc</span>(chunkId);</span><br><span class="line">    </span><br><span class="line">     				<span class="comment">// create error before stack unwound to get useful stacktrace later</span></span><br><span class="line">     				<span class="keyword">var</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>();</span><br><span class="line">     				onScriptComplete = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">     					<span class="comment">// avoid mem leaks in IE.</span></span><br><span class="line">     					script.<span class="property">onerror</span> = script.<span class="property">onload</span> = <span class="literal">null</span>;</span><br><span class="line">     					<span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">     					<span class="keyword">var</span> chunk = installedChunks[chunkId];</span><br><span class="line">     					<span class="keyword">if</span>(chunk !== <span class="number">0</span>) &#123;</span><br><span class="line">     						<span class="keyword">if</span>(chunk) &#123;</span><br><span class="line">     							<span class="keyword">var</span> errorType = event &amp;&amp; (event.<span class="property">type</span> === <span class="string">&#x27;load&#x27;</span> ? <span class="string">&#x27;missing&#x27;</span> : event.<span class="property">type</span>);</span><br><span class="line">     							<span class="keyword">var</span> realSrc = event &amp;&amp; event.<span class="property">target</span> &amp;&amp; event.<span class="property">target</span>.<span class="property">src</span>;</span><br><span class="line">     							error.<span class="property">message</span> = <span class="string">&#x27;Loading chunk &#x27;</span> + chunkId + <span class="string">&#x27; failed.\n(&#x27;</span> + errorType + <span class="string">&#x27;: &#x27;</span> + realSrc + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">     							error.<span class="property">name</span> = <span class="string">&#x27;ChunkLoadError&#x27;</span>;</span><br><span class="line">     							error.<span class="property">type</span> = errorType;</span><br><span class="line">     							error.<span class="property">request</span> = realSrc;</span><br><span class="line">     							chunk[<span class="number">1</span>](error);</span><br><span class="line">     						&#125;</span><br><span class="line">     						installedChunks[chunkId] = <span class="literal">undefined</span>;</span><br><span class="line">     					&#125;</span><br><span class="line">     				&#125;;</span><br><span class="line">     				<span class="keyword">var</span> timeout = <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">     					<span class="title function_">onScriptComplete</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;timeout&#x27;</span>, <span class="attr">target</span>: script &#125;);</span><br><span class="line">     				&#125;, <span class="number">120000</span>);</span><br><span class="line">     				script.<span class="property">onerror</span> = script.<span class="property">onload</span> = onScriptComplete;</span><br><span class="line">     				<span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">     			&#125;</span><br><span class="line">     		&#125;</span><br><span class="line">     		<span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line">     	&#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// expose the modules object (__webpack_modules__)</span></span><br><span class="line">     	__webpack_require__.<span class="property">m</span> = modules;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// expose the module cache</span></span><br><span class="line">     	__webpack_require__.<span class="property">c</span> = installedModules;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// define getter function for harmony exports</span></span><br><span class="line">     	__webpack_require__.<span class="property">d</span> = <span class="keyword">function</span>(<span class="params"><span class="built_in">exports</span>, name, getter</span>) &#123;</span><br><span class="line">     		<span class="keyword">if</span>(!__webpack_require__.<span class="title function_">o</span>(<span class="built_in">exports</span>, name)) &#123;</span><br><span class="line">     			<span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, name, &#123; <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">get</span>: getter &#125;);</span><br><span class="line">     		&#125;</span><br><span class="line">     	&#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// define __esModule on exports</span></span><br><span class="line">     	__webpack_require__.<span class="property">r</span> = <span class="keyword">function</span>(<span class="params"><span class="built_in">exports</span></span>) &#123;</span><br><span class="line">     		<span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title class_">Symbol</span>.<span class="property">toStringTag</span>) &#123;</span><br><span class="line">     			<span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, <span class="title class_">Symbol</span>.<span class="property">toStringTag</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;Module&#x27;</span> &#125;);</span><br><span class="line">     		&#125;</span><br><span class="line">     		<span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, <span class="string">&#x27;__esModule&#x27;</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">     	&#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// create a fake namespace object</span></span><br><span class="line">     	<span class="comment">// mode &amp; 1: value is a module id, require it</span></span><br><span class="line">     	<span class="comment">// mode &amp; 2: merge all properties of value into the ns</span></span><br><span class="line">     	<span class="comment">// mode &amp; 4: return value when already ns object</span></span><br><span class="line">     	<span class="comment">// mode &amp; 8|1: behave like require</span></span><br><span class="line">     	__webpack_require__.<span class="property">t</span> = <span class="keyword">function</span>(<span class="params">value, mode</span>) &#123;</span><br><span class="line">     		<span class="keyword">if</span>(mode &amp; <span class="number">1</span>) value = <span class="title function_">__webpack_require__</span>(value);</span><br><span class="line">     		<span class="keyword">if</span>(mode &amp; <span class="number">8</span>) <span class="keyword">return</span> value;</span><br><span class="line">     		<span class="keyword">if</span>((mode &amp; <span class="number">4</span>) &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> &amp;&amp; value &amp;&amp; value.<span class="property">__esModule</span>) <span class="keyword">return</span> value;</span><br><span class="line">     		<span class="keyword">var</span> ns = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">     		__webpack_require__.<span class="title function_">r</span>(ns);</span><br><span class="line">     		<span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(ns, <span class="string">&#x27;default&#x27;</span>, &#123; <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">value</span>: value &#125;);</span><br><span class="line">     		<span class="keyword">if</span>(mode &amp; <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> value != <span class="string">&#x27;string&#x27;</span>) <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> value) __webpack_require__.<span class="title function_">d</span>(ns, key, <span class="keyword">function</span>(<span class="params">key</span>) &#123; <span class="keyword">return</span> value[key]; &#125;.<span class="title function_">bind</span>(<span class="literal">null</span>, key));</span><br><span class="line">     		<span class="keyword">return</span> ns;</span><br><span class="line">     	&#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// getDefaultExport function for compatibility with non-harmony modules</span></span><br><span class="line">     	__webpack_require__.<span class="property">n</span> = <span class="keyword">function</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">     		<span class="keyword">var</span> getter = <span class="variable language_">module</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">__esModule</span> ?</span><br><span class="line">     			<span class="keyword">function</span> <span class="title function_">getDefault</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="variable language_">module</span>[<span class="string">&#x27;default&#x27;</span>]; &#125; :</span><br><span class="line">     			<span class="keyword">function</span> <span class="title function_">getModuleExports</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="variable language_">module</span>; &#125;;</span><br><span class="line">     		__webpack_require__.<span class="title function_">d</span>(getter, <span class="string">&#x27;a&#x27;</span>, getter);</span><br><span class="line">     		<span class="keyword">return</span> getter;</span><br><span class="line">     	&#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// Object.prototype.hasOwnProperty.call</span></span><br><span class="line">     	__webpack_require__.<span class="property">o</span> = <span class="keyword">function</span>(<span class="params">object, property</span>) &#123; <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(object, property); &#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// __webpack_public_path__</span></span><br><span class="line">     	__webpack_require__.<span class="property">p</span> = <span class="string">&quot;./&quot;</span>;</span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// on error function for async loading</span></span><br><span class="line">     	__webpack_require__.<span class="property">oe</span> = <span class="keyword">function</span>(<span class="params">err</span>) &#123; <span class="variable language_">console</span>.<span class="title function_">error</span>(err); <span class="keyword">throw</span> err; &#125;;</span><br><span class="line">    </span><br><span class="line">     	<span class="keyword">var</span> jsonpArray = <span class="variable language_">window</span>[<span class="string">&quot;webpackJsonp&quot;</span>] = <span class="variable language_">window</span>[<span class="string">&quot;webpackJsonp&quot;</span>] || [];</span><br><span class="line">     	<span class="keyword">var</span> oldJsonpFunction = jsonpArray.<span class="property">push</span>.<span class="title function_">bind</span>(jsonpArray);</span><br><span class="line">     	jsonpArray.<span class="property">push</span> = webpackJsonpCallback;</span><br><span class="line">     	jsonpArray = jsonpArray.<span class="title function_">slice</span>();</span><br><span class="line">     	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; jsonpArray.<span class="property">length</span>; i++) <span class="title function_">webpackJsonpCallback</span>(jsonpArray[i]);</span><br><span class="line">     	<span class="keyword">var</span> parentJsonpFunction = oldJsonpFunction;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">     	<span class="comment">// Load entry module and return exports</span></span><br><span class="line">     	<span class="keyword">return</span> <span class="title function_">__webpack_require__</span>(__webpack_require__.<span class="property">s</span> = <span class="string">&quot;./src/main.js&quot;</span>)</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">  <span class="string">&#x27;./src/main.js&#x27;</span>: (<span class="keyword">function</span> (<span class="params"><span class="variable language_">module</span>, <span class="built_in">exports</span>, __webpack_require__</span>) &#123;</span><br><span class="line">      (<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">asyncAddWrapper</span> = (<span class="params"></span>) =&gt; __webpack_require__.<span class="title function_">e</span>(<span class="comment">/*! import() */</span> <span class="number">0</span>).<span class="title function_">then</span>(__webpack_require__.<span class="title function_">bind</span>(<span class="literal">null</span>, <span class="comment">/*! ./add */</span> <span class="string">&quot;./src/add.js&quot;</span>))</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="attr">default</span>: add &#125; = <span class="keyword">await</span> <span class="title function_">asyncAddWrapper</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">1</span>, <span class="number">0</span>))</span><br><span class="line">      &#125;)()</span><br><span class="line">    &#125;)(),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>可以看到打包之后的main.js文件就是一个立即执行函数 入参modules是一个对象 key值是入口文件 value是打包之前main.js的内容<br>只不过import被webpack替换成了promise的形式<br>我们看一下立即执行函数的主函数做了什么事情吧<br>从上一路向下看 声明了一堆变量和方法 先不管 看到最下面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jsonpArray = <span class="variable language_">window</span>[<span class="string">&quot;webpackJsonp&quot;</span>] = <span class="variable language_">window</span>[<span class="string">&quot;webpackJsonp&quot;</span>] || [];</span><br><span class="line"><span class="keyword">var</span> oldJsonpFunction = jsonpArray.<span class="property">push</span>.<span class="title function_">bind</span>(jsonpArray);</span><br><span class="line">jsonpArray.<span class="property">push</span> = webpackJsonpCallback;</span><br><span class="line">jsonpArray = jsonpArray.<span class="title function_">slice</span>();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; jsonpArray.<span class="property">length</span>; i++) <span class="title function_">webpackJsonpCallback</span>(jsonpArray[i]);</span><br><span class="line"><span class="keyword">var</span> parentJsonpFunction = oldJsonpFunction;</span><br></pre></td></tr></table></figure>
<p>这段是比较重要的一段代码 首先<br>声明了一个jsonpArray(临时值)把window.webpackJsonp或者空数组赋值给他<br>然后然后把jsonpArray的push方法赋值给oldJsonpFunction 这个oldJsonpFunction.push此时还是原型上的push<br>然后将webpackJsonpCallback重载成jsonpArray的push 到这一步window.webpackJsonp.push执行的就是webpackJsonpCallback这个方法<br>这个webpackJsonpCallback方法在加载异代码的时候会用到<br>然后执行了jsonpArray &#x3D; jsonpArray.slice() 将jsonpArray的原型再次指向Array<br>最后将真正的window[“webpackJsonp”].push赋值给parentJsonpFunction</p>
<p>再看最后的执行代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_">__webpack_require__</span>(__webpack_require__.<span class="property">s</span> = <span class="string">&quot;./src/main.js&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这个代码是真正执行main.js的代码<br>我们先看看__webpack_require__是何方神圣</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The module cache</span></span><br><span class="line"><span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// object to store loaded and loading chunks</span></span><br><span class="line"><span class="comment">// undefined = chunk not loaded, null = chunk preloaded/prefetched</span></span><br><span class="line"><span class="comment">// Promise = chunk loading, 0 = chunk loaded</span></span><br><span class="line"><span class="keyword">var</span> installedChunks = &#123;</span><br><span class="line">  <span class="string">&quot;index&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// The require function</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">__webpack_require__</span>(<span class="params">moduleId</span>) &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Check if module is in cache</span></span><br><span class="line">	<span class="keyword">if</span>(installedModules[moduleId]) &#123;</span><br><span class="line">		<span class="keyword">return</span> installedModules[moduleId].<span class="property">exports</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Create a new module (and put it into the cache)</span></span><br><span class="line">	<span class="keyword">var</span> <span class="variable language_">module</span> = installedModules[moduleId] = &#123;</span><br><span class="line">		<span class="attr">i</span>: moduleId,</span><br><span class="line">		<span class="attr">l</span>: <span class="literal">false</span>,</span><br><span class="line">		<span class="attr">exports</span>: &#123;&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Execute the module function</span></span><br><span class="line">	modules[moduleId].<span class="title function_">call</span>(<span class="variable language_">module</span>.<span class="property">exports</span>, <span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>, __webpack_require__);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Flag the module as loaded</span></span><br><span class="line">	<span class="variable language_">module</span>.<span class="property">l</span> = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Return the exports of the module</span></span><br><span class="line">	<span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码生命了两个变量 installedModules和installedChunks<br>installedModules用于存放已经加载的主入口的模块<br>installedChunks用于存放已加载异步的模块 key表示当前引入异步模块的编号 也就是文件名 value表示引入的状态 0表示已经加载 如果是个数组表示正在加载</p>
<blockquote>
<p>我们看看__webpack_require__做了什么？<br>先判断了这个主模块是否已经加载过 如果加载过 就返回exports<br>如果是首次加载 将这个模块插入installedModules</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modules[moduleId].<span class="title function_">call</span>(<span class="variable language_">module</span>.<span class="property">exports</span>, <span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>, __webpack_require__)</span><br></pre></td></tr></table></figure>
<p>这一步调用了主模块的代码 并且传入了module&#x2F;module.exports&#x2F;__webpack_require__三个参数<br>ok 到这里估计还是一头雾水 我们再回到立即执行函数的参数modules里 看看执行了什么</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"><span class="variable language_">module</span>, <span class="built_in">exports</span>, __webpack_require__</span>) &#123;</span><br><span class="line">  (<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">asyncAddWrapper</span> = (<span class="params"></span>) =&gt; __webpack_require__.<span class="title function_">e</span>(<span class="comment">/*! import() */</span> <span class="number">0</span>).<span class="title function_">then</span>(__webpack_require__.<span class="title function_">bind</span>(<span class="literal">null</span>, <span class="comment">/*! ./add */</span> <span class="string">&quot;./src/add.js&quot;</span>))</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">default</span>: add &#125; = <span class="keyword">await</span> <span class="title function_">asyncAddWrapper</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">1</span>, <span class="number">0</span>))</span><br><span class="line">  &#125;)()</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>可以看到 import关键字已经被编译成了__webpack_require__.e(0).then(<strong>webpack_require</strong>.bind(null, ‘.&#x2F;src&#x2F;add.js’))</p>
<p>由此我们去找找__webpack_require__.e这个方法 如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">__webpack_require__.<span class="property">e</span> = <span class="keyword">function</span> <span class="title function_">requireEnsure</span>(<span class="params">chunkId</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> promises = [];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">// JSONP chunk loading for javascript</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">var</span> installedChunkData = installedChunks[chunkId];</span><br><span class="line">	<span class="keyword">if</span>(installedChunkData !== <span class="number">0</span>) &#123; <span class="comment">// 0 means &quot;already installed&quot;.</span></span><br><span class="line">    </span><br><span class="line">		<span class="comment">// a Promise means &quot;currently loading&quot;.</span></span><br><span class="line">		<span class="keyword">if</span>(installedChunkData) &#123;</span><br><span class="line">			promises.<span class="title function_">push</span>(installedChunkData[<span class="number">2</span>]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// setup Promise in chunk cache</span></span><br><span class="line">			<span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">				installedChunkData = installedChunks[chunkId] = [resolve, reject];</span><br><span class="line">			&#125;);</span><br><span class="line">			promises.<span class="title function_">push</span>(installedChunkData[<span class="number">2</span>] = promise); <span class="comment">// installedChunkData = [resolve, reject, promise]</span></span><br><span class="line">    </span><br><span class="line">			<span class="comment">// start chunk loading</span></span><br><span class="line">			<span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">			<span class="keyword">var</span> onScriptComplete;</span><br><span class="line">    </span><br><span class="line">			script.<span class="property">charset</span> = <span class="string">&#x27;utf-8&#x27;</span>;</span><br><span class="line">			script.<span class="property">timeout</span> = <span class="number">120</span>;</span><br><span class="line">			<span class="keyword">if</span> (__webpack_require__.<span class="property">nc</span>) &#123;</span><br><span class="line">				script.<span class="title function_">setAttribute</span>(<span class="string">&quot;nonce&quot;</span>, __webpack_require__.<span class="property">nc</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			script.<span class="property">src</span> = <span class="title function_">jsonpScriptSrc</span>(chunkId);</span><br><span class="line">    </span><br><span class="line">			<span class="comment">// create error before stack unwound to get useful stacktrace later</span></span><br><span class="line">			<span class="keyword">var</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>();</span><br><span class="line">			onScriptComplete = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">				<span class="comment">// avoid mem leaks in IE.</span></span><br><span class="line">				script.<span class="property">onerror</span> = script.<span class="property">onload</span> = <span class="literal">null</span>;</span><br><span class="line">				<span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">				<span class="keyword">var</span> chunk = installedChunks[chunkId];</span><br><span class="line">				<span class="keyword">if</span>(chunk !== <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span>(chunk) &#123;</span><br><span class="line">						<span class="keyword">var</span> errorType = event &amp;&amp; (event.<span class="property">type</span> === <span class="string">&#x27;load&#x27;</span> ? <span class="string">&#x27;missing&#x27;</span> : event.<span class="property">type</span>);</span><br><span class="line">						<span class="keyword">var</span> realSrc = event &amp;&amp; event.<span class="property">target</span> &amp;&amp; event.<span class="property">target</span>.<span class="property">src</span>;</span><br><span class="line">						error.<span class="property">message</span> = <span class="string">&#x27;Loading chunk &#x27;</span> + chunkId + <span class="string">&#x27; failed.\n(&#x27;</span> + errorType + <span class="string">&#x27;: &#x27;</span> + realSrc + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">						error.<span class="property">name</span> = <span class="string">&#x27;ChunkLoadError&#x27;</span>;</span><br><span class="line">						error.<span class="property">type</span> = errorType;</span><br><span class="line">						error.<span class="property">request</span> = realSrc;</span><br><span class="line">						chunk[<span class="number">1</span>](error);</span><br><span class="line">					&#125;</span><br><span class="line">					installedChunks[chunkId] = <span class="literal">undefined</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="keyword">var</span> timeout = <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">				<span class="title function_">onScriptComplete</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;timeout&#x27;</span>, <span class="attr">target</span>: script &#125;);</span><br><span class="line">			&#125;, <span class="number">120000</span>);</span><br><span class="line">			script.<span class="property">onerror</span> = script.<span class="property">onload</span> = onScriptComplete;</span><br><span class="line">			<span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>入参chunkId代表的是异步模块的编号 这个方法主要是将插入的过程封装成promise数组<br>利用promise.all将异步引入的过程变成同步的方法<br>先通过installedChunks判断该异步模块是否是第一次被引入</p>
<ol>
<li>如果是第一次被引入<blockquote>
<p>1.1 如果是正在引入的状态 直接将该模块插入时的promise放进promises数组</p>
</blockquote>
<blockquote>
<p>2.2 如果还没引入过 声明一个promise 并将该promise的fulfilled、reject回调和promise本身赋值给installedChunks[chunkId] 并加入promises数组<br>然后通过插入script标签的形式插入到页面上</p>
</blockquote>
</li>
</ol>
<p>再回到这步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">asyncAddWrapper</span> = (<span class="params"></span>) =&gt; __webpack_require__.<span class="title function_">e</span>(<span class="comment">/*! import() */</span> <span class="number">0</span>).<span class="title function_">then</span>(__webpack_require__.<span class="title function_">bind</span>(<span class="literal">null</span>, <span class="comment">/*! ./add */</span> <span class="string">&quot;./src/add.js&quot;</span>))</span><br></pre></td></tr></table></figure>
<p><strong>webpack_require</strong>.e作用是将需要异步引入的模块通过promise封装成同步的形式插入到页面 我们看一下打包异步模块生成的代码 0.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="variable language_">window</span>.<span class="property">webpackJsonp</span> = <span class="variable language_">window</span>.<span class="property">webpackJsonp</span> || []).<span class="title function_">push</span>([<span class="number">0</span>], &#123;</span><br><span class="line">  <span class="string">&#x27;./src/add.js&#x27;</span>: (<span class="keyword">function</span> (<span class="params"><span class="variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) &#123;</span><br><span class="line">    <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">    __webpack_require__.<span class="title function_">r</span>(__webpack_exports__);</span><br><span class="line">    __webpack_require__.<span class="title function_">d</span>(__webpack_exports__, <span class="string">&quot;default&quot;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> add; &#125;);</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">add</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> a + b</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>上述讲到window.webpackJsonp.push方法被重写为webpackJsonpCallback 我们看一下这个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">webpackJsonpCallback</span>(<span class="params">data</span>) &#123;</span><br><span class="line"> 		<span class="keyword">var</span> chunkIds = data[<span class="number">0</span>];</span><br><span class="line"> 		<span class="keyword">var</span> moreModules = data[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 		<span class="comment">// add &quot;moreModules&quot; to the modules object,</span></span><br><span class="line"> 		<span class="comment">// then flag all &quot;chunkIds&quot; as loaded and fire callback</span></span><br><span class="line"> 		<span class="keyword">var</span> moduleId, chunkId, i = <span class="number">0</span>, resolves = [];</span><br><span class="line"> 		<span class="keyword">for</span>(;i &lt; chunkIds.<span class="property">length</span>; i++) &#123;</span><br><span class="line"> 			chunkId = chunkIds[i];</span><br><span class="line"> 			<span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(installedChunks, chunkId) &amp;&amp; installedChunks[chunkId]) &#123;</span><br><span class="line"> 				resolves.<span class="title function_">push</span>(installedChunks[chunkId][<span class="number">0</span>]); <span class="comment">// installedChunks[chunkId][0] 为 resolve</span></span><br><span class="line"> 			&#125;</span><br><span class="line"> 			installedChunks[chunkId] = <span class="number">0</span>;  <span class="comment">// 设置为已加载</span></span><br><span class="line"> 		&#125;</span><br><span class="line"> 		<span class="keyword">for</span>(moduleId <span class="keyword">in</span> moreModules) &#123;</span><br><span class="line"> 			<span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(moreModules, moduleId)) &#123;</span><br><span class="line"> 				modules[moduleId] = moreModules[moduleId];</span><br><span class="line"> 			&#125;</span><br><span class="line"> 		&#125;</span><br><span class="line"> 		<span class="keyword">if</span>(parentJsonpFunction) <span class="title function_">parentJsonpFunction</span>(data); <span class="comment">// 将data push到window[webpackJsonp]里</span></span><br><span class="line"></span><br><span class="line"> 		<span class="keyword">while</span>(resolves.<span class="property">length</span>) &#123;</span><br><span class="line"> 			resolves.<span class="title function_">shift</span>()();   <span class="comment">// 挨个执行resolve</span></span><br><span class="line"> 		&#125;</span><br><span class="line"></span><br><span class="line"> 	&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法接收的参数是一个二维数组 数组第一项是异步模块的编号集合 第二项是异步模块内容<br>异步代码被插入页面后 会自动执行webpackJsonpCallback方法</p>
<ol>
<li>遍历本次插入的异步模块列表 如果该chunkId在installedChunks中 并且installedChunks[chunkId]不为0 说明这个异步模块出于未加载状态<br>此时installedChunks[chunkId]的值为[resolve, reject, promise] 并将resolve插入resolves数组 最后通过while循环结束掉所有的promise 此时__webpack_require__.e执行完毕</li>
<li>遍历异步代码里的模块部分 放到modules做缓存 供热更新使用 parentJsonpFunction此时就是真正的window.webpackJsonp.push方法</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/09/24/%E6%B5%85%E6%9E%90webpack%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%9D%97%E5%AF%BC%E5%85%A5%E5%8E%9F%E7%90%86/" data-id="cm54yagl7001ab3hg3ffya4u2" data-title="浅析webpack异步模块导入原理" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-分享一次装机体验" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/13/%E5%88%86%E4%BA%AB%E4%B8%80%E6%AC%A1%E8%A3%85%E6%9C%BA%E4%BD%93%E9%AA%8C/" class="article-date">
  <time class="dt-published" datetime="2019-08-13T02:08:06.000Z" itemprop="datePublished">2019-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/08/13/%E5%88%86%E4%BA%AB%E4%B8%80%E6%AC%A1%E8%A3%85%E6%9C%BA%E4%BD%93%E9%AA%8C/">分享一次小白装机体验</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="准备材料"><a href="#准备材料" class="headerlink" title="准备材料"></a>准备材料</h4><p>这次是在京东diy装机选的各种配件 没想到还是采坑了哈哈<br>下单准备好以下材料：</p>
<ol>
<li>主板: 华硕z390p</li>
<li>CPU: i5 9600k(特意买了个可以超频的9代U)</li>
<li>显卡: 影驰GTX 1660ti(有钱可以整个玩家国度)</li>
<li>内存条: 金士顿16G内存条一根(或者换两根8G的)</li>
<li>SSD: 西部数据240G</li>
<li>机械硬盘: 西部数据1TB 绿盘(也可选择蓝盘 性能更好 但是绿盘声音较小)</li>
<li>散热器: 九州风神 大霜塔</li>
<li>电源: 安钛克500W(电源一定要根据各部件的功耗实际情况计算一下 往往是越大越好)</li>
<li>机箱: 爱国者</li>
<li>显示器、鼠标、键盘: 这个自便</li>
<li>启动U盘: 这个可以去微软官网下载mediaCreationTool.exe会自动帮你制作启动u盘 从官网下载可能比较慢 直接上迅雷</li>
</ol>
<p>如果只是启动的话 以上不是所有都是必须的 只需要主板+CPU+SSD+电源就能点亮啦</p>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>坑1: 选择主板的时候一定要查清楚购买的主板是否支持CPU 博主这次就遇到这个坑 算是得到教训了<br>一开始购买的是技嘉的主板 等配件都装好了 按下启动键的时候 主板和散热器以及显卡亮了一下就灭了 博主当时也是一头雾水 毕竟是装机小白<br>后来去主板的店铺评论下面发现有人说了这个主板不支持7代以上的U 于是为了配上楼主的9代U 毅然打上哈罗单车 去电脑城买了块华硕主板<br>回头再装就已经驾轻就熟了</p>
<p>坑2: 装线的坑 主板的线路错从复杂 新手装机一定要对着说明书按部就班的操作或者去搜索该主板的详细信息图<br>建议如果是大板的话先不要着急将主板固定 可以考虑先把内存和SSD、机械、CPU放置进插槽 然后可以先把边角的音频线、power SW和power正负极线插好<br>再用螺丝固定主板 最后再上显卡、散热器和电源线等 有些角落的小线如果在主板安置好后再操作 对新手来说很麻烦哈哈</p>
<p>坑3: 追求美感的装机者一般对走线都比较谨慎 对于后期的维护还是很有益处的</p>
<p>坑4: 总体来说新手装机难度一般 问题是装机一旦出了问题像博主这种小白就会很慌哈哈 幸好博主这次还算有惊无险 所以新手装机还是需要注意啊</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>一般来说 有过装机经验 往后装机的时候就会稳很多哈哈 甚至可以去研究一下超频的需求<br>博主这次装机花了5个小时 主板的问题真的是一次大失误 所以新手买配件的时候还是要看清楚哦 包括散热器的风扇接口数量在主板够不够等等一些细节问题<br>博主这次花了8k整 除了后买的主板有点超出预算 其他的都在接收范围内 鲁大师跑分轻松超30W(虽然这玩意儿水分很多哈哈)<br>最后 建议小白们尽量不要在淘宝买配件 在电脑城听说很多淘宝店收的都是官方翻修货 水很深哈哈 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/13/%E5%88%86%E4%BA%AB%E4%B8%80%E6%AC%A1%E8%A3%85%E6%9C%BA%E4%BD%93%E9%AA%8C/" data-id="cm54yagl5000qb3hg77iy9iar" data-title="分享一次小白装机体验" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-实践travis-ci" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/09/%E5%AE%9E%E8%B7%B5travis-ci/" class="article-date">
  <time class="dt-published" datetime="2019-08-09T09:12:11.000Z" itemprop="datePublished">2019-08-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/08/09/%E5%AE%9E%E8%B7%B5travis-ci/">实践travis-ci</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/09/%E5%AE%9E%E8%B7%B5travis-ci/" data-id="cm54yagl5000ub3hg1qa7awuj" data-title="实践travis-ci" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/React%E3%80%81SSR/" rel="tag">React、SSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue2-x%E3%80%81%E6%8C%87%E4%BB%A4%E3%80%81v-model/" rel="tag">Vue2.x、指令、v-model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Watcher%E7%AF%87/" rel="tag">Watcher篇</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker%E3%80%81node/" rel="tag">docker、node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab-ci/" rel="tag">gitlab-ci</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js%E3%80%81es6/" rel="tag">js、es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvvm/" rel="tag">mvvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs-%E9%94%81-%E5%B9%B6%E5%8F%91/" rel="tag">nodejs 锁 并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qiankun%E3%80%81micro-frontend/" rel="tag">qiankun、micro-frontend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" rel="tag">react ref 笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redux%E3%80%81react/" rel="tag">redux、react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redux%E3%80%81react-redux/" rel="tag">redux、react-redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue2-x%E3%80%81Observer%E3%80%81Dep%E3%80%81Watcher%E3%80%81%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" rel="tag">vue2.x、Observer、Dep、Watcher、个人笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuex%E3%80%81takeLatest/" rel="tag">vuex、takeLatest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue%E3%80%81lazyload/" rel="tag">vue、lazyload</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue%E3%80%81%E7%AC%94%E8%AE%B0/" rel="tag">vue、笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/React%E3%80%81SSR/" style="font-size: 10px;">React、SSR</a> <a href="/tags/Vue2-x%E3%80%81%E6%8C%87%E4%BB%A4%E3%80%81v-model/" style="font-size: 10px;">Vue2.x、指令、v-model</a> <a href="/tags/Watcher%E7%AF%87/" style="font-size: 10px;">Watcher篇</a> <a href="/tags/docker%E3%80%81node/" style="font-size: 20px;">docker、node</a> <a href="/tags/gitlab-ci/" style="font-size: 10px;">gitlab-ci</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/js%E3%80%81es6/" style="font-size: 10px;">js、es6</a> <a href="/tags/mvvm/" style="font-size: 10px;">mvvm</a> <a href="/tags/nodejs-%E9%94%81-%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">nodejs 锁 并发</a> <a href="/tags/qiankun%E3%80%81micro-frontend/" style="font-size: 10px;">qiankun、micro-frontend</a> <a href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">react ref 笔记</a> <a href="/tags/redux%E3%80%81react/" style="font-size: 10px;">redux、react</a> <a href="/tags/redux%E3%80%81react-redux/" style="font-size: 10px;">redux、react-redux</a> <a href="/tags/vue/" style="font-size: 10px;">vue</a> <a href="/tags/vue2-x%E3%80%81Observer%E3%80%81Dep%E3%80%81Watcher%E3%80%81%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">vue2.x、Observer、Dep、Watcher、个人笔记</a> <a href="/tags/vuex%E3%80%81takeLatest/" style="font-size: 10px;">vuex、takeLatest</a> <a href="/tags/vue%E3%80%81lazyload/" style="font-size: 10px;">vue、lazyload</a> <a href="/tags/vue%E3%80%81%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">vue、笔记</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/06/electron%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">Electron使用教程</a>
          </li>
        
          <li>
            <a href="/2020/12/18/%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81/">悲观锁/乐观锁</a>
          </li>
        
          <li>
            <a href="/2020/11/23/qiankun%E5%BE%AE%E5%89%8D%E7%AB%AF%E5%88%9D%E6%8E%A2/">qiankun微前端实践</a>
          </li>
        
          <li>
            <a href="/2019/12/19/Vue2-x%E4%B9%8Bv-model%E8%AF%A6%E8%A7%A3/">Vue2.x之v-model详解</a>
          </li>
        
          <li>
            <a href="/2019/12/18/Vue2-x-%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94Watcher%E7%AF%87%E8%AF%A6%E8%A7%A3/">Vue2.x-数据响应Watcher篇详解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 周小e丶<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>