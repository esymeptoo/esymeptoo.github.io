<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>å‘¨å°eä¸¶çš„åšå®¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="å‘¨å°eä¸¶çš„åšå®¢">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="å‘¨å°eä¸¶çš„åšå®¢">
<meta property="og:locale">
<meta property="article:author" content="å‘¨å°eä¸¶">
<meta property="article:tag" content="å‰ç«¯ã€å¹æ¯”">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="å‘¨å°eä¸¶çš„åšå®¢" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">å‘¨å°eä¸¶çš„åšå®¢</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">coding...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-ä½¿ç”¨gitlab-cié›†æˆå‰ç«¯é¡¹ç›®" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/26/%E4%BD%BF%E7%94%A8gitlab-ci%E9%9B%86%E6%88%90%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time class="dt-published" datetime="2019-07-26T03:13:16.000Z" itemprop="datePublished">2019-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/26/%E4%BD%BF%E7%94%A8gitlab-ci%E9%9B%86%E6%88%90%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/">ä½¿ç”¨gitlab-cié›†æˆå‰ç«¯é¡¹ç›®</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>è¿™å‡ å¤©æ­£å¥½æœ‰ç©ºï¼ˆåˆ’æ°´ï¼‰åœ¨ç ”ç©¶ciæ–¹é¢çš„ä¸€äº›åŸºç¡€çŸ¥è¯† ä¸»è¦æ˜¯å¯¹ç€å®˜æ–¹æ–‡æ¡£åšå‚è€ƒå¹¶åŠ ä»¥å®è·µ<br>å…ˆä»‹ç»ä¸€ä¸‹å°å¼Ÿå¯¹äºgitlab-ciçš„è®¤çŸ¥ï¼ˆå…è´£å£°æ˜ï¼‰</p>
<ol>
<li>å¼€å‘è€…é€šè¿‡é…ç½®gitlab-ci.ymlæ–‡ä»¶ åœ¨æ¯æ¬¡ä»£ç äº§ç”Ÿpushæˆ–è€…æœ‰æ–°çš„tagäº§ç”Ÿæ—¶è§¦å‘ciè„šæœ¬</li>
<li>gitlab-cié›†æˆæµç¨‹ç”±å¤šä¸ªjobç»„æˆï¼Œ æ¯ä¸ªjobè·‘åœ¨ä¸åŒçš„gitlab-runnerä¸­ï¼Œ ä¹Ÿå¯ä»¥å¤šä¸ªjobå½¢æˆä¾èµ–å…³ç³» è¿™ç‚¹å€’è·Ÿdockeræœ‰ç±»ä¼¼çš„åœ°æ–¹</li>
</ol>
<h4 id="æ€ä¹ˆç”¨"><a href="#æ€ä¹ˆç”¨" class="headerlink" title="æ€ä¹ˆç”¨"></a>æ€ä¹ˆç”¨</h4><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/ci/yaml/README.html#tags">å®˜æ–¹æ–‡æ¡£</a></p>
<p>æ–‡æ¡£è®²è§£çš„å¾ˆæ¸…æ¥š è¿™é‡Œä¸å¤šèµ˜è¿°äº† ä¸»è¦å°±æ˜¯å‡ ä¸ªå‚æ•°çš„ä½¿ç”¨ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://esymeptoo.github.io/images/gitlab-ci1.png" alt="gitlab-ci"></p>
<p>æœ¬æ¬¡æˆ‘ä»¬ä»¥å‰ç«¯é¡¹ç›®çš„è‡ªåŠ¨åŒ–ä¸ºä¾‹ï¼Œåšä¸€ä¸ªç®€è¦çš„ä»‹ç»<br>æˆ‘å¸çš„å‰ç«¯é¡¹ç›®æ„å»ºæ—¶ä¸»è¦æœ‰ä¸‰ä¸ªé˜¶æ®µ testã€buildã€deploy</p>
<ol>
<li>testé˜¶æ®µä¸»è¦è´Ÿè´£åšä¸€äº›å•å…ƒæµ‹è¯•ã€ä»£ç lintæ£€æŸ¥ç­‰</li>
<li>buildé˜¶æ®µè´Ÿè´£å°†ä»£ç æ‰“åŒ…å‘åˆ°CDN å¹¶æ ¹æ®æ‰“åŒ…æ–‡ä»¶ç”Ÿæˆé¡¹ç›®é…ç½®æ–‡ä»¶</li>
<li>deployé˜¶æ®µè´Ÿè´£ ä»ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä¸­è·å–æœ€æ–°çš„é™æ€èµ„æºåœ°å€ å¹¶ä¿å­˜åˆ°redisä¸­ ä»¥ä¾¿nodeæœåŠ¡å™¨å»è·å–æœ€è¿‘ä¸€æ¬¡çš„å‘ç‰ˆå†…å®¹</li>
</ol>
<p>å®é™…æƒ…å†µè¿œæ¯”è¿™äº›ä¸Šè¿°è¦å¤æ‚çš„å¤š ä½†æ˜¯æœ¬æ¬¡æˆ‘ä»¬è®²çš„æ˜¯gitlab-ciç”¨æ³• ä¸‹é¢æˆ‘ä¼šä¸¾ä¸ªdemo åŒ…æ•™ä¸åŒ…ä¼šå˜¿å˜¿ğŸ˜‹<br>å¦‚å›¾<br><img src="https://esymeptoo.github.io/images/gitlab-ci-pipeline.png" alt="gitlab-ci"></p>
<p>è¿™æ˜¯ä¸€ä¸ªå¸¸è§„é¡¹ç›®çš„ciæµç¨‹<br>å›¾ä¸­å°†ciåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ Testã€Buildã€Deploy æ¥ä¸‹æ¥æˆ‘ä¼šä¾æ®è¿™ä¸‰ä¸ªé˜¶æ®µå®è·µä¸€ä¸‹</p>
<p>æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åˆ›å»ºindex.js<br>ç›®æ ‡æ˜¯è¾¾åˆ°èƒ½é€šè¿‡ä¸åŒçš„åˆ†æ”¯å»æ„å»ºä¸åŒçš„ç¯å¢ƒå˜é‡ä»è€Œæ‰“å°å‡ºä¸åŒçš„envå<br>å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> env = process.<span class="property">env</span>.<span class="property">NODE_ENV</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;env&#125;</span>, è”¡å¾å¤`</span>)</span><br></pre></td></tr></table></figure>

<p>åœ¨package.json scriptsä¸­åŠ å…¥</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;export NODE_ENV=$CI_ENVIRONMENT_NAME &amp;&amp; node index.js&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å†æ–°å»º.gitlab-ci.ymlæ–‡ä»¶<br>å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">xxxx</span>    <span class="string">//</span> <span class="string">é€šå¸¸æ˜¯docker-nodeé•œåƒ</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">2B</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master@xxxx</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„job ä¼šåœ¨masteråˆ†æ”¯pushä»£ç åè§¦å‘npm run buildå‘½ä»¤<br>environmentçš„nameå‚æ•°å¯¹åº”package.jsonä¸­çš„$CI_ENVIRONMENT_NAMEå‚æ•°<br>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥é€šè¿‡ciæä¾›çš„æ¨¡æ¿åŠŸèƒ½æ¥è¾¾åˆ°ä¸åŒåˆ†æ”¯è§¦å‘ä¸åŒæ„å»ºå‚æ•°çš„ç›®çš„</p>
<p>å¦‚ä¸‹:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.build-template:</span> <span class="string">$build-template</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="string">script</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">2B</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">build-dev:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="string">*build-template</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">alpha</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dev@xxxx</span>  </span><br><span class="line">    </span><br><span class="line"><span class="attr">build-beta:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="string">*build-template</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">beta</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dev@xxxx</span>  </span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>gitlab-ciçš„ç”¨æ³•è‡ªç”±åº¦éå¸¸é«˜ è¿™ç§æŒç»­é›†æˆæ–¹æ¡ˆçš„å‡ºç°è®©å¼€å‘è€…åœ¨éƒ¨ç½²æ–¹é¢èŠ‚çœäº†å¾ˆå¤šæˆæœ¬ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/26/%E4%BD%BF%E7%94%A8gitlab-ci%E9%9B%86%E6%88%90%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" data-id="cm54yagl4000lb3hggfz88cpv" data-title="ä½¿ç”¨gitlab-cié›†æˆå‰ç«¯é¡¹ç›®" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab-ci/" rel="tag">gitlab-ci</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-æœ‰å…³vueä¸­keyçš„ä½¿ç”¨" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/05/%E6%9C%89%E5%85%B3vue%E4%B8%ADkey%E7%9A%84%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2019-07-05T08:04:15.000Z" itemprop="datePublished">2019-07-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/05/%E6%9C%89%E5%85%B3vue%E4%B8%ADkey%E7%9A%84%E4%BD%BF%E7%94%A8/">æœ‰å…³vueä¸­keyçš„ä½¿ç”¨</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="å…³äºkey"><a href="#å…³äºkey" class="headerlink" title="å…³äºkey"></a>å…³äºkey</h4><p>ä¸Šä¸€å¼ è®²äº†vueçš„patchè¿‡ç¨‹ æœ‰ä¸€ç‚¹è®²çš„è¿˜æ˜¯å¾ˆå«ç³Šçš„ å°±æ˜¯keyç›¸å…³çš„<br>æåˆ°keyè¿™æ¦‚å¿µ åœ¨vue1.0ä¸­å®ƒçš„å‰èº«å¥½åƒæ˜¯v-track ä½œç”¨ä¸ç”¨è¯´éƒ½çŸ¥é“ æ˜¯ä¸ºäº†ä¼˜åŒ–diffæ“ä½œ é‚£å®ƒåˆ°åº•æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„å‘¢<br>æˆ‘ä»¬å…ˆçœ‹çœ‹ä»£ç </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldKeyToIdx)) &#123; oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx); &#125;</span><br><span class="line">idxInOld = <span class="title function_">isDef</span>(newStartVnode.<span class="property">key</span>)</span><br><span class="line">  ? oldKeyToIdx[newStartVnode.<span class="property">key</span>]</span><br><span class="line">  : <span class="title function_">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">  <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  vnodeToMove = oldCh[idxInOld];</span><br><span class="line">  <span class="comment">// ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨æ•°ç»„ä¸‹æ ‡ä½œä¸ºkey è¿™é‡Œä¼šåˆ¤æ–­å‡ºä¸æ˜¯ç›¸åŒèŠ‚ç‚¹ å¹¶ä¸”ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">    <span class="title function_">patchVnode</span>(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">    oldCh[idxInOld] = <span class="literal">undefined</span>;</span><br><span class="line">    canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, vnodeToMove.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// same key but different element. treat as new element</span></span><br><span class="line">    <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">newStartVnode = newCh[++newStartIdx];        </span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç æ˜¯updateChildrenæ–¹æ³•é‡Œçš„ä¸€ä¸ªif-branch ä¸Šä¸€ç« èŠ‚æœ‰æåˆ°è¿™éƒ¨åˆ† æˆ‘å°±ä¸å¤šèµ˜è¿°äº†<br>è¿™æ®µä»£ç æ˜¯å¹²å˜›çš„å‘¢ å…ˆæ˜¯é€šè¿‡oldVnodeChildrenè®¡ç®—å‡ºè€çš„å­èŠ‚ç‚¹å¯¹åº”çš„key æ¯æ¬¡updateChildrenåªéœ€è¦è®¡ç®—ä¸€æ¬¡</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createKeyToOldIdx</span> (<span class="params">children, beginIdx, endIdx</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> i, key;</span><br><span class="line">  <span class="keyword">var</span> map = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (i = beginIdx; i &lt;= endIdx; ++i) &#123;</span><br><span class="line">    key = children[i].<span class="property">key</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(key)) &#123; map[key] = i; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æœ‰key å°±æŠŠè¿™ä¸ªkeyå½“åšmapé‡Œçš„keyå€¼ æŠŠè¿™ä¸ªèŠ‚ç‚¹æ‰€å¤„çš„index å½“åšvalue<br>æ¯”å¦‚ä¸€ç¾¤å­èŠ‚ç‚¹A, B, C, D keyåˆ†åˆ«æ˜¯â€™Aâ€™, â€˜Bâ€™, â€˜Câ€™, â€˜Dâ€™<br>ç”Ÿæˆçš„oldKeyToIdxå°±æ˜¯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">A</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">B</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">C</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">D</span>: <span class="number">3</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±ç®—è¿™äº›å­èŠ‚ç‚¹çš„é¡ºåºå˜äº† ä½†æ˜¯keyæ²¡å˜ å¾ˆå®¹æ˜“èƒ½æ‰¾åˆ°å®ƒåœ¨oldVnodesChildrenä¸­å¯¹åº”çš„èŠ‚ç‚¹ æ‰€ä»¥è¿™æ‰ä½œä¸ºæ€§èƒ½ä¼˜åŒ–çš„ä¸€ç§æ‰‹æ®µ</p>
<p>é‚£ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨æ•°ç»„ä¸‹æ ‡ä½œä¸ºä½œä¸ºkeyå‘¢<br>æˆ‘ä»¬çœ‹çœ‹ç”¨æ•°ç»„ä¸‹æ ‡ä½œä¸ºkeyçš„oldKeyToIdx</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="number">0</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">1</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="number">2</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="number">3</span>: <span class="number">3</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å¦‚æœå­èŠ‚ç‚¹é¡ºåºå‘ç”Ÿäº†å˜åŒ– æ¯”å¦‚å˜æˆäº†BADC æ­¤æ—¶Bçš„keyç”±1å˜æˆäº†0 å®é™…ä¸Šæˆ‘ä»¬åœ¨oldVnodesChildrenä¸­æ‰¾åˆ°çš„æ˜¯A<br>è¿™æ—¶å€™å¦‚æœAå’ŒBç»è¿‡sameVnodeåˆ¤æ–­ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ ä¼šè°ƒç”¨createElmåˆ›å»ºæ–°èŠ‚ç‚¹ é‚£æˆ‘ä»¬å²‚ä¸æ˜¯å¾—ä¸å¿å¤±å•¦ è¿™æ ·çš„keyå°±æ²¡æœ‰æ„ä¹‰äº†</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/05/%E6%9C%89%E5%85%B3vue%E4%B8%ADkey%E7%9A%84%E4%BD%BF%E7%94%A8/" data-id="cm54yagl60012b3hghejt5rnl" data-title="æœ‰å…³vueä¸­keyçš„ä½¿ç”¨" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-vue-patch" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/03/vue-patch/" class="article-date">
  <time class="dt-published" datetime="2019-07-03T06:53:02.000Z" itemprop="datePublished">2019-07-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/03/vue-patch/">vue-patch</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Virtual-Dom"><a href="#Virtual-Dom" class="headerlink" title="Virtual Dom"></a>Virtual Dom</h4><p>vue2.0ä»å¼•å…¥äº†Virtual domçš„æ¦‚å¿µä½œä¸ºä¼˜åŒ–domæ“ä½œçš„æ‰‹æ®µ, ä¸‹é¢æˆ‘ä»¬å°±è¯¦ç»†ä»‹ç»è¿™ç©æ„å„¿ã€‚<br>ä¸­æ‰€å‘¨çŸ¥ï¼Œ VNodeæ˜¯virtual domçš„ä¸»è¦è§’è‰²ï¼Œ å…ˆçœ‹çœ‹VNodeçš„ç»„æˆ</p>
<h3 id="VNode"><a href="#VNode" class="headerlink" title="VNode"></a>VNode</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;;</span><br><span class="line">  <span class="attr">text</span>: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">ns</span>: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="built_in">void</span>; <span class="comment">// rendered in this component&#x27;s scope</span></span><br><span class="line">  <span class="attr">key</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="built_in">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="built_in">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  <span class="attr">raw</span>: <span class="built_in">boolean</span>; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  <span class="attr">isStatic</span>: <span class="built_in">boolean</span>; <span class="comment">// hoisted static node</span></span><br><span class="line">  <span class="attr">isRootInsert</span>: <span class="built_in">boolean</span>; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  <span class="attr">isComment</span>: <span class="built_in">boolean</span>; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  <span class="attr">isCloned</span>: <span class="built_in">boolean</span>; <span class="comment">// is a cloned node?</span></span><br><span class="line">  <span class="attr">isOnce</span>: <span class="built_in">boolean</span>; <span class="comment">// is a v-once node?</span></span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="built_in">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="built_in">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span>; <span class="comment">// for SSR caching</span></span><br><span class="line">  <span class="attr">devtoolsMeta</span>: ?<span class="title class_">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?<span class="built_in">string</span>; <span class="comment">// functional scope id support</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">tag</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">data</span>?: <span class="title class_">VNodeData</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">children</span>?: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span></span><br><span class="line"><span class="params">    <span class="attr">text</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">elm</span>?: <span class="title class_">Node</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">context</span>?: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">componentOptions</span>?: <span class="title class_">VNodeComponentOptions</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">asyncFactory</span>?: <span class="title class_">Function</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DEPRECATED: alias for componentInstance for backwards compat.</span></span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  get <span class="title function_">child</span> (): <span class="title class_">Component</span> | <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">componentInstance</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ˜¯VNodeçš„ç»“æ„ è¿™æ¯”çœŸå®domå°‘äº†å¾ˆå¤šå±æ€§ æ‰€ä»¥åœ¨é€šè¿‡æ¯”å¯¹VDomçš„å˜åŒ–åœ¨æ˜ å°„åˆ°çœŸå®domçš„è¿‡ç¨‹ä¸­ä¼šèŠ‚çœå¾ˆå¤šæ€§èƒ½å¼€é”€</p>
<h4 id="Patchä¹‹å‰"><a href="#Patchä¹‹å‰" class="headerlink" title="Patchä¹‹å‰"></a>Patchä¹‹å‰</h4><p>æœ¬ç« ä¸»è¦è®²vueåœ¨æ•°æ®æ›´æ–°æ—¶æ˜¯æ€æ ·åŠæ—¶çš„é€šè¿‡å¯¹æ¯”æ–°æ—§virtual domæ˜ å°„åˆ°çœŸå®domçš„~<br>ä»æºç æ¥çœ‹ï¼Œ æœ‰ä¸‰ä¸ªç±»æä¸ºé‡è¦ Observerç±»ã€Depç±»å’ŒWatcherç±»<br>Observerå®ä¾‹è´Ÿè´£ç»™æ¯ä¸ªéœ€è¦watchçš„å¯¹è±¡æ·»åŠ getterå’Œsetter<br>Watcherå®ä¾‹åˆ™è´Ÿè´£åœ¨æ•°æ®å˜åŠ¨çš„æ—¶å€™å»æ”¶é›†ä¾èµ–ã€è§¦å‘patchç­‰æ“ä½œ<br>è€ŒDepå®ä¾‹åˆ™æ˜¯observerå’Œwatchçš„æ¡¥æ¢ åœ¨æ•°æ®å˜åŠ¨çš„æ—¶å€™é€šçŸ¥å¯¹åº”watcheræ‰§è¡Œæ›´æ–°æ“ä½œ</p>
<h4 id="é‚£ä¹ˆåœ¨æ•°æ®æ›´æ–°çš„è¿‡ç¨‹ä¸­éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"><a href="#é‚£ä¹ˆåœ¨æ•°æ®æ›´æ–°çš„è¿‡ç¨‹ä¸­éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="é‚£ä¹ˆåœ¨æ•°æ®æ›´æ–°çš„è¿‡ç¨‹ä¸­éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"></a>é‚£ä¹ˆåœ¨æ•°æ®æ›´æ–°çš„è¿‡ç¨‹ä¸­éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h4><p>observer.get -&gt; dep.notify -&gt; watcher.update -&gt; flushSchedulerQueue -&gt;<br>watcher.run -&gt; watch.get -&gt; updateComponent -&gt; _render -&gt; _update -&gt; patch<br>-&gt; patchVnode -&gt; updateChildren</p>
<p>æœ¬ç« ä¸»è¦ä»patchçš„è¿‡ç¨‹å¼€å§‹è®²</p>
<h4 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h4><p><img src="https://esymeptoo.github.io/images/diff.png" alt="diff"></p>
<p>patchçš„ä»£ç </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span> (<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode)) &#123; <span class="title function_">invokeDestroyHook</span>(oldVnode); &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isInitialPatch = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> insertedVnodeQueue = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">    <span class="comment">// empty mount (likely as component), create new root element</span></span><br><span class="line">    isInitialPatch = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">createElm</span>(vnode, insertedVnodeQueue);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>);</span><br><span class="line">    <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">      <span class="comment">// patch existing root node</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="literal">null</span>, <span class="literal">null</span>, removeOnly);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isRealElement) &#123;</span><br><span class="line">        <span class="comment">// mounting to a real element</span></span><br><span class="line">        <span class="comment">// check if this is server-rendered content and if we can perform</span></span><br><span class="line">        <span class="comment">// a successful hydration.</span></span><br><span class="line">        <span class="keyword">if</span> (oldVnode.<span class="property">nodeType</span> === <span class="number">1</span> &amp;&amp; oldVnode.<span class="title function_">hasAttribute</span>(<span class="variable constant_">SSR_ATTR</span>)) &#123;</span><br><span class="line">          oldVnode.<span class="title function_">removeAttribute</span>(<span class="variable constant_">SSR_ATTR</span>);</span><br><span class="line">          hydrating = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isTrue</span>(hydrating)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">hydrate</span>(oldVnode, vnode, insertedVnodeQueue)) &#123;</span><br><span class="line">            <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> oldVnode</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">&#x27;The client-side rendered virtual DOM tree is not matching &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;server-rendered content. This is likely caused by incorrect &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;HTML markup, for example nesting block-level elements inside &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;full client-side render.&#x27;</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// either not server-rendered, or hydration failed.</span></span><br><span class="line">        <span class="comment">// create an empty node and replace it</span></span><br><span class="line">        oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// replacing existing element</span></span><br><span class="line">      <span class="keyword">var</span> oldElm = oldVnode.<span class="property">elm</span>;</span><br><span class="line">      <span class="keyword">var</span> parentElm = nodeOps.<span class="title function_">parentNode</span>(oldElm);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// create new node</span></span><br><span class="line">      <span class="title function_">createElm</span>(</span><br><span class="line">        vnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        <span class="comment">// extremely rare edge case: do not insert if old element is in a</span></span><br><span class="line">        <span class="comment">// leaving transition. Only happens when combining transition +</span></span><br><span class="line">        <span class="comment">// keep-alive + HOCs. (#4590)</span></span><br><span class="line">        oldElm.<span class="property">_leaveCb</span> ? <span class="literal">null</span> : parentElm,</span><br><span class="line">        nodeOps.<span class="title function_">nextSibling</span>(oldElm)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="comment">// update parent placeholder node element, recursively</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">parent</span>)) &#123;</span><br><span class="line">        <span class="keyword">var</span> ancestor = vnode.<span class="property">parent</span>;</span><br><span class="line">        <span class="keyword">var</span> patchable = <span class="title function_">isPatchable</span>(vnode);</span><br><span class="line">        <span class="keyword">while</span> (ancestor) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cbs.<span class="property">destroy</span>.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">            cbs.<span class="property">destroy</span>[i](ancestor);</span><br><span class="line">          &#125;</span><br><span class="line">          ancestor.<span class="property">elm</span> = vnode.<span class="property">elm</span>;</span><br><span class="line">          <span class="keyword">if</span> (patchable) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i$1 = <span class="number">0</span>; i$1 &lt; cbs.<span class="property">create</span>.<span class="property">length</span>; ++i$1) &#123;</span><br><span class="line">              cbs.<span class="property">create</span>[i$1](emptyNode, ancestor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// #6513</span></span><br><span class="line">            <span class="comment">// invoke insert hooks that may have been merged by create hooks.</span></span><br><span class="line">            <span class="comment">// e.g. for directives that uses the &quot;inserted&quot; hook.</span></span><br><span class="line">            <span class="keyword">var</span> insert = ancestor.<span class="property">data</span>.<span class="property">hook</span>.<span class="property">insert</span>;</span><br><span class="line">            <span class="keyword">if</span> (insert.<span class="property">merged</span>) &#123;</span><br><span class="line">              <span class="comment">// start at index 1 to avoid re-invoking component mounted hook</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">var</span> i$2 = <span class="number">1</span>; i$2 &lt; insert.<span class="property">fns</span>.<span class="property">length</span>; i$2++) &#123;</span><br><span class="line">                insert.<span class="property">fns</span>[i$2]();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">registerRef</span>(ancestor);</span><br><span class="line">          &#125;</span><br><span class="line">          ancestor = ancestor.<span class="property">parent</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// destroy old node</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(parentElm)) &#123;</span><br><span class="line">        <span class="title function_">removeVnodes</span>(parentElm, [oldVnode], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">tag</span>)) &#123;</span><br><span class="line">        <span class="title function_">invokeDestroyHook</span>(oldVnode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch);</span><br><span class="line">  <span class="keyword">return</span> vnode.<span class="property">elm</span></span><br><span class="line">&#125;      </span><br></pre></td></tr></table></figure>

<ol>
<li>å¦‚æœvnodeä¸å­˜åœ¨å„¿oldVnodeå­˜åœ¨ é”€æ¯oldVnode</li>
<li>å¦‚æœoldVnodeä¸å­˜åœ¨è€Œvnodeå­˜åœ¨ åˆ™è°ƒç”¨createElmåˆ›å»ºæ–°çš„èŠ‚ç‚¹</li>
<li>å¦‚æœoldVnodeå­˜åœ¨<blockquote>
<ol>
<li>å¦‚æœoldVnodeä¸æ˜¯çœŸå®èŠ‚ç‚¹å¹¶ä¸”oldVnodeå’Œvnodeæ˜¯ç›¸åŒèŠ‚ç‚¹ åˆ™è°ƒç”¨patchVnodeè¿›è¡Œæ¯”è¾ƒ</li>
<li>å¦‚æœoldVnodeæ˜¯çœŸå®èŠ‚ç‚¹(è¯´æ˜æ˜¯ç»„ä»¶åˆå§‹åŒ–çš„è¿‡ç¨‹), è°ƒç”¨createElmåˆ›å»ºæ–°èŠ‚ç‚¹ å¹¶è°ƒç”¨removeVnodeså°†oldVnodeå¯¹åº”çš„è€èŠ‚ç‚¹ç§»é™¤</li>
</ol>
</blockquote>
</li>
</ol>
<h4 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchVnode</span> (<span class="params"></span></span><br><span class="line"><span class="params">  oldVnode,</span></span><br><span class="line"><span class="params">  vnode,</span></span><br><span class="line"><span class="params">  insertedVnodeQueue,</span></span><br><span class="line"><span class="params">  ownerArray,</span></span><br><span class="line"><span class="params">  index,</span></span><br><span class="line"><span class="params">  removeOnly</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldVnode === vnode) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">elm</span>) &amp;&amp; <span class="title function_">isDef</span>(ownerArray)) &#123;</span><br><span class="line">    <span class="comment">// clone reused vnode</span></span><br><span class="line">    vnode = ownerArray[index] = <span class="title function_">cloneVNode</span>(vnode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> elm = vnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTrue</span>(oldVnode.<span class="property">isAsyncPlaceholder</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">asyncFactory</span>.<span class="property">resolved</span>)) &#123;</span><br><span class="line">      <span class="title function_">hydrate</span>(oldVnode.<span class="property">elm</span>, vnode, insertedVnodeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode.<span class="property">isAsyncPlaceholder</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// reuse element for static trees.</span></span><br><span class="line">  <span class="comment">// note we only do this if the vnode is cloned -</span></span><br><span class="line">  <span class="comment">// if the new node is not cloned it means the render functions have been</span></span><br><span class="line">  <span class="comment">// reset by the hot-reload-api and we need to do a proper re-render.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTrue</span>(vnode.<span class="property">isStatic</span>) &amp;&amp;</span><br><span class="line">    <span class="title function_">isTrue</span>(oldVnode.<span class="property">isStatic</span>) &amp;&amp;</span><br><span class="line">    vnode.<span class="property">key</span> === oldVnode.<span class="property">key</span> &amp;&amp;</span><br><span class="line">    (<span class="title function_">isTrue</span>(vnode.<span class="property">isCloned</span>) || <span class="title function_">isTrue</span>(vnode.<span class="property">isOnce</span>))</span><br><span class="line">  ) &#123;</span><br><span class="line">    vnode.<span class="property">componentInstance</span> = oldVnode.<span class="property">componentInstance</span>;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> i;</span><br><span class="line">  <span class="keyword">var</span> data = vnode.<span class="property">data</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">prepatch</span>)) &#123;</span><br><span class="line">    <span class="title function_">i</span>(oldVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> oldCh = oldVnode.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">var</span> ch = vnode.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isPatchable</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.<span class="property">update</span>.<span class="property">length</span>; ++i) &#123; cbs.<span class="property">update</span>[i](oldVnode, vnode); &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">update</span>)) &#123; <span class="title function_">i</span>(oldVnode, vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh) &amp;&amp; <span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldCh !== ch) &#123; <span class="title function_">updateChildren</span>(elm, oldCh, ch, insertedVnodeQueue, removeOnly); &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="title function_">checkDuplicateKeys</span>(ch);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123; nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>); &#125;</span><br><span class="line">      <span class="title function_">addVnodes</span>(elm, <span class="literal">null</span>, ch, <span class="number">0</span>, ch.<span class="property">length</span> - <span class="number">1</span>, insertedVnodeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh)) &#123;</span><br><span class="line">      <span class="title function_">removeVnodes</span>(elm, oldCh, <span class="number">0</span>, oldCh.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123;</span><br><span class="line">      nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== vnode.<span class="property">text</span>) &#123;</span><br><span class="line">    nodeOps.<span class="title function_">setTextContent</span>(elm, vnode.<span class="property">text</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">postpatch</span>)) &#123; <span class="title function_">i</span>(oldVnode, vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>å¦‚æœoldVnodeå®Œå…¨ç­‰äºvnode return</li>
<li>å¦‚æœoldVnodeå’Œvnodeéƒ½æ˜¯é™æ€èŠ‚ç‚¹ï¼Œä¸”vnodeçš„keyç­‰äºoldVnodeçš„keyï¼Œä¸”vnodeæ˜¯å…‹éš†èŠ‚ç‚¹æˆ–è€…v-onceæ§åˆ¶çš„èŠ‚ç‚¹çš„æ—¶å€™ åªéœ€è¦æŠŠ<br>oldVnodeçš„componentInstanceå¤åˆ¶ç»™vnodeå³å¯</li>
<li>å¦‚æœvnodeä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹<blockquote>
<ol>
<li>å¦‚æœoldVnodeå­˜åœ¨childrenä¸”vnodeå­˜åœ¨children ä¸”ä¸¤ä¸ªchildren ä¸å®Œå…¨ç›¸ç­‰ æ‰§è¡ŒupdateChildren</li>
<li>å¦‚æœåªæœ‰vnodeå­˜åœ¨childrenå­èŠ‚ç‚¹ï¼Œ è°ƒç”¨addVnodesæ·»åŠ å­èŠ‚ç‚¹</li>
<li>å¦‚æœåªæœ‰oldVnodeå­˜åœ¨å­èŠ‚ç‚¹ï¼Œ è°ƒç”¨removeVnodesç§»é™¤è¿™äº›å­èŠ‚ç‚¹</li>
<li>å¦‚æœvnodeå’ŒoldVnodeéƒ½æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œä½†æ˜¯oldVnodeæ˜¯æ–‡æœ¬èŠ‚ç‚¹ åˆ™æŠŠoldVnodeå¯¹åº”çš„çœŸå®domçš„æ–‡æœ¬å†…å®¹æ¸…ç©º</li>
</ol>
</blockquote>
</li>
<li>å¦‚æœvnodeæ˜¯æ–‡æœ¬èŠ‚ç‚¹ä¸”æ–‡æœ¬å†…å®¹å’Œoldnodeçš„æ–‡æœ¬å†…å®¹ä¸ä¸€æ ·ï¼Œ åˆ™æŠŠvnodeçš„æ–‡æœ¬å†…å®¹èµ‹å€¼ç»™oldVnodeå¯¹åº”domèŠ‚ç‚¹çš„æ–‡æœ¬</li>
</ol>
<h4 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateChildren</span> (<span class="params">parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> oldStartIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> newStartIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> oldStartVnode = oldCh[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> oldEndVnode = oldCh[oldEndIdx];</span><br><span class="line">  <span class="keyword">var</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> newStartVnode = newCh[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> newEndVnode = newCh[newEndIdx];</span><br><span class="line">  <span class="keyword">var</span> oldKeyToIdx, idxInOld, vnodeToMove, refElm;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeOnly is a special flag used only by &lt;transition-group&gt;</span></span><br><span class="line">  <span class="comment">// to ensure removed elements stay in correct relative positions</span></span><br><span class="line">  <span class="comment">// during leaving transitions</span></span><br><span class="line">  <span class="keyword">var</span> canMove = !removeOnly;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="title function_">checkDuplicateKeys</span>(newCh);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldStartVnode)) &#123;</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]; <span class="comment">// Vnode has been moved left</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldEndVnode)) &#123;</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      newEndVnode = newCh[--newEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123; <span class="comment">// Vnode moved right</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);</span><br><span class="line">      canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldStartVnode.<span class="property">elm</span>, nodeOps.<span class="title function_">nextSibling</span>(oldEndVnode.<span class="property">elm</span>));</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">      newEndVnode = newCh[--newEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123; <span class="comment">// Vnode moved left</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">      canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldEndVnode.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldKeyToIdx)) &#123; oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx); &#125;</span><br><span class="line">      idxInOld = <span class="title function_">isDef</span>(newStartVnode.<span class="property">key</span>)</span><br><span class="line">        ? oldKeyToIdx[newStartVnode.<span class="property">key</span>]</span><br><span class="line">        : <span class="title function_">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">        <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vnodeToMove = oldCh[idxInOld];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">          <span class="title function_">patchVnode</span>(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">          oldCh[idxInOld] = <span class="literal">undefined</span>;</span><br><span class="line">          canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, vnodeToMove.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// same key but different element. treat as new element</span></span><br><span class="line">          <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">    refElm = <span class="title function_">isUndef</span>(newCh[newEndIdx + <span class="number">1</span>]) ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].<span class="property">elm</span>;</span><br><span class="line">    <span class="title function_">addVnodes</span>(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">    <span class="title function_">removeVnodes</span>(parentElm, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateChildrenæ–¹æ³•ä¸»è¦é€šè¿‡whileå¾ªç¯å»å¯¹æ¯”æ–°æ—§ä¸¤æ£µæ ‘çš„å­èŠ‚ç‚¹æ¥æ›´æ–°dom</p>
<ol>
<li>å¦‚æœoldStartVnodeä¸å­˜åœ¨ åˆ™å°†oldStartVnodeè®¾ç½®ä¸ºä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹ oldStartIdxä¹ŸæŒ‡å‘è¿™ä¸ªå­èŠ‚ç‚¹</li>
<li>å¦‚æœoldEndVnodeä¸å­˜åœ¨ oldEndVnodeæŒ‡å‘ä¸Šä¸€ä¸ªå­èŠ‚ç‚¹ oldEndIdxä¹ŸæŒ‡å‘è¿™ä¸ªå­èŠ‚ç‚¹</li>
<li>å¦‚æœoldStartVnodeå’ŒnewStartVnodeæ˜¯åŒä¸€ä¸ªå­èŠ‚ç‚¹ è°ƒç”¨patchVnode è¿›è¡Œæ¯”è¾ƒ å¹¶ä¸”å°†oldStartVnodeå’ŒnewStartVnodeè®¾ç½®ä¸ºä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹</li>
<li>å¦‚æœoldEndVnodeå’ŒnewEndVnodeæ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œ è°ƒç”¨patchVnodeè¿›è¡Œæ¯”å¯¹ï¼Œ åŒæ—¶å°†ä»–ä»¬è®¾ç½®ä¸ºä¸Šä¸€ä¸ªèŠ‚ç‚¹</li>
<li>å¦‚æœoldStartVnodeå’ŒnewEndVnodeæ˜¯åŒä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œ è°ƒç”¨patchVnodeè¿›è¡Œæ¯”å¯¹ å°†è¿™ä¸ªèŠ‚ç‚¹ç§»åˆ°oldEndVnodeä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹çš„å‰é¢ å¹¶å°†oldStartVnodeæŒ‡å‘ä¸‹ä¸€ä¸ª newEndVnodeæŒ‡å‘ä¸‹ä¸€ä¸ª</li>
<li>å¦‚æœoldEndVnodeå’ŒnewStartVnodeæ˜¯åŒä¸€ä¸ªå­èŠ‚ç‚¹ è°ƒç”¨patchVnodeè¿›è¡Œæ¯”å¯¹ å°†è¿™ä¸ªèŠ‚ç‚¹ç§»åˆ°oldStartVnodeå¯¹åº”èŠ‚ç‚¹çš„å‰é¢ å¹¶å°†oldEndVnodeæŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹ newStartVnodeæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li>
<li>å¦‚æœä»¥ä¸Šéƒ½ä¸æˆç«‹ æ ¹æ®newStartVnodeçš„keyå€¼åœ¨oldVnodeChildrenä¸­è¿›è¡ŒæŸ¥æ‰¾<blockquote>
<ol>
<li>å¦‚æœoldVnodeChildrenä¸­å­˜åœ¨keyå€¼ä¸€æ ·</li>
<li>å¦‚æœoldVnodeChildrenä¸­æ‰¾åˆ°çš„èŠ‚ç‚¹å’ŒnewStartVnodeæ˜¯ç›¸åŒèŠ‚ç‚¹ï¼Œè°ƒç”¨patchVnodeçš„æ¯”å¯¹å¹¶å°†ç›®æ ‡èŠ‚ç‚¹ç§»è‡³oldStartVnodeçš„å‰é¢</li>
<li>å¦‚æœä¸æ˜¯ç›¸åŒèŠ‚ç‚¹ åˆ™è°ƒç”¨createElmåˆ›å»ºæ–°çš„èŠ‚ç‚¹</li>
<li>å¦‚æœæ‰¾ä¸åˆ°å’ŒnewStartVnodeçš„keyå€¼ä¸€æ ·çš„èŠ‚ç‚¹ åˆ™è°ƒç”¨createElmåˆ›å»ºæ–°çš„èŠ‚ç‚¹</li>
</ol>
</blockquote>
</li>
</ol>
<p>è·³å‡ºwhileå¾ªç¯å è¿˜è¦é’ˆå¯¹oldStartIdxå’ŒoldEndIdxè¿›è¡Œæ“ä½œ</p>
<ol>
<li>å¦‚æœoldStartIdx å¤§äº oldEndIdx è¯´æ˜newVnodesChildrenæ²¡æœ‰éå†å®Œ æ‰§è¡ŒaddVnodes</li>
<li>å¦‚æœnewStartIdx &gt; newEndIdx è¯´æ˜oldVnodeChildrenæ²¡æœ‰éå†å®Œ æ‰§è¡ŒremoveVnodes</li>
</ol>
<p>ä»¥ä¸Šå°±æ˜¯æ•´ä¸ªpatchè¿‡ç¨‹ï¼Œ å°¤å…¶æ˜¯updateChildrençš„é€»è¾‘è¿˜æ˜¯å¾ˆç²¾å¦™çš„ é€šè¿‡ä¸æ–­ç¼©å‡ä¸¤æ¡è¾¹ç•Œçº¿å»åˆ¤æ–­æœ‰æ— ç›¸åŒèŠ‚ç‚¹ ä¸ç®¡æ˜¯ç©ºé—´å¤æ‚åº¦è¿˜æ˜¯æ—¶é—´å¤æ‚åº¦éƒ½å‡å°‘äº†å¾ˆå¤š</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/03/vue-patch/" data-id="cm54yagl10009b3hg8g7y0n7a" data-title="vue-patch" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ç®€å•å®ç°ä¸€ä¸ªmvvm" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/01/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmvvm/" class="article-date">
  <time class="dt-published" datetime="2019-07-01T09:09:55.000Z" itemprop="datePublished">2019-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/01/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmvvm/">ç®€å•å®ç°ä¸€ä¸ªmvvm</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="ä»€ä¹ˆæ˜¯MVVM"><a href="#ä»€ä¹ˆæ˜¯MVVM" class="headerlink" title="ä»€ä¹ˆæ˜¯MVVM"></a>ä»€ä¹ˆæ˜¯MVVM</h4><p>MVVMæ˜¯Model-View-ViewModelçš„ç®€å†™ã€‚å®ƒæœ¬è´¨ä¸Šå°±æ˜¯MVC çš„æ”¹è¿›ç‰ˆã€‚MVVM å°±æ˜¯å°†å…¶ä¸­çš„View çš„çŠ¶æ€å’Œè¡Œä¸ºæŠ½è±¡åŒ–ï¼Œè®©æˆ‘ä»¬å°†è§†å›¾ UI å’Œä¸šåŠ¡é€»è¾‘åˆ†å¼€ã€‚</p>
<h4 id="ä¸Šä»£ç "><a href="#ä¸Šä»£ç " class="headerlink" title="ä¸Šä»£ç "></a>ä¸Šä»£ç </h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">content</span>=<span class="string">&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h</span>&gt;</span>å§“å:<span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h</span>&gt;</span>å§“å:<span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h</span>&gt;</span>å¹´é¾„:<span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;age&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> target = <span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">class</span> <span class="title class_">Mvvm</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">options</span> = options</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> root = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(options.<span class="property">el</span>)</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="title function_">observer</span>(options.<span class="property">data</span>)</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// åˆå§‹åŒ–domæ ‘ ä¸»è¦æ˜¯å¡«å……ç»‘å®šçš„å€¼å’Œè§¦å‘å„ä¸ªå€¼çš„getter</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="title function_">compile</span>(root)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">observer</span>(<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(data).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span></span><br><span class="line"><span class="language-javascript">        data[<span class="string">&#x27;_&#x27;</span> + key] = data[key]</span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            data[<span class="string">&#x27;_&#x27;</span> + key] = newVal</span></span><br><span class="line"><span class="language-javascript">            dep.<span class="title function_">update</span>(newVal)</span></span><br><span class="line"><span class="language-javascript">          &#125;,</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">get</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            target &amp;&amp; dep.<span class="title function_">addSub</span>(target)</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> data[<span class="string">&#x27;_&#x27;</span> + key]</span></span><br><span class="line"><span class="language-javascript">          &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">compile</span>(<span class="params">root</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span>.<span class="title function_">call</span>(root.<span class="property">childNodes</span>, <span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯ä¸æ˜¯æœ€åº•å±‚èŠ‚ç‚¹ æ˜¯å°±æ‰§è¡Œ ä¸æ˜¯å°±é€’å½’ç»§ç»­æ‰¾</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!child.<span class="property">firstElementChild</span> &amp;&amp; <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span>.<span class="title function_">test</span>(child.<span class="property">innerHTML</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// æ‹¿åˆ°RegExpçš„å…¨å±€åªè¯»å±æ€§</span></span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> key = <span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="title function_">trim</span>()</span></span><br><span class="line"><span class="language-javascript">          child.<span class="property">innerHTML</span> = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">data</span>[key]</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// å°†è¯¥èŠ‚ç‚¹èµ‹çµ¦target</span></span></span><br><span class="line"><span class="language-javascript">          target = child</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// è§¦å‘è¿™ä¸ªkeyçš„getæ–¹æ³• å°†targetä»¥é—­åŒ…çš„å½¢å¼ä¼ åˆ°depå®ä¾‹</span></span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">data</span>[key]</span></span><br><span class="line"><span class="language-javascript">          target = <span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="title function_">compile</span>(child)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">subs</span> = []</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addSub</span>(<span class="params">sub</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">update</span>(<span class="params">val</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        sub.<span class="property">innerHTML</span> = val</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Mvvm</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">name</span>: <span class="string">&#x27;æš‚æ— &#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">age</span>: <span class="number">20</span>,</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    vm.<span class="property">options</span>.<span class="property">data</span>.<span class="property">name</span> = <span class="string">&#x27;demo&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    vm.<span class="property">options</span>.<span class="property">data</span>.<span class="property">age</span> = <span class="number">30</span></span></span><br><span class="line"><span class="language-javascript">  &#125;, <span class="number">2000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/01/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmvvm/" data-id="cm54yagl60014b3hgg5sscatb" data-title="ç®€å•å®ç°ä¸€ä¸ªmvvm" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mvvm/" rel="tag">mvvm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-æµè§ˆå™¨çš„event loopæ¨¡å‹" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/06/06/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84event%20loop%E6%A8%A1%E5%9E%8B/" class="article-date">
  <time class="dt-published" datetime="2019-06-06T06:50:39.000Z" itemprop="datePublished">2019-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/06/06/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84event%20loop%E6%A8%A1%E5%9E%8B/">æµè§ˆå™¨çš„event loopæ¨¡å‹</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Event-Loop"><a href="#Event-Loop" class="headerlink" title="Event Loop"></a>Event Loop</h4><p>Event Loopå³äº‹ä»¶å¾ªç¯ï¼Œæ˜¯æŒ‡æµè§ˆå™¨æˆ–Nodeçš„ä¸€ç§è§£å†³javaScriptå•çº¿ç¨‹è¿è¡Œæ—¶ä¸ä¼šé˜»å¡çš„ä¸€ç§æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸ä½¿ç”¨å¼‚æ­¥çš„åŸç†ã€‚</p>
<h4 id="MacroTask-MicroTask"><a href="#MacroTask-MicroTask" class="headerlink" title="MacroTask&#x2F;MicroTask"></a>MacroTask&#x2F;MicroTask</h4><p>æåˆ°æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯å°±ä¸å¾—ä¸æåˆ°å®ä»»åŠ¡(MacroTask)å’Œå¾®ä»»åŠ¡(MicroTask)çš„æ¦‚å¿µ<br>å®ä»»åŠ¡çš„ä»£è¡¨ï¼š setTimeout&#x2F;setInterval&#x2F;setImmediateç­‰<br>å¾®ä»»åŠ¡çš„ä»£è¡¨ï¼š Promise&#x2F;MutationObserver å’Œnodeé‡Œçš„process.nextTickç­‰</p>
<p>ä¼—æ‰€å‘¨çŸ¥ jsæ˜¯å•çº¿ç¨‹è¿è¡Œçš„ é‚£å®ƒæ˜¯å¦‚ä½•å¤„ç†å¼‚æ­¥é€»è¾‘çš„å‘¢ï¼Ÿ</p>
<p>Javascript æœ‰ä¸€ä¸ª main thread ä¸»çº¿ç¨‹å’Œ call-stack è°ƒç”¨æ ˆ(æ‰§è¡Œæ ˆ)ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šè¢«æ”¾åˆ°è°ƒç”¨æ ˆç­‰å¾…ä¸»çº¿ç¨‹æ‰§è¡Œ<br>Javascriptå•çº¿ç¨‹ä»»åŠ¡è¢«åˆ†ä¸ºåŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡ä¼šåœ¨è°ƒç”¨æ ˆä¸­æŒ‰ç…§é¡ºåºç­‰å¾…ä¸»çº¿ç¨‹ä¾æ¬¡æ‰§è¡Œï¼Œ<br>å¼‚æ­¥ä»»åŠ¡ä¼šåœ¨å¼‚æ­¥ä»»åŠ¡æœ‰äº†ç»“æœåï¼Œå°†æ³¨å†Œçš„å›è°ƒå‡½æ•°æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸»çº¿ç¨‹ç©ºé—²çš„æ—¶å€™ï¼ˆè°ƒç”¨æ ˆè¢«æ¸…ç©ºï¼‰ï¼Œ<br>è¢«è¯»å–åˆ°æ ˆå†…ç­‰å¾…ä¸»çº¿ç¨‹çš„æ‰§è¡Œ</p>
<p>ä¸»çº¿ç¨‹çš„ä»»åŠ¡ä¼šæ”¾åœ¨ä¸»çº¿ç¨‹é˜Ÿåˆ—<br>å½“ä¸»çº¿ç¨‹é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•å<br>ä¼šå»checkå¾®ä»»åŠ¡é˜Ÿåˆ— æŒ¨ä¸ªæ‰§è¡Œå…¶ä¸­çš„å¾®ä»»åŠ¡<br>ç­‰åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰å¯æ‰§è¡Œçš„ä»»åŠ¡å ä¼šå»checkå®ä»»åŠ¡é˜Ÿåˆ—å¹¶æ‰§è¡Œå­˜åœ¨çš„ç¬¬ä¸€æ¡å®ä»»åŠ¡<br>æ‰§è¡Œä¸€æ¡å®ä»»åŠ¡å ä¼šå†æ¬¡checkå¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨å¾…æ‰§è¡Œä»»åŠ¡ å­˜åœ¨å°±æ‰§è¡Œå¾®ä»»åŠ¡ å¾ªç¯ä»¥ä¸Šæ“ä½œ</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/06/06/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84event%20loop%E6%A8%A1%E5%9E%8B/" data-id="cm54yagl70016b3hg3uwt3mmk" data-title="æµè§ˆå™¨çš„event loopæ¨¡å‹" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-dockerå®¹å™¨åŒ–éƒ¨ç½²å‰ç«¯é¡¹ç›®" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/06/docker%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time class="dt-published" datetime="2019-05-06T06:22:05.000Z" itemprop="datePublished">2019-05-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/06/docker%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/">dockerå®¹å™¨åŒ–éƒ¨ç½²å‰ç«¯é¡¹ç›®</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>è¿™æ¬¡æˆ‘ä»¬æ•´ä¸€ä¸‹dockeréƒ¨ç½²çš„é—®é¢˜ ä¼šæ¶‰åŠåˆ°dockerã€vueã€nginx</p>
<h4 id="Step-One"><a href="#Step-One" class="headerlink" title="Step One"></a>Step One</h4><p>å®‰è£…docker: ä»dockerå®˜ç½‘ä¸‹è½½ <a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-mac/">https://docs.docker.com/docker-for-mac/</a><br>å®‰è£…æ­¥éª¤ç•¥è¿‡â€¦</p>
<p>å®‰è£…nginx: docker pull nginx   ä¸€é¡¿æ“ä½œbalabalaâ€¦<br>å®‰è£…node: docker pull node</p>
<p>ä½¿ç”¨vue-cli3æ•´ä¸€ä¸ªvueé¡¹ç›®  ç›´æ¥vue create docker-vue  åˆæ˜¯ä¸€é€šbalabalaâ€¦ </p>
<p>æ•´ä¸ªå®‰è£…è¿‡ç¨‹æ¯”è¾ƒæ…¢ å…ˆæ™®åŠä¸€ä¸‹å‡ ä¸ªåŸºæœ¬çš„dockerå‘½ä»¤ </p>
<ol>
<li>docker images: æŸ¥çœ‹é•œåƒ</li>
<li>docker ps: æŸ¥çœ‹å®¹å™¨</li>
<li>docker exec -it { containerId } &#x2F;bin&#x2F;bash: è¿›å…¥æŸä¸ªå®¹å™¨çš„å‘½ä»¤è¡Œ</li>
<li>docker stop { containerId }: åœæ­¢æŸä¸ªå®¹å™¨</li>
<li>docker rm { containerId }: ç§»é™¤æŸä¸ªå®¹å™¨</li>
<li>docker rmi { imageId }: ç§»é™¤æŸä¸ªé•œåƒ </li>
<li>docker build -t { imageName } .: ç”Ÿæˆä¸€ä¸ªé•œåƒ</li>
<li>docker run -p {å®¹å™¨ç«¯å£:å®¿ä¸»ç«¯å£} -d { imageName }: å¯åŠ¨æŸä¸ªå®¹å™¨</li>
</ol>
<p>åŸºæœ¬ç”¨åˆ°çš„å‘½ä»¤å°±æ˜¯ä»¥ä¸Šå‡ ä¸ªäº†</p>
<h4 id="Step-Two"><a href="#Step-Two" class="headerlink" title="Step Two"></a>Step Two</h4><p>å¥½äº† è¯¥è£…çš„éƒ½è£…å¥½äº† æˆ‘ä»¬ç›´æ¥å¼€æ<br>åœ¨vueé¡¹ç›®ç«‹æ–°å»ºDockerfileæ–‡ä»¶ å†™å…¥ä»¥ä¸‹é…ç½®</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /docker-work/docker-vue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /docker-work/docker-vue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf dist/ node_modules/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è·¨åŸŸ</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /docker-work/docker-vue/nginx/default.conf /etc/nginx/conf.d/default.conf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /docker-work/docker-vue/dist /usr/share/nginx/html</span></span><br></pre></td></tr></table></figure>
<p>è§£é‡Šä¸€ä¸‹å‚æ•°<br>FROM è¡¨ç¤ºä½¿ç”¨dockerçš„å“ªä¸ªé•œåƒ å¯ä»¥æ˜¯æœ¬åœ°å®‰è£…çš„ ä¹Ÿå¯ä»¥æ˜¯dockeré•œåƒåº“é‡Œçš„<br>COPY è¡¨ç¤ºå°†æ–‡ä»¶ä»æœ¬åœ°æ‹·è´åˆ°è¿™ä¸ªdockeré•œåƒå¯¹åº”çš„å·¥ä½œç›®å½•é‡Œ å¯ä»¥é€šè¿‡docker execå‘½ä»¤æŸ¥çœ‹åˆ°<br>WORKDIR è¡¨ç¤ºå½“å‰çš„å·¥ä½œç›®å½•<br>RUN éœ€è¦å¯åŠ¨çš„å‘½ä»¤</p>
<p>ä¸€èˆ¬COPYçš„æ“ä½œéƒ½æ˜¯ç”¨ä»¥æ‹·è´å½“å‰é¡¹ç›®æ–‡ä»¶æˆ–è€…è¦†ç›–é•œåƒé…ç½® æˆ‘ä»¬ä¹Ÿå¯ä»¥è¦†ç›–nginxçš„default.confé…ç½®ç­‰</p>
<p>ä¸Šé¢çš„æ“ä½œå°±æ˜¯å°†é—¨é¡¹ç›®æ‹·è´åˆ°dockeré•œåƒçš„ç›®å½• é€šè¿‡è£…å¥½çš„node ä¾æ¬¡æ‰§è¡Œnpm installå’Œnpm run build<br>æ‰“åŒ…å®Œæ¯•åå‘¢å†å°†æ‰“åŒ…åçš„distç›®å½•æ‹·è´åˆ°å½“å‰é•œåƒå·¥ä½œç›®å½•çš„nginxé…ç½®é™æ€èµ„æºçš„ç›®å½• å¯åŠ¨nginxå°±è¡Œäº†</p>
<p>æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·<br>è¾“å…¥ docker build -t docker-vue . æ„å»ºé•œåƒ<br>æ„å»ºå®Œæ¯• docker imagesæŸ¥çœ‹æ˜¯å¦æ„å»ºæˆåŠŸ</p>
<p>è¾“å…¥ docker run -p 10000:80 -d docker-vue å¯åŠ¨å®¹å™¨ ä¸€ä¸ªå°æµç¨‹å°±ç®—å®Œæˆå•¦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/05/06/docker%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" data-id="cm54yagl00004b3hgbhpo0gjc" data-title="dockerå®¹å™¨åŒ–éƒ¨ç½²å‰ç«¯é¡¹ç›®" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker%E3%80%81node/" rel="tag">dockerã€node</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-reactä¹‹è½¬å‘ref" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/04/02/react%E4%B9%8B%E8%BD%AC%E5%8F%91ref/" class="article-date">
  <time class="dt-published" datetime="2019-04-02T12:19:16.000Z" itemprop="datePublished">2019-04-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/04/02/react%E4%B9%8B%E8%BD%AC%E5%8F%91ref/">reactä¹‹è½¬å‘ref</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Reactä¹‹è½¬å‘ref"><a href="#Reactä¹‹è½¬å‘ref" class="headerlink" title="Reactä¹‹è½¬å‘ref"></a>Reactä¹‹è½¬å‘ref</h4><p>react.16.3æ–°å¢äº†forwardRef Api ç”¨æ¥è½¬å‘refåˆ°å­ç»„ä»¶ä¸Š<br>è¿™é‡Œå¤§è‡´è¯´ä¸‹ä¸¤ç§æƒ…å†µ</p>
<ol>
<li>çº¯ç»„ä»¶ä¸èƒ½ä½¿ç”¨ref</li>
<li>å¦‚ä½•ç»™ä½¿ç”¨äº†é«˜é˜¶å‡½æ•°åŒ…è£¹çš„ç»„ä»¶åŠ ä¸Šref</li>
</ol>
<p>é’ˆå¯¹ä»¥ä¸Šä¸¤ç§æƒ…å†µ æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ–°çš„api</p>
<h5 id="çº¯ç»„ä»¶"><a href="#çº¯ç»„ä»¶" class="headerlink" title="çº¯ç»„ä»¶"></a>çº¯ç»„ä»¶</h5><p>çº¯ç»„ä»¶æ˜¯ä¸éœ€è¦refå±æ€§çš„ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨React.forwardRefå°†çˆ¶ç»„ä»¶åŠ çš„refè½¬å‘åˆ°inputé‡Œ</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ForwardRefButton</span> = <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="function">(<span class="params">props, ref</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line">))</span><br></pre></td></tr></table></figure>

<h5 id="é«˜é˜¶ç»„ä»¶"><a href="#é«˜é˜¶ç»„ä»¶" class="headerlink" title="é«˜é˜¶ç»„ä»¶"></a>é«˜é˜¶ç»„ä»¶</h5><p>æˆ‘ä»¬å…ˆå£°æ˜ä¸€ä¸ªé«˜é˜¶ç»„ä»¶hoc</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hoc</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">WrapperComponent</span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">HOC</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">      <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;hoc-wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">WrapperComponent</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#123;<span class="attr">...this.props</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&#123;this.props.forwardRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">HOC</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†å†™ä¸€ä¸ªæ­£å¸¸ç»„ä»¶</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ButtonRef</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>æµ‹è¯•é«˜é˜¶å‡½æ•°è½¬å‘ref<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HocButton</span> = <span class="title function_">hoc</span>()(<span class="title class_">ButtonRef</span>)</span><br></pre></td></tr></table></figure>
<p>HocButton æ˜¯æˆ‘ä»¬é€šè¿‡é«˜é˜¶ç»„ä»¶åŒ…è£…è¿‡çš„ç»„ä»¶<br>è¿™æ—¶å€™é«˜é˜¶ç»„ä»¶æ²¡æœ‰è¿›è¡Œrefè½¬å‘ å¯¼è‡´æˆ‘ä»¬ç»™HocButtonæ·»åŠ refå±æ€§çš„æ—¶å€™ åªèƒ½æ·»åŠ åˆ°HOCè¿™ä¸ªç»„ä»¶ä¸Š<br>æƒ³è¦ButtonRefä¹Ÿæ‹¥æœ‰è¿™ä¸ªå±æ€§ æˆ‘ä»¬å¾—æ”¹ä¸€ä¸‹é«˜é˜¶å‡½æ•°çš„è¿”å›å€¼ å¦‚ä¸‹:</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="function">(<span class="params">props, ref</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">HOC</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">forwardRef</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±èƒ½æ­£å¸¸è®¿é—®åˆ°è¢«é«˜é˜¶ç»„ä»¶åŒ…è£¹çš„å­ç»„ä»¶å•¦</p>
<p>æœ‰æ²¡æœ‰åŠæ³•ä¸ä½¿ç”¨forwardRefå°±èƒ½åšåˆ°refè½¬å‘å‘¢ï¼Ÿ<br>å½“ç„¶æœ‰ å¯ä»¥æŠŠrefå½“åšåšä¸ªå±æ€§ä¼ è¿›é«˜é˜¶å‡½æ•° å†ç»ç”±é«˜é˜¶ç»„ä»¶æ³¨å†Œåˆ°å­ç»„ä»¶ä¸Š ä¹Ÿèƒ½å®ç°refè½¬å‘å•¦ è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­<br>æˆ‘ä»¬å†ä½¿ç”¨HocButtonæ—¶</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">handleRef</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">buttonRef</span> = el</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">HocButton</span> <span class="attr">wrappedref</span>=<span class="string">&#123;this.handleRef.bind(this)&#125;</span> /&gt;</span></span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ”¹ä¸€ä¸‹é«˜é˜¶ç»„ä»¶å†…éƒ¨è°ƒç”¨ å¦‚ä¸‹:</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hoc</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">WrappedComponent</span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">HOC</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">      <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;hoc-wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">WrappedComponent</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#123;<span class="attr">...this.props</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&#123;this.props.wrappedref&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">HOC</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä¹Ÿæ˜¯å®ç°refè½¬å‘åˆ°WrappedComponentä¸Šå•¦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/04/02/react%E4%B9%8B%E8%BD%AC%E5%8F%91ref/" data-id="cm54yagl2000db3hgbf3tg1nm" data-title="reactä¹‹è½¬å‘ref" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" rel="tag">react ref ç¬”è®°</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-react-reduxæºç è§£è¯»" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/22/react-redux%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="article-date">
  <time class="dt-published" datetime="2019-03-22T06:43:31.000Z" itemprop="datePublished">2019-03-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/03/22/react-redux%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">react-reduxæºç è§£è¯»</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="react-reduxæºç è§£è¯»"><a href="#react-reduxæºç è§£è¯»" class="headerlink" title="react-reduxæºç è§£è¯»"></a>react-reduxæºç è§£è¯»</h2><p>ä¸Šä¸€ç¯‡ç¿»äº†ä¸€ä¸‹reduxçš„æºç  è¿™ä¸€ç¯‡å°±ç ”ç©¶ä¸‹react-reduxå§<br>åŸç†å¤§å®¶éƒ½çŸ¥é“ å°±æ˜¯åˆ©ç”¨reactçš„Context Api<br>é‚£æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆåœ¨reactåº”ç”¨ä¸­æ–½å±•é­”æ³•çš„å§~~</p>
<p>çœ‹ä»£ç  å…ˆçœ‹index.js</p>
<h4 id="src-index-js"><a href="#src-index-js" class="headerlink" title="src&#x2F;index.js"></a>src&#x2F;index.js</h4><p>è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸»å…¥å£  æš´éœ²å‡º Provider&#x2F;connectAdvanced&#x2F;ReactReduxContext&#x2F;connectå››ä¸ªæ ¸å¿ƒæ–¹æ³•</p>
<ol>
<li>å…¶ä¸­ï¼ŒProvideræ˜¯ä¸ªreactç»„ä»¶ æ˜¯å­˜å‚¨storeæ•°çš„æ ¹èŠ‚ç‚¹</li>
<li>ReactReduxContextæ˜¯ä¸ªreact contextï¼Œæ‰€æœ‰å­ç»„ä»¶çš„éƒ½è¦ä»è¿™ä¸ªcontextè·å–storeçš„æ•°æ®</li>
<li>connect æ˜¯å…³è”ç»„ä»¶å’Œstoreçš„æ–¹æ³•</li>
<li>connectAdvanced æ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ è´Ÿè´£å°†connectçš„å‚æ•°è¿›è¡Œå°è£…æ·»åŠ åˆ°å­ç»„ä»¶çš„propsä¸Š</li>
</ol>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Provider</span> <span class="keyword">from</span> <span class="string">&#x27;./components/Provider&#x27;</span></span><br><span class="line"><span class="keyword">import</span> connectAdvanced <span class="keyword">from</span> <span class="string">&#x27;./components/connectAdvanced&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReactReduxContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./components/Context&#x27;</span></span><br><span class="line"><span class="keyword">import</span> connect <span class="keyword">from</span> <span class="string">&#x27;./connect/connect&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; <span class="title class_">Provider</span>, connectAdvanced, <span class="title class_">ReactReduxContext</span>, connect &#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°è¿™å‡ ä¸ªæ–¹æ³•å°±èƒ½çŒœåˆ°react-reduxåˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿéš¾ç‚¹åœ¨å“ªé‡Œï¼Ÿæ€ä¹ˆé¿å…ä¸å¿…è¦çš„æ¸²æŸ“ï¼Ÿä»¥åŠä½¿ç”¨é«˜é˜¶å‡½æ•°æ—¶å¯¹äºrefçš„è½¬å‘ï¼Ÿ</p>
<p>æˆ‘ä»¬ä¸å¦¨å…ˆçœ‹Providerè¿™ä¸ªç»„ä»¶å§ æ¯•ç«Ÿä»–ä¹Ÿæ˜¯reactä½¿ç”¨reduxçš„å…¥å£ ä¹Ÿæ˜¯å…³è”storeçš„ç¬¬ä¸€ç¯</p>
<h4 id="src-components-Provider-js"><a href="#src-components-Provider-js" class="headerlink" title="src&#x2F;components&#x2F;Provider.js"></a>src&#x2F;components&#x2F;Provider.js</h4><p>Provideræ˜¯ä¸€ä¸ªreactç»„ä»¶ æ¥æ”¶ä¸‰ä¸ªprops</p>
<ol>
<li>store</li>
<li>context</li>
<li>children<br>ç”±æ­¤æˆ‘ä»¬çŒœæµ‹ react-reduxå†…éƒ¨è‚¯å®šä¼šä½¿ç”¨ç›¸å½“å¤šçš„é—­åŒ…è¿›è¡Œç¼“å­˜ä»¥é¿å…ä¸å¿…è¦çš„æ¸²æŸ“<br>ç»“åˆconnectçš„ä½¿ç”¨ æ¨æ–­ä¼šæœ‰æ ¹æ®storeStateå’ŒownPropsè¿›è¡Œåˆ¤æ–­æ˜¯å¦è¿›è¡Œæ¸²æŸ“çš„é€»è¾‘ ä¹Ÿç†åº”ä¼šæœ‰</li>
</ol>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Provider</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * å°†storeå’Œstoreå½“å‰çš„stateä¿å­˜åœ¨ç»„ä»¶çš„stateä¸Š</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">      <span class="variable language_">super</span>(props)</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">const</span> &#123; store &#125; = props</span><br><span class="line">  </span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        <span class="attr">storeState</span>: store.<span class="title function_">getState</span>(),</span><br><span class="line">        store</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç»„ä»¶åŠ è½½å®Œæ‰§è¡Œsubscribe</span></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_isMounted</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">subscribe</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»„ä»¶å¸è½½ä¹‹å‰</span></span><br><span class="line">    <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// å–æ¶ˆç›‘å¬</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">unsubscribe</span>) <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>()</span><br><span class="line">  </span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_isMounted</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç»„ä»¶æ›´æ–°ç»“æŸ å¦‚æœstoreçš„å¼•ç”¨å˜äº† å¦‚æœå·²ç»æœ‰ç›‘å¬ å–æ¶ˆç›‘å¬ é‡æ–°ç›‘å¬</span></span><br><span class="line">    <span class="comment">// å¼•ç”¨å˜äº†æ˜¯æŒ‡ æ‰§è¡Œreducerçš„è¿‡ç¨‹ä¸­ redux/combineReducersé‡Œçš„hasChangedç›¸å¯¹ä¹‹å‰å‘ç”Ÿäº†å˜åŒ–</span></span><br><span class="line">    <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">store</span> !== prevProps.<span class="property">store</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">unsubscribe</span>) <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>()</span><br><span class="line">  </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">subscribe</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; store &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// å¯¹storeæ·»åŠ ç›‘å¬</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">unsubscribe</span> = store.<span class="title function_">subscribe</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°åçš„storeæ ‘</span></span><br><span class="line">        <span class="keyword">const</span> newStoreState = store.<span class="title function_">getState</span>()</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// å¦‚æœç»„ä»¶åœ¨å¸è½½å‰ return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_isMounted</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¯”è¾ƒæ–°æ—§store å‡å°‘ä¸å¿…è¦çš„æ›´æ–°</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">providerState</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// If the value is the same, skip the unnecessary state update.</span></span><br><span class="line">          <span class="keyword">if</span> (providerState.<span class="property">storeState</span> === newStoreState) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="keyword">return</span> &#123; <span class="attr">storeState</span>: newStoreState &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// dispatchåŠ¨ä½œå¯èƒ½åœ¨renderå’ŒcomponentDidUpdateä¹‹é—´è¿›è¡Œ æ‰‹åŠ¨åŒæ­¥store</span></span><br><span class="line">      <span class="comment">// Actions might have been dispatched between render and mount - handle those</span></span><br><span class="line">      <span class="keyword">const</span> postMountStoreState = store.<span class="title function_">getState</span>()</span><br><span class="line">      <span class="keyword">if</span> (postMountStoreState !== <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">storeState</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">storeState</span>: postMountStoreState &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Context</span> = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span> || <span class="title class_">ReactReduxContext</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ContextåŒ…è£¹children</span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;this.state&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;this.props.children&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="src-connect-connect-js"><a href="#src-connect-connect-js" class="headerlink" title="src&#x2F;connect&#x2F;connect.js"></a>src&#x2F;connect&#x2F;connect.js</h4><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createConnect</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  connectHOC = connectAdvanced,</span></span><br><span class="line"><span class="params">  mapStateToPropsFactories = defaultMapStateToPropsFactories,</span></span><br><span class="line"><span class="params">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,</span></span><br><span class="line"><span class="params">  mergePropsFactories = defaultMergePropsFactories,</span></span><br><span class="line"><span class="params">  selectorFactory = defaultSelectorFactory</span></span><br><span class="line"><span class="params">&#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// è¿™ä¸ªconnectæ–¹æ³•æ­£æ˜¯æˆ‘ä»¬ç”¨åˆ°çš„connect(mapStateToProps, mapDispatchToProps)(WrapperComponent)çš„çœŸé¢ç›®</span></span><br><span class="line">  <span class="comment">// mapStateToPropsã€mapDispatchToPropsç­‰å‚æ•°æˆ‘å°±ä¸ä¸€ä¸€ä»‹ç»äº† è¯·ç§»æ­¥å®˜ç½‘</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">connect</span>(<span class="params"></span></span><br><span class="line"><span class="params">    mapStateToProps,</span></span><br><span class="line"><span class="params">    mapDispatchToProps,</span></span><br><span class="line"><span class="params">    mergeProps,</span></span><br><span class="line"><span class="params">    &#123;</span></span><br><span class="line"><span class="params">      // æ˜¯å¦å¯ç”¨PureComponentæ¨¡å¼</span></span><br><span class="line"><span class="params">      pure = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">      // åœ¨è°ƒç”¨selectorFactoryçš„æ—¶å€™ ä¸ºäº†ä½¿ç”¨ç¼“å­˜éœ€è¦è°ƒç”¨çš„æ¯”å¯¹æ–¹æ³•</span></span><br><span class="line"><span class="params">      areStatesEqual = strictEqual,</span></span><br><span class="line"><span class="params">      // åŒä¸Š</span></span><br><span class="line"><span class="params">      areOwnPropsEqual = shallowEqual,</span></span><br><span class="line"><span class="params">      // åŒä¸Š</span></span><br><span class="line"><span class="params">      areStatePropsEqual = shallowEqual,</span></span><br><span class="line"><span class="params">      // åŒä¸Š</span></span><br><span class="line"><span class="params">      areMergedPropsEqual = shallowEqual,</span></span><br><span class="line"><span class="params">      // åˆ«çš„å‚æ•°  getDisplayName/methodName/renderCountProp/shouldHandleStateChangesç­‰...</span></span><br><span class="line"><span class="params">      ...extraOptions</span></span><br><span class="line"><span class="params">    &#125; = &#123;&#125;</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * wrapperçš„å­˜åœ¨æ˜¯ä¸ºäº†è®©å„ç§ç±»å‹çš„è¿”å›å€¼ä¿æŒä¸€è‡´</span></span><br><span class="line"><span class="comment">    * å¦‚æœmapStateToPropsæ˜¯functionç±»å‹ return (dispatch, &#123; displayName &#125;) =&gt; proxy</span></span><br><span class="line"><span class="comment">    * å¦‚æœä¸å­˜åœ¨ return (dispatch, option) =&gt; constantSelector</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="comment">// è¿™ä¸‰ä¸ªæƒ…å†µç±»ä¼¼ åé¢å°±çœ‹initMapStateToPropsçš„æ‰§è¡Œè¿‡ç¨‹å°±å¤Ÿäº†</span></span><br><span class="line">    <span class="keyword">const</span> initMapStateToProps = <span class="title function_">match</span>(</span><br><span class="line">      mapStateToProps,</span><br><span class="line">      mapStateToPropsFactories,</span><br><span class="line">      <span class="string">&#x27;mapStateToProps&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> initMapDispatchToProps = <span class="title function_">match</span>(</span><br><span class="line">      mapDispatchToProps,</span><br><span class="line">      mapDispatchToPropsFactories,</span><br><span class="line">      <span class="string">&#x27;mapDispatchToProps&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> initMergeProps = <span class="title function_">match</span>(mergeProps, mergePropsFactories, <span class="string">&#x27;mergeProps&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™ä¸ªæš‚æ—¶å¯ä»¥çœ‹ä½œ return function(WrapperComponent) &#123;&#125;è¿™æ ·ä¸€ä¸ªæ¥æ”¶ä¸€ä¸ªç»„ä»¶çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">connectHOC</span>(selectorFactory, &#123;</span><br><span class="line">      <span class="comment">// used in error messages</span></span><br><span class="line">      <span class="attr">methodName</span>: <span class="string">&#x27;connect&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// used to compute Connect&#x27;s displayName from the wrapped component&#x27;s displayName.</span></span><br><span class="line">      <span class="attr">getDisplayName</span>: <span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`Connect(<span class="subst">$&#123;name&#125;</span>)`</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if mapStateToProps is falsy, the Connect component doesn&#x27;t subscribe to store state changes</span></span><br><span class="line">      <span class="attr">shouldHandleStateChanges</span>: <span class="title class_">Boolean</span>(mapStateToProps),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// passed through to selectorFactory</span></span><br><span class="line">      initMapStateToProps,</span><br><span class="line">      initMapDispatchToProps,</span><br><span class="line">      initMergeProps,</span><br><span class="line">      pure,</span><br><span class="line">      areStatesEqual,</span><br><span class="line">      areOwnPropsEqual,</span><br><span class="line">      areStatePropsEqual,</span><br><span class="line">      areMergedPropsEqual,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// any extra options args can override defaults of connect or connectAdvanced</span></span><br><span class="line">      ...extraOptions</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨é»˜è®¤å‚æ•°è¿”å›ä¸€ä¸ªconnecté«˜é˜¶å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createConnect</span>()</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªcreateConnectæ–¹æ³•æ¥æ”¶5ä¸ªå‚æ•°</p>
<ol>
<li>connectHoc é»˜è®¤å€¼ä¸ºä¸€ä¸ªé«˜é˜¶å‡½æ•°</li>
<li>mapStateToPropsFactories ä¸ºç”¨æˆ·ä¼ å…¥çš„mapStateToPropså€¼å‡†å¤‡çš„ç±»å‹æ˜ å°„ æ¯ä¸ªç±»å‹å¯¹åº”ä¸åŒçš„æ‰§è¡Œæ–¹æ³•</li>
<li>mapDispatchToPropsFactories åŒä¸Š</li>
<li>mergePropsFactories åŒä¸Š</li>
<li>selectorFactory è¿™ä¸ªæ˜¯é€šè¿‡mapStateToPropså’ŒmapDispatchToPropsè·å–æœ€ç»ˆstateProps, dispatchPropså¹¶å°†å®ƒä»¬mergeåˆ°ç»„ä»¶propsçš„è¿‡ç¨‹</li>
</ol>
<p>matchæ–¹æ³•<br>matchæ–¹æ³•ä¼šä¾æ¬¡æ‰§è¡Œç¬¬äºŒä¸ªå‚æ•°çš„æ¯ä¸ªå…ƒç´  å…¥å‚ä¸ºç¬¬ä¸€ä¸ªå‚æ•° åªè¦æœ‰è¿”å›å€¼ å°±return å¦åˆ™æŠ›å‡ºå¼‚å¸¸</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">match</span>(<span class="params">arg, factories, name</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = factories.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = factories[i](arg)</span><br><span class="line">    <span class="comment">// æ­¤æ—¶result çš„ç±»å‹æ˜¯ (dispatch, &#123;&#125;) =&gt; &#123;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">      <span class="string">`Invalid value of type <span class="subst">$&#123;<span class="keyword">typeof</span> arg&#125;</span> for <span class="subst">$&#123;name&#125;</span> argument when connecting component <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        options.wrappedComponentName</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span>.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹initMapStateToPropsæ˜¯æ€ä¹ˆäº§ç”Ÿçš„</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initMapStateToProps = <span class="title function_">match</span>(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapStateToPropsFactories,</span><br><span class="line">  <span class="string">&#x27;mapStateToProps&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>matchçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„mapStateToProps é€šå¸¸æ˜¯è¿™æ ·çš„</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = state =&gt; (&#123;</span><br><span class="line">  <span class="attr">username</span>: state.<span class="property">profile</span>.<span class="property">username</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªå‚æ•°ä¸ºmapStateToPropsFactories é»˜è®¤å€¼ä¸ºdefaultMapStateToPropsFactories æˆ‘ä»¬çœ‹çœ‹ä»–æ˜¯ä½•æ–¹ç¥åœ£</p>
<h4 id="src-connect-mapStateToProps-js"><a href="#src-connect-mapStateToProps-js" class="headerlink" title="src&#x2F;connect&#x2F;mapStateToProps.js"></a>src&#x2F;connect&#x2F;mapStateToProps.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; wrapMapToPropsConstant, wrapMapToPropsFunc &#125; <span class="keyword">from</span> <span class="string">&#x27;./wrapMapToProps&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">whenMapStateToPropsIsFunction</span>(<span class="params">mapStateToProps</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> mapStateToProps === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? <span class="title function_">wrapMapToPropsFunc</span>(mapStateToProps, <span class="string">&#x27;mapStateToProps&#x27;</span>)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">whenMapStateToPropsIsMissing</span>(<span class="params">mapStateToProps</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !mapStateToProps ? <span class="title function_">wrapMapToPropsConstant</span>(<span class="function">() =&gt;</span> (&#123;&#125;)) : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [whenMapStateToPropsIsFunction, whenMapStateToPropsIsMissing]</span><br></pre></td></tr></table></figure>
<p>ä»è¿™ä¸ªæ–‡ä»¶å¯ä»¥çŸ¥é“defaultMapStateToPropsFactorieså°±æ˜¯æš´éœ²å‡ºæ¥çš„è¿™ä¸ªæ•°ç»„<br>ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡ è¿™ä¸ªä¸œè¥¿æ˜¯å¹²å˜›ç”¨çš„å‘¢ è¿™æ˜¯ä¸ªå‚æ•°ç±»å‹æ˜ å°„é›†åˆ<br>ä»åå­—å¯ä»¥çœ‹å‡ºmapStateToPropså¯ä»¥æ˜¯function ä¹Ÿå¯ä»¥ä¸ºç©º</p>
<p>æˆ‘ä»¬ä¸Šé¢ä¸¾äº†ä¸ªfunctionçš„ğŸŒ°  å…ˆçœ‹æ˜¯functionçš„æƒ…å†µå§</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">whenMapStateToPropsIsFunction</span>(<span class="params">mapStateToProps</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> mapStateToProps === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? <span class="title function_">wrapMapToPropsFunc</span>(mapStateToProps, <span class="string">&#x27;mapStateToProps&#x27;</span>)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•åˆ¤æ–­å¦‚æœmapStateToPropsæ˜¯functionç±»å‹çš„å°±è¿”å›wrapMapToPropsFunc(mapStateToProps, â€˜mapStateToPropsâ€™)çš„æ‰§è¡Œç»“æœ<br>æˆ‘ä»¬ç§»æ­¥çœ‹çœ‹wrapMapToPropsFuncæ˜¯ä½•æ–¹ç¥åœ£å§</p>
<h4 id="src-connect-wrapMapToProps-js"><a href="#src-connect-wrapMapToProps-js" class="headerlink" title="src&#x2F;connect&#x2F;wrapMapToProps.js"></a>src&#x2F;connect&#x2F;wrapMapToProps.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">wrapMapToPropsFunc</span>(<span class="params">mapToProps, methodName</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">initProxySelector</span>(<span class="params">dispatch, &#123; displayName &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæš‚æ—¶å…ˆçœç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€æ¬¡çœ‹è¿™ä¸ªä»£ç æœ‰ç‚¹æ‡µé€¼ï¼Œè¿™æ˜¯ä¸ªå•¥ï¼Œåˆæ²¡æœ‰ä»€ä¹ˆä¸Šä¸‹æ–‡ä¹‹ç±»çš„ è¿™ä¸ªä¸ç”¨ç®¡<br>åªéœ€è¦çŸ¥é“è¿”å›çš„æ˜¯ä¸€ä¸ª(dispatch, options) &#x3D;&gt; {} è¿™æ ·çš„initProxySelectorå‡½æ•°å°±è¡Œäº†<br>å½“mapStateToPropsä¼ ç©ºçš„æ—¶å€™ä¹Ÿæ˜¯ç±»ä¼¼è¿™ç§æƒ…å†µ ä»£ç å°±ä¸è´´äº† ä¸‹é¢æˆ‘ä»¬ä¼šå›é¡¾è¿™ä¸ªä»£ç çš„</p>
<h4 id="src-components-connectAdvanced-js"><a href="#src-components-connectAdvanced-js" class="headerlink" title="src&#x2F;components&#x2F;connectAdvanced.js"></a>src&#x2F;components&#x2F;connectAdvanced.js</h4><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">connectAdvanced</span>(<span class="params"></span></span><br><span class="line"><span class="params">  selectorFactory,</span></span><br><span class="line"><span class="params">  &#123;</span></span><br><span class="line"><span class="params">    getDisplayName = name =&gt; <span class="string">`ConnectAdvanced(<span class="subst">$&#123;name&#125;</span>)`</span>,</span></span><br><span class="line"><span class="params">    methodName = <span class="string">&#x27;connectAdvanced&#x27;</span>,</span></span><br><span class="line"><span class="params">    renderCountProp = <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">    shouldHandleStateChanges = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">    storeKey = <span class="string">&#x27;store&#x27;</span>,</span></span><br><span class="line"><span class="params">    withRef = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params">    forwardRef = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params">    context = ReactReduxContext,</span></span><br><span class="line"><span class="params">    ...connectOptions</span></span><br><span class="line"><span class="params">  &#125; = &#123;&#125;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    renderCountProp === <span class="literal">undefined</span>,</span><br><span class="line">    <span class="string">`renderCountProp is removed. render counting is built into the latest React dev tools profiling extension`</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    !withRef,</span><br><span class="line">    <span class="string">&#x27;withRef is removed. To access the wrapped instance, use a ref on the connected component&#x27;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> customStoreWarningMessage =</span><br><span class="line">    <span class="string">&#x27;To use a custom Redux store for specific components, create a custom React context with &#x27;</span> +</span><br><span class="line">    <span class="string">&quot;React.createContext(), and pass the context object to React Redux&#x27;s Provider and specific components&quot;</span> +</span><br><span class="line">    <span class="string">&#x27; like: &lt;Provider context=&#123;MyContext&#125;&gt;&lt;ConnectedComponent context=&#123;MyContext&#125; /&gt;&lt;/Provider&gt;. &#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;You may also pass a &#123;context : MyContext&#125; option to connect&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    storeKey === <span class="string">&#x27;store&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;storeKey has been removed and does not do anything. &#x27;</span> +</span><br><span class="line">      customStoreWarningMessage</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Context</span> = context</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">invariant</span>(</span><br><span class="line">        <span class="title function_">isValidElementType</span>(<span class="title class_">WrappedComponent</span>),</span><br><span class="line">        <span class="string">`You must pass a component to the function returned by `</span> +</span><br><span class="line">          <span class="string">`<span class="subst">$&#123;methodName&#125;</span>. Instead received <span class="subst">$&#123;stringifyComponent(</span></span></span><br><span class="line"><span class="subst"><span class="string">            WrappedComponent</span></span></span><br><span class="line"><span class="subst"><span class="string">          )&#125;</span>`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> wrappedComponentName =</span><br><span class="line">      <span class="title class_">WrappedComponent</span>.<span class="property">displayName</span> || <span class="title class_">WrappedComponent</span>.<span class="property">name</span> || <span class="string">&#x27;Component&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> displayName = <span class="title function_">getDisplayName</span>(wrappedComponentName)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> selectorFactoryOptions = &#123;</span><br><span class="line">      ...connectOptions,</span><br><span class="line">      getDisplayName,</span><br><span class="line">      methodName,</span><br><span class="line">      renderCountProp,</span><br><span class="line">      shouldHandleStateChanges,</span><br><span class="line">      storeKey,</span><br><span class="line">      displayName,</span><br><span class="line">      wrappedComponentName,</span><br><span class="line">      <span class="title class_">WrappedComponent</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; pure &#125; = connectOptions</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">OuterBaseComponent</span> = <span class="title class_">Component</span></span><br><span class="line">    <span class="comment">// æ ¹æ®pure é€‰æ‹©ä½¿ç”¨Componentè¿˜æ˜¯PureComponent</span></span><br><span class="line">    <span class="keyword">if</span> (pure) &#123;</span><br><span class="line">      <span class="title class_">OuterBaseComponent</span> = <span class="title class_">PureComponent</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Connect</span> <span class="keyword">extends</span> <span class="title class_ inherited__">OuterBaseComponent</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Connect</span>.<span class="property">WrappedComponent</span> = <span class="title class_">WrappedComponent</span></span><br><span class="line">    <span class="title class_">Connect</span>.<span class="property">displayName</span> = displayName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (forwardRef) &#123;</span><br><span class="line">      <span class="comment">// è½¬å‘refåˆ°Connectç»„ä»¶ å°†propsè½¬åŒ–ä¸ºwrapperProps  refè½¬åŒ–ä¸ºforwardedRef</span></span><br><span class="line">      <span class="keyword">const</span> forwarded = <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="keyword">function</span> <span class="title function_">forwardConnectRef</span>(<span class="params"></span></span><br><span class="line"><span class="params">        props,</span></span><br><span class="line"><span class="params">        ref</span></span><br><span class="line"><span class="params">      </span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Connect</span> <span class="attr">wrapperProps</span>=<span class="string">&#123;props&#125;</span> <span class="attr">forwardedRef</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      forwarded.<span class="property">displayName</span> = displayName</span><br><span class="line">      forwarded.<span class="property">WrappedComponent</span> = <span class="title class_">WrappedComponent</span></span><br><span class="line">      <span class="comment">// åˆå¹¶static methods</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">hoistStatics</span>(forwarded, <span class="title class_">WrappedComponent</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hoistStatics</span>(<span class="title class_">Connect</span>, <span class="title class_">WrappedComponent</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç çš„ä½œç”¨ä¸»è¦æ˜¯å°±æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„ç»„ä»¶<br>é‡ç‚¹çœ‹ Connectç»„ä»¶</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Connect</span> <span class="keyword">extends</span> <span class="title class_ inherited__">OuterBaseComponent</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      forwardRef ? !props.<span class="property">wrapperProps</span>[storeKey] : !props[storeKey],</span><br><span class="line">      <span class="string">&#x27;Passing redux store in props has been removed and does not do anything. &#x27;</span> +</span><br><span class="line">        customStoreWarningMessage</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">selectDerivedProps</span> = <span class="title function_">makeDerivedPropsSelector</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">selectChildElement</span> = <span class="title function_">makeChildElementSelector</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">indirectRenderWrappedComponent</span> = <span class="variable language_">this</span>.<span class="property">indirectRenderWrappedComponent</span>.<span class="title function_">bind</span>(</span><br><span class="line">      <span class="variable language_">this</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Context.Consumerçš„children</span></span><br><span class="line">  <span class="title function_">indirectRenderWrappedComponent</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="comment">// calling renderWrappedComponent on prototype from indirectRenderWrappedComponent bound to `this`</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">renderWrappedComponent</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">renderWrappedComponent</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      value,</span><br><span class="line">      <span class="string">`Could not find &quot;store&quot; in the context of `</span> +</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;displayName&#125;</span>&quot;. Either wrap the root component in a &lt;Provider&gt;, `</span> +</span><br><span class="line">        <span class="string">`or pass a custom React context provider to &lt;Provider&gt; and the corresponding `</span> +</span><br><span class="line">        <span class="string">`React context consumer to <span class="subst">$&#123;displayName&#125;</span> in connect options.`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> &#123; storeState, store &#125; = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> wrapperProps = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">    <span class="keyword">let</span> forwardedRef</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (forwardRef) &#123;</span><br><span class="line">      wrapperProps = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">wrapperProps</span></span><br><span class="line">      forwardedRef = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">forwardedRef</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> derivedProps = <span class="variable language_">this</span>.<span class="title function_">selectDerivedProps</span>(</span><br><span class="line">      storeState,</span><br><span class="line">      wrapperProps,</span><br><span class="line">      store,</span><br><span class="line">      selectorFactoryOptions</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">selectChildElement</span>(</span><br><span class="line">      <span class="title class_">WrappedComponent</span>,</span><br><span class="line">      derivedProps,</span><br><span class="line">      forwardedRef</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨é»˜è®¤çš„contextæºè¿˜æ˜¯ å¤–éƒ¨ä¼ å…¥çš„context</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">ContextToUse</span> =</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span> &amp;&amp;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span>.<span class="property">Consumer</span> &amp;&amp;</span><br><span class="line">      <span class="title function_">isContextConsumer</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">this.props.context.Consumer</span> /&gt;</span></span>)</span><br><span class="line">        ? <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span></span><br><span class="line">        : <span class="title class_">Context</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">ContextToUse.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;this.indirectRenderWrappedComponent&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ContextToUse.Consumer</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆä»æ„é€ å‡½æ•°çœ‹èµ·</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">selectDerivedProps</span> = <span class="title function_">makeDerivedPropsSelector</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">selectChildElement</span> = <span class="title function_">makeChildElementSelector</span>()</span><br></pre></td></tr></table></figure>
<p>makeDerivedPropsSelectorã€makeChildElementSelectoræ–¹æ³•</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeDerivedPropsSelector</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastProps</span><br><span class="line">  <span class="keyword">let</span> lastState</span><br><span class="line">  <span class="keyword">let</span> lastDerivedProps</span><br><span class="line">  <span class="keyword">let</span> lastStore</span><br><span class="line">  <span class="keyword">let</span> lastSelectorFactoryOptions</span><br><span class="line">  <span class="keyword">let</span> sourceSelector</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">selectDerivedProps</span>(<span class="params"></span></span><br><span class="line"><span class="params">    state,</span></span><br><span class="line"><span class="params">    props,</span></span><br><span class="line"><span class="params">    store,</span></span><br><span class="line"><span class="params">    selectorFactoryOptions</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pure &amp;&amp; lastProps === props &amp;&amp; lastState === state) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastDerivedProps</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      store !== lastStore ||</span><br><span class="line">      lastSelectorFactoryOptions !== selectorFactoryOptions</span><br><span class="line">    ) &#123;</span><br><span class="line">      lastStore = store</span><br><span class="line">      lastSelectorFactoryOptions = selectorFactoryOptions</span><br><span class="line">      sourceSelector = <span class="title function_">selectorFactory</span>(</span><br><span class="line">        store.<span class="property">dispatch</span>,</span><br><span class="line">        selectorFactoryOptions</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastProps = props</span><br><span class="line">    lastState = state</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> nextProps = <span class="title function_">sourceSelector</span>(state, props)</span><br><span class="line"></span><br><span class="line">    lastDerivedProps = nextProps</span><br><span class="line">    <span class="keyword">return</span> lastDerivedProps</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeChildElementSelector</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastChildProps, lastForwardRef, lastChildElement, lastComponent</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">selectChildElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">    WrappedComponent,</span></span><br><span class="line"><span class="params">    childProps,</span></span><br><span class="line"><span class="params">    forwardRef</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      childProps !== lastChildProps ||</span><br><span class="line">      forwardRef !== lastForwardRef ||</span><br><span class="line">      lastComponent !== <span class="title class_">WrappedComponent</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      lastChildProps = childProps</span><br><span class="line">      lastForwardRef = forwardRef</span><br><span class="line">      lastComponent = <span class="title class_">WrappedComponent</span></span><br><span class="line">      lastChildElement = (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...childProps</span>&#125; <span class="attr">ref</span>=<span class="string">&#123;forwardRef&#125;</span> /&gt;</span></span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lastChildElement</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>makeDerivedPropsSelector<br>è¿™ä¸ªæ–¹æ³•è¿™å°±è¦æ˜¯ç»™ç»„ä»¶æ¥æ”¶ä»storeè¡ç”Ÿçš„propsåšäº†ä¸€å±‚ç¼“å­˜ ç»†èŠ‚å¯ä»¥è‡ªå·±å»çœ‹ è¿™è¾¹ä¸»è¦çœ‹ä¸€ä¸‹ç”¨åˆ°çš„selectorFactoryæ–¹æ³• è¿™ä¸ªæ–¹æ³•æ˜¯connectAdvancedçš„å…¥å‚<br>å›åˆ°src&#x2F;connect&#x2F;connect.js è¿™ä¸ªselectorFactoryæœ‰ä¸€ä¸ªé»˜è®¤å€¼ä¸ºdefaultSelectorFactory æˆ‘ä»¬çœ‹ä¸€ä¸‹src&#x2F;connect&#x2F;selectorFactory.js</li>
</ol>
<h4 id="src-connect-selectorFactory-js"><a href="#src-connect-selectorFactory-js" class="headerlink" title="src&#x2F;connect&#x2F;selectorFactory.js"></a>src&#x2F;connect&#x2F;selectorFactory.js</h4><p>æ¥æ”¶dispatchå’Œoptionsä½œä¸ºå‚æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">finalPropsSelectorFactory</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatch,</span></span><br><span class="line"><span class="params">  &#123; initMapStateToProps, initMapDispatchToProps, initMergeProps, ...options &#125;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// initMapStateToPropsã€initMapDispatchToPropsã€initMergePropså°±æ˜¯åœ¨createConnectä¸­ ç»ç”±matchè®¡ç®—çš„ç»“æœinitProxySelector</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥æˆ‘ä»¬åœ¨ä¸‹é¢å›é¡¾ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> mapStateToProps = <span class="title function_">initMapStateToProps</span>(dispatch, options)</span><br><span class="line">  <span class="comment">// åŒä¸Š</span></span><br><span class="line">  <span class="keyword">const</span> mapDispatchToProps = <span class="title function_">initMapDispatchToProps</span>(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mergeProps = <span class="title function_">initMergeProps</span>(dispatch, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">verifySubselectors</span>(</span><br><span class="line">      mapStateToProps,</span><br><span class="line">      mapDispatchToProps,</span><br><span class="line">      mergeProps,</span><br><span class="line">      options.<span class="property">displayName</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®pureé€‰æ‹©ä¸åŒçš„è®¡ç®—æ–¹æ³•</span></span><br><span class="line">  <span class="comment">// å¦‚æœpureä¸ºfalse æ— è„‘æ ¹æ®mapStateToPropså’ŒmapDispatchToPropsçš„å€¼è®¡ç®—mergeåˆ°ç»„ä»¶propsçš„ç»“æœ</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¸ºtrue ä¼šä¾æ®ç»„ä»¶propsæ˜¯å¦æ”¹å˜æˆ–è€…stateStoreæ˜¯å¦å˜åŒ–ç›¸åº”çš„è®¡ç®—æœ€ç»ˆç»“æœ</span></span><br><span class="line">  <span class="keyword">const</span> selectorFactory = options.<span class="property">pure</span></span><br><span class="line">    ? pureFinalPropsSelectorFactory</span><br><span class="line">    : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">selectorFactory</span>(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch,</span><br><span class="line">    options</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initProxySelectoræ–¹æ³•</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initProxySelector</span>(<span class="params">dispatch, &#123; displayName &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›ä¸€ä¸ªproxyæ–¹æ³• å¸¦æœ‰mapToPropså±æ€§</span></span><br><span class="line">    <span class="comment">// åœ¨é«˜é˜¶ç»„æ”¶é›†statsToPropsæˆ–è€…dispatchToProsçš„æ—¶å€™ä¼šè§¦å‘è¿™ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="keyword">function</span> <span class="title function_">mapToPropsProxy</span>(<span class="params">stateOrDispatch, ownProps</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> proxy.<span class="property">dependsOnOwnProps</span></span><br><span class="line">        ? proxy.<span class="title function_">mapToProps</span>(stateOrDispatch, ownProps)</span><br><span class="line">        : proxy.<span class="title function_">mapToProps</span>(stateOrDispatch)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow detectFactoryAndVerify to get ownProps</span></span><br><span class="line">    proxy.<span class="property">dependsOnOwnProps</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    proxy.<span class="property">mapToProps</span> = <span class="keyword">function</span> <span class="title function_">detectFactoryAndVerify</span>(<span class="params"></span></span><br><span class="line"><span class="params">      stateOrDispatch,</span></span><br><span class="line"><span class="params">      ownProps</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">      <span class="comment">// å°†mapToPropsèµ‹å€¼ç»™proxy.mapToProps è¿™æ ·ä¸‹é¢çš„proxy(stateOrDispatch, ownProps) å®é™…ä¸Šè·‘çš„å°±æ˜¯ä¼ å…¥çš„mapToPropsäº†</span></span><br><span class="line">      proxy.<span class="property">mapToProps</span> = mapToProps</span><br><span class="line">      <span class="comment">// dependsOnOwnPropså±æ€§æ˜¯ä¸ºäº†åé¢é¿å…é‡å¤è®¡ç®—çš„åˆ¤æ–­ä¾æ®ä¹‹ä¸€ ä¹Ÿæ ¹æ®è¿™ä¸ªå±æ€§åˆ¤æ–­æ˜¯å¦éœ€è¦ä¼ å…¥ç»„ä»¶è‡ªèº«çš„propsåˆ°mapStateToPropså’ŒmapDispatchToPropsé‡Œ</span></span><br><span class="line">      proxy.<span class="property">dependsOnOwnProps</span> = <span class="title function_">getDependsOnOwnProps</span>(mapToProps)</span><br><span class="line">      <span class="keyword">let</span> props = <span class="title function_">proxy</span>(stateOrDispatch, ownProps)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ä¸ºäº†é˜²æ­¢ç”¨æˆ·æ‰‹åŠ¨ä½¿ç”¨äº†ç¼“å­˜æœºåˆ¶ åˆ¤æ–­æ˜¯å¦å­˜åœ¨é—­åŒ… åšä¸€å±‚é€’å½’å¤„ç† çŸ¥é“å¾—åˆ°æœ€ç»ˆmapStateToPropså’ŒmapDispatchToPropsè®¡ç®—åçš„å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> props === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶propså°±æ˜¯æ–°çš„mapToPropsæ–¹æ³•</span></span><br><span class="line">        proxy.<span class="property">mapToProps</span> = props</span><br><span class="line">        proxy.<span class="property">dependsOnOwnProps</span> = <span class="title function_">getDependsOnOwnProps</span>(props)</span><br><span class="line">        props = <span class="title function_">proxy</span>(stateOrDispatch, ownProps)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>)</span><br><span class="line">        <span class="title function_">verifyPlainObject</span>(props, displayName, methodName)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> props</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>å›åˆ°Connectçš„æ„é€ å‡½æ•° è¿˜æœ‰ä¸€ä¸ªmakeChildElementSelectoræ–¹æ³•<br>è¿™ä¸ªæ–¹æ³•æ˜¯çš„ä½œç”¨æ˜¯å¯¹ç»„ä»¶è¿›è¡Œç¼“å­˜ åˆ¤æ–­ç»„ä»¶props refå’ŒwrapperComponentè¿”å›æ–°æ—§ç»„ä»¶</p>
<p>ä»¥ä¸Šå°±æ˜¯ç®€è¦çš„ä»‹ç»äº†react-reduxçš„æºç  åç»­è¿˜ä¼šæœ‰è¡¥å……â€¦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/22/react-redux%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" data-id="cm54yagl10008b3hgfhrfhbpj" data-title="react-reduxæºç è§£è¯»" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redux%E3%80%81react-redux/" rel="tag">reduxã€react-redux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-è¯»reduxæºç " class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/20/%E8%AF%BBredux%E6%BA%90%E7%A0%81/" class="article-date">
  <time class="dt-published" datetime="2019-03-20T06:07:53.000Z" itemprop="datePublished">2019-03-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/03/20/%E8%AF%BBredux%E6%BA%90%E7%A0%81/">è¯»reduxæºç </a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Reduxæºç è§£è¯»"><a href="#Reduxæºç è§£è¯»" class="headerlink" title="Reduxæºç è§£è¯»"></a>Reduxæºç è§£è¯»</h3><p>æ—©å°±æƒ³æ‰¾ä¸ªæ—¶é—´çœ‹çœ‹reactå…¨å®¶æ¡¶çš„æºç äº† è¿™æ¬¡å…ˆä»reduxçœ‹èµ·ï¼Œåç»­è¿˜ä¼šæœ‰react-reduxå’Œreact-router-redux</p>
<p>ä¸‹é¢çœ‹ä»£ç <br>ç›®å½•ç»“æ„å¦‚ä¸‹:</p>
<ol>
<li>applyMiddleware.js</li>
<li>bindActionCreator.js</li>
<li>combineReducers.js</li>
<li>compose.js</li>
<li>createStore.js</li>
<li>index.js</li>
</ol>
<p>å…ˆçœ‹å…¥å£æ–‡ä»¶</p>
<h4 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h4><p>å…¥å£æ–‡ä»¶ä¸»è¦æ˜¯æš´éœ²1-5çš„æ ¸å¿ƒæ–¹æ³• ä»£ç å°±ä¸è´´äº†</p>
<h4 id="createStore-js"><a href="#createStore-js" class="headerlink" title="createStore.js"></a>createStore.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reduceræ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ æ¥æ”¶ä¸€ä¸ªå•ç‹¬çš„reduceræˆ–è€…ç»è¿‡combineRedeucersç»„åˆçš„å¤šä¸ªreducer</span></span><br><span class="line"><span class="comment">// preloadedState æ˜¯æŒ‡éœ€è¦æå‰åŠ è½½çš„state ä¼šå’Œå„storeçš„stateä¸€èµ·æ•´åˆåˆ°stateæ ‘é‡Œ</span></span><br><span class="line"><span class="comment">// enhancer æ˜¯storeçš„å¢å¼ºå™¨ ä¸‹é¢ä¼šé‡ç‚¹è®²  ä¼šæ¶‰åŠåˆ°composeå’ŒapplyMiddlewareè¿™ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸ªå‡½æ•° å¹¶ä¸”æ²¡æœ‰ç¬¬ä¸‰ä¸ªå‚æ•° å°±é»˜è®¤æ²¡æœ‰ç©¿preloadedState ç›´æ¥ä¼ äº†å¢å¼ºå™¨å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰å¢å¼ºå™¨ä½†æ˜¯å¢å¼ºå™¨ä¸æ˜¯å‡½æ•° æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the enhancer to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜åœ¨å‡½æ•°ç±»å‹çš„å¢å¼ºå™¨å°±è¿”å›æ‰§è¡Œå¢å¼ºå™¨æ‰§è¡Œåçš„ç»“æœ</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯ä»¥æ¨æµ‹å‡ºå¢å¼ºå™¨çš„å‡½æ•°ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„</span></span><br><span class="line">    <span class="comment">// const enhancer = createStore =&gt; (reducer, preloadedState, enhancer) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//   const store = createStore(reducer, preloadedState, enhancer)</span></span><br><span class="line">    <span class="comment">//   return &#123;</span></span><br><span class="line">    <span class="comment">//     ...store,</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥å¯ä»¥çŒœæµ‹enhanceræ˜¯ä¸ºäº†é€šè¿‡è¦†ç›–è¾¾åˆ°å¢å¼ºstoreçš„æŸä¸€ä¸ªå±æ€§  ä¸‹é¢å†ç»†è¯´</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">enhancer</span>(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœreducerä¸æ˜¯å‡½æ•° æŠ›å¼‚å¸¸</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> reducer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the reducer to be a function.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> currentReducer = reducer</span><br><span class="line">  <span class="comment">// å½“å‰çš„stateæ ‘</span></span><br><span class="line">  <span class="keyword">let</span> currentState = preloadedState</span><br><span class="line">  <span class="comment">// è¿™é‡Œä¸ºä»€ä¹ˆè¯å£°æ˜ä¸¤ä¸ªç›‘å¬é˜Ÿåˆ—å‘¢ï¼Ÿ</span></span><br><span class="line">  <span class="comment">// ä½œè€…æ˜¯ä¸ºäº†åœ¨dispatchçš„æ—¶å€™èƒ½å¤Ÿå®Œæ•´çš„æ‰§è¡Œæ‰€æœ‰çš„äº‹ä»¶ç›‘å¬ </span></span><br><span class="line">  <span class="comment">// æœ‰äººè¯•éªŒè¿‡ åœ¨ä¸€ä¸ªç›‘å¬é‡Œé¢å–æ¶ˆå¦ä¸€ä¸ªç›‘å¬ è¿™ä¸ªä¸€ä¸ªæ— æ•ˆæ“ä½œ  feature or bug???</span></span><br><span class="line">  <span class="keyword">let</span> currentListeners = []</span><br><span class="line">  <span class="keyword">let</span> nextListeners = currentListeners</span><br><span class="line">  <span class="comment">// æ˜¯å¦æ­£åœ¨dispatchè¿‡ç¨‹</span></span><br><span class="line">  <span class="keyword">let</span> isDispatching = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¡®ä¿nextListeners å’Œ currentListenersæ²¡æœ‰å¼•ç”¨å…³ç³»</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">ensureCanMutateNextListeners</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.<span class="title function_">slice</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™ä¸ªæ˜¯è·å–åˆ°æœ€æ–°stateå†…å®¹</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.getState() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;The reducer has already received the state as an argument. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Pass it down from the top reducer instead of reading it from the store.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è¿™ä¸ªsubscribeæ˜¯ä¸ºäº†ç»™currentListenerå¢åŠ ç›‘å¬äº‹ä»¶ ä¸‹é¢çš„dispatchå‡½æ•°ä¸­ åœ¨æ‰§è¡Œå®Œdispatchæ“ä½œå ä¼šéå†è¿™ä¸ªç›‘å¬é˜Ÿåˆ—ä¾æ¬¡è®¢é˜…çš„ç›‘å¬äº‹ä»¶</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the listener to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿è¯ä¸èƒ½å†dispatchçš„è¿‡ç¨‹ä¸­è§¦å‘ç›‘å¬äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.subscribe() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;If you would like to be notified after the store has been updated, subscribe from a &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;component and invoke store.getState() in the callback to access the latest state. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribe(listener) for more details.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">    <span class="comment">// ç›‘å¬äº‹ä»¶å…¥æ ˆ</span></span><br><span class="line">    nextListeners.<span class="title function_">push</span>(listener)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™ç§å†™æ³•è¿˜æ˜¯æ¯”è¾ƒå¸¸è§ä¸”å¦™çš„ æ·»åŠ ç›‘å¬äº‹ä»¶å é€šè¿‡é—­åŒ…è¿”å›ä¸€ä¸ªç§»é™¤å½“å‰ç›‘å¬äº‹ä»¶çš„æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// ç”¨æ³•å¦‚ä¸‹</span></span><br><span class="line">    <span class="comment">// const store = createStore(...)</span></span><br><span class="line">    <span class="comment">// const subscribe = store.subscribe(() =&gt; &#123;&#125;)</span></span><br><span class="line">    <span class="comment">// ç§»é™¤åªéœ€è¦æ‰§è¡Œsubscribe()å°±è¡Œäº†</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœè¯¥ç›‘å¬è¢«å–æ¶ˆ</span></span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ— æ³•å†dispatchè¿‡ç¨‹ä¸­ç§»é™¤ç›‘å¬äº‹ä»¶</span></span><br><span class="line">      <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">          <span class="string">&#x27;You may not unsubscribe from a store listener while the reducer is executing. &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribe(listener) for more details.&#x27;</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç›‘å¬å–æ¶ˆçš„æ ‡å¿—</span></span><br><span class="line">      isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">      <span class="keyword">const</span> index = nextListeners.<span class="title function_">indexOf</span>(listener)</span><br><span class="line">      <span class="comment">// ç›‘å¬äº‹ä»¶ç§»é™¤</span></span><br><span class="line">      nextListeners.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯ä¸ªredux middlewareéƒ½æ˜¯ä¸€ä¸ªå¯¹dispatchçš„ä¸€ä¸ªå¢å¼º</span></span><br><span class="line">  <span class="comment">// æ˜¯reduxçš„dispatchæ–¹æ³• ä¹Ÿæ˜¯é¡µé¢ä¿®æ”¹æ ‘çŠ¶æ€çš„å”¯ä¸€é€”å¾„</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆåˆ¤æ–­actionæ˜¯ä¸æ˜¯ä¸€ä¸ªçº¯å¯¹è±¡ å³é€šè¿‡&#123;&#125;æˆ–è€…new Object()åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(action)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Actions must be plain objects. &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;Use custom middleware for async actions.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¿è¯æ¯ä¸ªactionå¿…é¡»æœ‰typeå±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action.<span class="property">type</span> === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Actions may not have an undefined &quot;type&quot; property. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Have you misspelled a constant?&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸€ä¸ªactionç»“æŸæ‰èƒ½è°ƒç”¨ä¸‹ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Reducers may not dispatch actions.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      <span class="comment">// è¿™æ˜¯æ‰§è¡Œreducerçš„å‡½æ•° ä¸‹é¢è®²åˆ°combineReducersçš„æ—¶å€™å†é‡ç‚¹è®²</span></span><br><span class="line">      currentState = <span class="title function_">currentReducer</span>(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†è§¦å‘subscribeæ·»åŠ çš„ç›‘å¬</span></span><br><span class="line">    <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      <span class="title function_">listener</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›¿æ¢å½“å‰reducer è¿™ä¸ªåªåœ¨çƒ­æ›´æ–°ä¸Šç”¨è¿‡</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">replaceReducer</span>(<span class="params">nextReducer</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the nextReducer to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">REPLACE</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™ä¸ªå¾…çœ‹ æš‚æ—¶ä¸çŸ¥é“æ˜¯å¹²å˜›çš„</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">observable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> outerSubscribe = subscribe</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * The minimal observable subscription method.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; observer Any object that can be used as an observer.</span></span><br><span class="line"><span class="comment">       * The observer object should have a `next` method.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@returns</span> &#123;<span class="type">subscription</span>&#125; An object with an `unsubscribe` method that can</span></span><br><span class="line"><span class="comment">       * be used to unsubscribe the observable from the store, and prevent further</span></span><br><span class="line"><span class="comment">       * emission of values from the observable.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="title function_">subscribe</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> observer !== <span class="string">&#x27;object&#x27;</span> || observer === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Expected the observer to be an object.&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">observeState</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (observer.<span class="property">next</span>) &#123;</span><br><span class="line">            observer.<span class="title function_">next</span>(<span class="title function_">getState</span>())</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">observeState</span>()</span><br><span class="line">        <span class="keyword">const</span> unsubscribe = <span class="title function_">outerSubscribe</span>(observeState)</span><br><span class="line">        <span class="keyword">return</span> &#123; unsubscribe &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      [$$observable]() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–store</span></span><br><span class="line">  <span class="comment">// æ”¶é›†æ¯ä¸ªç‹¬ç«‹storeä¸Šçš„state  å› ä¸ºæ¯ä¸ªstoreéƒ½defaultè¿”å›è‡ªèº«çš„state</span></span><br><span class="line">  <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">INIT</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer,</span><br><span class="line">    [$$observable]: observable</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹combineReducersåšäº†ä»€ä¹ˆ</p>
<h4 id="combineReducers-js"><a href="#combineReducers-js" class="headerlink" title="combineReducers.js"></a>combineReducers.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çœ‹è¿™ä¸ªæ–‡ä»¶åå­—å°±çŸ¥é“æ˜¯ä¸€ä¸ªç»„åˆå¤šä¸ªreducerçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">// reducersçš„ç»“æ„å¦‚ä¸‹</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* &#123;</span></span><br><span class="line"><span class="comment">*   demo1: function(state, action) &#123;</span></span><br><span class="line"><span class="comment">*     switch(action.type) &#123;&#125;</span></span><br><span class="line"><span class="comment">*   &#125;,</span></span><br><span class="line"><span class="comment">*   demo2: function(state, action) &#123;</span></span><br><span class="line"><span class="comment">*     switch(action.type) &#123;&#125;</span></span><br><span class="line"><span class="comment">*   &#125;,</span></span><br><span class="line"><span class="comment">* &#125;</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">combineReducers</span>(<span class="params">reducers</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warning</span>(<span class="string">`No reducer provided for key &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¿è¯æ¯ä¸ªreducerå¯¹åº”çš„valueéƒ½æ˜¯å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unexpectedKeyCache</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> shapeAssertionError</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ºäº†ä¿è¯æ¯ä¸ªè‡ªå®šä¹‰reducerè‡³å°‘æœ‰ä¸€ä¸ªåˆå§‹çš„stateå’Œå…œåº•è¿”å›å€¼</span></span><br><span class="line">    <span class="title function_">assertReducerShape</span>(finalReducers)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;s</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™ä¸€æ­¥æ‰æ˜¯é‡ç‚¹</span></span><br><span class="line">  <span class="comment">// è¿”å›createStore/dispatchæ–¹æ³•ä¸­æœ‰ä¸€è¡Œ: currentState = currentReducer(currentState, action)</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£ä¿®æ”¹çŠ¶æ€æ ‘çš„æ–¹æ³•</span></span><br><span class="line">  <span class="comment">// combinationæ–¹æ³•ä¼šéå†ä¼ è¿›æ¥çš„å¤šä¸ªreducersç»„æˆçš„å¯¹è±¡ ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªreducer å¾—åˆ°æ¯ä¸ªreducerç›¸åº”çš„state</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">combination</span>(<span class="params">state = &#123;&#125;, action</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> warningMessage = <span class="title function_">getUnexpectedStateShapeWarningMessage</span>(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (warningMessage) &#123;</span><br><span class="line">        <span class="title function_">warning</span>(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯æ¬¡dispatchçš„éƒ½ä¼šéå†reduceræ ‘è®©æ¯ä¸ªå°reduceræ‰§è¡Œè¿™ä¸ªaction</span></span><br><span class="line">    <span class="comment">// ä¿è¯æ¯æ¬¡dispatch éƒ½æ˜¯æ ¹æ®ä¸Šæ¬¡çš„stateè¿›è¡Œæ“ä½œçš„</span></span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = <span class="title function_">reducer</span>(previousStateForKey, action)</span><br><span class="line">      <span class="comment">// è¯¥typeæ²¡æœ‰å®šä¹‰ æŠ›å¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> errorMessage = <span class="title function_">getUndefinedStateErrorMessage</span>(key, action)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹å®Œä»¥ä¸Šä»£ç æˆ‘ä»¬å…ˆä¸¾ä¸ªå°ä¾‹å­ä»‹ç»ä¸€ä¸‹enhanceråˆ°åº•æ˜¯ä½•æ–¹ç¥åœ£</p>
<ol>
<li>touch index.js</li>
<li>å¼€å§‹å†™demo</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createStore, combineReducers, applyMiddleware, compose &#125; = <span class="built_in">require</span>(<span class="string">&#x27;redux&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count1</span>(<span class="params">state = initialState, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(count1)</span><br><span class="line"><span class="keyword">const</span> action1 = &#123; <span class="attr">type</span>: <span class="string">&#x27;ADD&#x27;</span> &#125;</span><br><span class="line">store.<span class="title function_">dispatch</span>(action1)</span><br><span class="line"><span class="comment">// æˆ‘ä»¬æ‰“å°store.getStore()</span></span><br><span class="line"><span class="comment">// ç»“æœæ˜¯ &#123; count1: &#123; count: 2 &#125; &#125;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* ä¸Šé¢æ˜¯reduxçš„åŸºæœ¬ä½¿ç”¨ æˆ‘ä»¬ä¸»è¦è®²çš„æ˜¯storeå¢å¼ºå™¨</span></span><br><span class="line"><span class="comment">* ä»¥ä¸Šä¹Ÿæœ‰æåˆ°å¢å¼ºå™¨çš„ä¸»è¦ç»“æ„</span></span><br><span class="line"><span class="comment">* æˆ‘ä»¬å†åšä¸ªå°demo</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™æ˜¯ä¸€ä¸ªæ¯æ¬¡dispatchå‰åæ‰“å°æ—¥å¿—çš„å¢å¼ºå™¨</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loggerEnhancer</span> = createStore =&gt; <span class="function">(<span class="params">reducer, proloadedState</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> store = <span class="title function_">createStore</span>(reducer, proloadedState)</span><br><span class="line">  <span class="comment">// é‡å†™dispatchæ–¹æ³• æˆ–è€…è¯´æ˜¯åœ¨åŸæœ‰çš„dispatchä¸ŠåŒ…äº†ä¸€å±‚</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dispatch action type: <span class="subst">$&#123;action.type&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> _action = store.<span class="title function_">dispatch</span>(action)</span><br><span class="line">    <span class="keyword">const</span> nextState = store.<span class="title function_">getState</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;new state is:&#x27;</span>, nextState)</span><br><span class="line">    <span class="comment">// åŸæ¥çš„dispatchå°±æ˜¯ä¸ªçº¯å‡½æ•°  æ‰€ä»¥è¿™é‡Œçš„_actionå°±æ˜¯å…¥å‚action</span></span><br><span class="line">    <span class="keyword">return</span> _action</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...store,</span><br><span class="line">    dispatch,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> storeWithLogger = <span class="title function_">createStore</span>(count1, loggerEnhancer)</span><br><span class="line">storeWithLogger.<span class="title function_">dispatch</span>(action1)</span><br><span class="line"><span class="comment">// è¿™æ ·åœ¨dispatchçš„æ—¶å€™å°±ä¼šå‡ºç°æˆ‘ä»¬çš„loggerå†…å®¹</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å†™åˆ°è¿™å„¿çš„æ—¶å€™æˆ‘åœ¨æƒ³ å’¦ è¿™ç©æ„å„¿æ€ä¹ˆå’Œreduxä¸­é—´ä»¶è¿™ä¹ˆåƒ è‚¯å®šcomposeå’ŒapplyMiddlewareæœ‰å…³ç³»</span></span><br><span class="line"><span class="comment">// å¥½å¥‡å¿ƒé©±ä½¿ä¸‹ å»çœ‹äº†composeå’ŒapplyMiddleware</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€æˆ‘ä»¬çœ‹çœ‹composeå’ŒapplyMiddlewareåšäº†ä»€ä¹ˆå§~</p>
<h4 id="compose-js"><a href="#compose-js" class="headerlink" title="compose.js"></a>compose.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">compose</span>(<span class="params">...funcs</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> funcs.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">a</span>(<span class="title function_">b</span>(...args)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>composeçš„ä»£ç å¾ˆå°‘ é€šè¿‡reduceæ–¹æ³•å°†å„ä¸­é—´ä»¶å½¢æˆä¸€ä¸ªæ‰§è¡Œé“¾ å‰ä¸€ä¸ªä¸­é—´ä»¶å¥—åœ¨åä¸€ä¸ªçš„å¤–å±‚ å¹¶æ¥å—åä¸€ä¸ªå‡½æ•°çš„æ‰§è¡Œç»“æœä½œä¸ºè‡ªå·±çš„å…¥å‚<br>ä¸¾ä¸ªæ —å­å§</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> b = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="title function_">compose</span>([a, b, c])</span><br><span class="line"><span class="comment">// å…ˆå¤„ç†aå’Œb è¿”å› </span></span><br><span class="line"><span class="keyword">const</span> ab = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">a</span>(<span class="title function_">b</span>(...args))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å†å¤„ç†abå’Œc è¿”å› </span></span><br><span class="line"><span class="keyword">const</span> abc = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">ab</span>(<span class="title function_">c</span>(...args))</span><br><span class="line">  <span class="comment">// è¿™ä¸ªc(...args)æ‰§è¡Œç»“æœå°±æ˜¯abçš„å…¥å‚</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¢ä¸ªå†™æ³•</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">a</span>(<span class="title function_">b</span>(<span class="title function_">c</span>(...args)))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¢è€Œè¨€ä¹‹composeçš„è¿”å›å€¼å°±æ˜¯ (...args) =&gt; a(b(c(...args))) </span></span><br></pre></td></tr></table></figure>

<h4 id="applyMiddleware-js"><a href="#applyMiddleware-js" class="headerlink" title="applyMiddleware.js"></a>applyMiddleware.js</h4><p>æˆ‘ä»¬çœ‹çœ‹applyMiddlewareæ˜¯æ€ä¹ˆå®ç°çš„ æ‰¾æ‰¾ä»–æ˜¯æ€ä¹ˆé€šè¿‡composeç»„åˆæˆenhancerçš„</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çœ‹åˆ°è¿™æ®µä»£ç  æˆ‘è§‰å¾—çŒœæµ‹æ˜¯å¯¹çš„ æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒä¸Šé¢çš„loggerEnhancerçš„ç»“æ„ é‡å†™dispatchæ–¹æ³•</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥å¾—å‡ºç»“è®º ä¸å…¶è¯´å¢å¼ºå™¨æ˜¯å¯¹storeçš„å¢å¼ºä¸å¦‚è¯´æ˜¯å¯¹dispatchçš„å¢å¼º</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">applyMiddleware</span>(<span class="params">...middlewares</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„...argsæ˜¯ reducersã€preloadedStateã€enhancer</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">createStore</span>(...args)</span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">dispatch</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`Dispatching while constructing your middleware is not allowed. `</span> +</span><br><span class="line">          <span class="string">`Other middleware would not be applied to this dispatch.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      <span class="attr">getState</span>: store.<span class="property">getState</span>,</span><br><span class="line">      <span class="attr">dispatch</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">dispatch</span>(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.<span class="title function_">map</span>(<span class="function"><span class="params">middleware</span> =&gt;</span> <span class="title function_">middleware</span>(middlewareAPI))</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„composeçš„ä½œç”¨æ˜¯åŒ…è£¹æ‰€æœ‰dispatchæ“ä½œ</span></span><br><span class="line">    dispatch = <span class="title function_">compose</span>(...chain)(store.<span class="property">dispatch</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†å†™ä¸ªä½¿ç”¨applyMiddlewareå°demo é€šè¿‡demoæˆ‘ä»¬å†è¿›è¡Œè®¾æƒ³</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createStore, applyMiddleware, compose &#125; = <span class="built_in">require</span>(<span class="string">&#x27;redux&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count1</span>(<span class="params">state = initialState, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(count1, <span class="title function_">applyMiddleware</span>(fn1, fn2))</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šé¢ä¸¤ä¸ªfn1å’Œfn2æˆ‘ä»¬éƒ½æ²¡å®šä¹‰ ç°åœ¨æˆ‘ä»¬æ ¹æ®applyMiddlewareçŒœæµ‹ä¸€ä¸‹fn1å’Œfn2æ˜¯å•¥æ ·å­çš„</span></span><br><span class="line"><span class="comment">// æ ¹æ®loggerEnhancerçš„è®¾æƒ³ </span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">enhancer</span> = createStore =&gt; <span class="function">(<span class="params">reducers, preloadedState, enhancer</span>) =&gt;</span> &#123;&#125; </span><br><span class="line"><span class="comment">// applyMiddlewareä¹Ÿåº”è¯¥æ˜¯è¿™æ ·çš„å‡½æ•°ä½“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chain = middlewares.<span class="title function_">map</span>(<span class="function"><span class="params">middleware</span> =&gt;</span> <span class="title function_">middleware</span>(middlewareAPI))</span><br><span class="line"><span class="comment">// è¿™è¡Œä»£ç å¯ä»¥çœ‹å‡º fn1çš„é›å½¢ åº”è¯¥æ˜¯è¿™æ ·çš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = (<span class="params">&#123; dispatch, getState &#125;</span>) =&gt; &#123;&#125;</span><br><span class="line"><span class="comment">// ä½†æ˜¯é€šè¿‡composeæ–¹æ³•è¿˜èƒ½æ¥å—store.dispatchä½œä¸ºå…¥å‚ è¯´æ˜fn1åº”è¯¥æ˜¯è¿™æ ·çš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = (<span class="params">&#123; dispatch, getState &#125;</span>) =&gt; <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="comment">// é€šè¿‡è¿”å›çš„æ˜¯ä¸€ä¸ªdispatch æˆ‘å¯ä»¥çŸ¥é“fn1åŸæ¥æ˜¯è¿™æ ·çš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = (<span class="params">&#123; dispatch, getState &#125;</span>) =&gt; <span class="function"><span class="params">dispatch</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="comment">// ä¸¾ä¸ªæ —å­</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">a</span> = dispatch =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">b</span> = dispatch =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="comment">// compose([a, b])çš„ç»“æœä¸º (...args) =&gt; a(b(...args))</span></span><br><span class="line"><span class="comment">// compose([a, b])(store.dispatch) ç»“æœä¸º a(b(dispatch)) å†åšç®€åŒ–å°±æ˜¯a(action =&gt; &#123;&#125;)</span></span><br><span class="line"><span class="comment">// ä»è¿™é‡Œå¯ä»¥çœ‹å‡º aæ‰§è¡Œçš„dispatchå…¶å®å°±æ˜¯ b(dispatch)çš„ç»“æœ </span></span><br><span class="line"><span class="comment">// å¦‚æœè¿˜æœ‰c cæ‰§è¡Œdispatchå°±æ˜¯a(dispatch) ä»è€Œè¾¾åˆ°ä¸­é—´ä»¶çš„ä½œç”¨</span></span><br><span class="line"><span class="comment">// aæ‰§è¡Œçš„dispatchå°±æ˜¯dispatch</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸¾ä¸ªæ›´ç¡®åˆ‡çš„æ —å­</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;next1&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>(action)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn2</span> = store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;next2&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>(action)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* åœ¨æ‰§è¡ŒapplyMiddlewareæ—¶  æ‰§è¡Œäº†compose(...chain)(store.sidpatch) æ‰§è¡Œé¡ºåºæ˜¯ next2 ã€ next1  è¿™æ˜¯ä¸­é—´ä»¶å…¥æ ˆçš„é¡ºåº</span></span><br><span class="line"><span class="comment">* ä½†æ˜¯è°ƒç”¨çš„é¡ºåºä¸ä¸€æ ·  æœ‰å…´è¶£å¯ä»¥äº†è§£ä¸€ä¸‹æ´‹è‘±æ¨¡å‹</span></span><br><span class="line"><span class="comment">* æ‰§è¡Œstore.dispatch(action1) å®é™…æ‰“å°é¡ºåºæ˜¯ fn1ã€fn2ã€fn2ã€fn1</span></span><br><span class="line"><span class="comment">* fn2åœ¨ä¼ å…¥store.dispatchçš„æ—¶å€™ ä¼šå°†</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">dispatchFromStore</span> = action =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">  <span class="title function_">next</span>(action)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* å½“åšè¿”å›å€¼ä¼ ç»™fn1çš„next</span></span><br><span class="line"><span class="comment">* é‚£fn1çš„æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">dispatchFromFn2</span> = action =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">  <span class="title function_">dispatchFromStore</span>(action)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰€ä»¥æ‰“å°é¡ºåºæ˜¯fn1ã€fn2ã€fn2ã€fn1å°±ä¸å¥‡æ€ªäº†</span></span><br></pre></td></tr></table></figure>

<h4 id="bindActionCreators-js"><a href="#bindActionCreators-js" class="headerlink" title="bindActionCreators.js"></a>bindActionCreators.js</h4><p>è¿™ä¸ªæ–‡ä»¶æ²¡æœ‰è¢«ä¸»å‡½æ•°ç”¨åˆ° æ˜¯è¢«æš´éœ²ç»™å¼€å‘è€…ä½¿ç”¨çš„ä¸€ä¸ªå·¥å…·å‡½æ•° ç”¨æ¥æ›´æ–¹ä¾¿çš„ç»„åˆä½ çš„action</p>
<h4 id="createStore-observeræ–¹æ³•"><a href="#createStore-observeræ–¹æ³•" class="headerlink" title="createStore&#x2F;observeræ–¹æ³•"></a>createStore&#x2F;observeræ–¹æ³•</h4><p>è¿™ä¸ªæ–¹æ³•ä¸Šé¢æ²¡æœ‰è®²åˆ° ä¹Ÿæ˜¯æš´éœ²ç»™å¼€å‘è€…çš„API æˆ‘ä»¬æ”¾åˆ°ä»¥åè®²</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>è¿™ä¸€éè¿‡ä¸‹æ¥åŸºæœ¬å°±èƒ½ç†Ÿç»ƒä½¿ç”¨reduxçš„å¤§éƒ¨åˆ†ç‰¹æ€§äº† ä¹Ÿæ„Ÿå¹ä»£ç çš„ç²¾å¦™ å°¤å…¶æ˜¯ç»„åˆä¸­é—´ä»¶çš„ä»£ç  nb~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/20/%E8%AF%BBredux%E6%BA%90%E7%A0%81/" data-id="cm54yagl70017b3hg8h1f88kl" data-title="è¯»reduxæºç " class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redux%E3%80%81react/" rel="tag">reduxã€react</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-vuexçš„takeLateståŒ–" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/19/vuex%E7%9A%84takeLatest%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2019-03-19T05:04:04.000Z" itemprop="datePublished">2019-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/03/19/vuex%E7%9A%84takeLatest%E5%8C%96/">vuexçš„takeLateståŒ–</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="vuexå¼‚æ­¥è°ƒç”¨çš„takeLateståŒ–-è®°ä¸€æ¬¡é¡¹ç›®ä¸­é‡åˆ°çš„å°é—®é¢˜"><a href="#vuexå¼‚æ­¥è°ƒç”¨çš„takeLateståŒ–-è®°ä¸€æ¬¡é¡¹ç›®ä¸­é‡åˆ°çš„å°é—®é¢˜" class="headerlink" title="vuexå¼‚æ­¥è°ƒç”¨çš„takeLateståŒ–(è®°ä¸€æ¬¡é¡¹ç›®ä¸­é‡åˆ°çš„å°é—®é¢˜)"></a>vuexå¼‚æ­¥è°ƒç”¨çš„takeLateståŒ–(è®°ä¸€æ¬¡é¡¹ç›®ä¸­é‡åˆ°çš„å°é—®é¢˜)</h3><ul>
<li><p>å‰è¨€: ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°takeLatestæ˜¯åœ¨redux-saga, åŒ…æ‹¬takeLatest&#x2F;takeEveryç­‰</p>
</li>
<li><p>é—®é¢˜æè¿°: åœ¨ä¸€ä¸ªæœ‰å¤šçº§å“ç±»é€‰æ‹©çš„é¡µé¢ ç‚¹å‡»ä¸€ä¸ªæ ‡ç­¾æŸ¥è¯¢ä¸€æ¬¡<br>åç«¯æ¥å£åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹æŸ¥è¯¢æ—¶é—´å¯èƒ½æ¯”è¾ƒæ…¢ å¹¶ä¸”æ¥å£çš„è¿”å›é¡ºåºä¸ä¸€å®šæ˜¯å‰ç«¯é¡µé¢è°ƒç”¨çš„é¡ºåº<br>è¿™ä¸ªé—®é¢˜å›°æ‰°äº†å¾ˆä¹… è§£å†³åŠæ³•æœ‰ä»¥ä¸‹å‡ ç§</p>
<blockquote>
<ol>
<li>è·Ÿäº§å“æ²Ÿé€šï¼Œç”¨æˆ·æ¯é€‰æ‹©ä¸€ä¸ªå“ç±»ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®ï¼Œå¹¶æä¾›loadingè’™å±‚ ä½¿ç”¨æˆ·æ²¡æ³•åœ¨æ•°æ®æœªè¿”å›ä¹‹å‰ç»§ç»­æ“ä½œ</li>
<li>å‰ç«¯å‚æ•°hashåŒ– å°†è¯·æ±‚å‚æ•°hashåŒ– å°†é¡µé¢æ‰€æœ‰è¯·æ±‚çš„æ•°æ®é€šè¿‡å‚æ•°çš„hashå€¼ä¿å­˜åœ¨store é€šè¿‡getterå¾—åˆ°æœ¬æ¬¡hashå¯¹åº”çš„æ•°æ®</li>
</ol>
</blockquote>
</li>
<li><p>ä»¥ä¸Šä¸¤ç§æ–¹æ³• éƒ½å¾ˆéº»çƒ¦ ç¬¬ä¸€ä¸ªæ˜¯éœ€è¦æ›´æ¢ç”¨æˆ·ä½“éªŒ ç¬¬äºŒä¸ªä¼šå­˜å‚¨å¾ˆå¤šä¸éœ€è¦çš„æ•°æ® ä¸”åœ¨ç‰¹å®šåœºæ™¯ä¸‹å¯èƒ½ä¼šé€ æˆæ€§èƒ½é—®é¢˜</p>
</li>
<li><p>äºæ˜¯å‚è€ƒäº†redux-sagaçš„takeLatestå®ç°ä¸€ä¸‹ä»£ç </p>
</li>
</ul>
<h4 id="ä»£ç å¦‚ä¸‹"><a href="#ä»£ç å¦‚ä¸‹" class="headerlink" title="ä»£ç å¦‚ä¸‹"></a>ä»£ç å¦‚ä¸‹</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">takeLatest</span>(<span class="params">action</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastRun = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">async</span> (context, payload) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ç”¨æˆ·æ¯æ¬¡ç‚¹å‡»è¿›æ¥éƒ½ä¼šå°†å½“å‰æ—¶é—´èµ‹çµ¦lastRun</span></span><br><span class="line">    <span class="keyword">const</span> currentRun = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    lastRun = currentRun</span><br><span class="line">    <span class="keyword">const</span> &#123; commit, dispatch &#125; = context</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">commitLatest</span> = (<span class="params">...args</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastRun !== currentRun) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;ActionOutdatedError&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">commit</span>(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">dispatchLatest</span> = (<span class="params">...args</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastRun !== currentRun) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;ActionOutdatedError&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">dispatch</span>(...args)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">action</span>(&#123;</span><br><span class="line">        ...context,</span><br><span class="line">        <span class="attr">commit</span>: commitLatest,</span><br><span class="line">        <span class="attr">dispatch</span>: dispatchLatest,</span><br><span class="line">      &#125;, payload)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.<span class="property">message</span> === <span class="string">&#x27;ActionOutdatedError&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">/* eslint-ignore */</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;actions aborted, latest action work&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ¥å£å±‚æŠ¥é”™æŠ›å‡º</span></span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">actions</span>: &#123;</span><br><span class="line"> <span class="attr">getData</span>: <span class="title function_">takeLatest</span>(<span class="comment">/*å‚æ•°ä¸ºè¯·æ±‚å‡½æ•°*/</span></span><br><span class="line">  <span class="title function_">async</span> (&#123; commit &#125;, payload) =&gt; &#123;</span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"> ), </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="å¦‚æœæˆ‘ä¸ç”¨vuexæ€ä¹ˆåŠå‘¢ï¼Ÿ"><a href="#å¦‚æœæˆ‘ä¸ç”¨vuexæ€ä¹ˆåŠå‘¢ï¼Ÿ" class="headerlink" title="å¦‚æœæˆ‘ä¸ç”¨vuexæ€ä¹ˆåŠå‘¢ï¼Ÿ"></a>å¦‚æœæˆ‘ä¸ç”¨vuexæ€ä¹ˆåŠå‘¢ï¼Ÿ</h3><p>å½“ç„¶åœ¨é¡µé¢ä¸Šä½¿ç”¨ä¹Ÿæ˜¯ä¸€æ ·çš„ å”¯ä¸€ä¸åŒçš„æ˜¯åœ¨é¡µé¢ä¸Šæˆ‘ä»¬éœ€è¦è€ƒè™‘åšä¸‹thisçš„æŒ‡å‘é—®é¢˜</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">takeLatest</span>(<span class="params">action, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> latest = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    latest = current</span><br><span class="line">    <span class="keyword">const</span> context = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> commit = <span class="keyword">function</span> (<span class="params">...commitArgs</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (current !== latest) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;actionTakeLatest&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> cb.<span class="title function_">apply</span>(context, commitArgs)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> action.<span class="title function_">call</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">        <span class="attr">originArgs</span>: args,</span><br><span class="line">        commit,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.<span class="property">message</span> === <span class="string">&#x27;actionTakeLatest&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;action aborted&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸ªå°demo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123; text &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;button @click=&quot;handleClick&quot;&gt;ç‚¹å‡»æµ‹è¯•takeLatest&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      text: &#x27;&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    /* takeLatestçš„å‚æ•°å°½é‡ä¸è¦æ˜¯ä½¿ç”¨ç®­å¤´å‡½æ•° å› ä¸ºç®­å¤´å‡½æ•°ä¸€æ—¦å®šä¹‰thiså°±å·²ç»ç¡®å®šäº† */</span><br><span class="line">    handleClick: takeLatest(</span><br><span class="line">      async function (&#123; originArgs, commit &#125;) &#123;</span><br><span class="line">        const res = await new Promise(resolve =&gt; setTimeout(() =&gt; resolve(Math.random()), Math.floor(Math.random() * 5000)))</span><br><span class="line">        commit(res)</span><br><span class="line">      &#125;,</span><br><span class="line">      function (payload)&#123;</span><br><span class="line">         this.text = payload</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/19/vuex%E7%9A%84takeLatest%E5%8C%96/" data-id="cm54yagl3000hb3hg5qeddm5g" data-title="vuexçš„takeLateståŒ–" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vuex%E3%80%81takeLatest/" rel="tag">vuexã€takeLatest</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; zurÃ¼ck</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/React%E3%80%81SSR/" rel="tag">Reactã€SSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue2-x%E3%80%81%E6%8C%87%E4%BB%A4%E3%80%81v-model/" rel="tag">Vue2.xã€æŒ‡ä»¤ã€v-model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Watcher%E7%AF%87/" rel="tag">Watcherç¯‡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker%E3%80%81node/" rel="tag">dockerã€node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab-ci/" rel="tag">gitlab-ci</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js%E3%80%81es6/" rel="tag">jsã€es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvvm/" rel="tag">mvvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs-%E9%94%81-%E5%B9%B6%E5%8F%91/" rel="tag">nodejs é” å¹¶å‘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qiankun%E3%80%81micro-frontend/" rel="tag">qiankunã€micro-frontend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" rel="tag">react ref ç¬”è®°</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redux%E3%80%81react/" rel="tag">reduxã€react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redux%E3%80%81react-redux/" rel="tag">reduxã€react-redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue2-x%E3%80%81Observer%E3%80%81Dep%E3%80%81Watcher%E3%80%81%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" rel="tag">vue2.xã€Observerã€Depã€Watcherã€ä¸ªäººç¬”è®°</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuex%E3%80%81takeLatest/" rel="tag">vuexã€takeLatest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue%E3%80%81lazyload/" rel="tag">vueã€lazyload</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue%E3%80%81%E7%AC%94%E8%AE%B0/" rel="tag">vueã€ç¬”è®°</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/React%E3%80%81SSR/" style="font-size: 10px;">Reactã€SSR</a> <a href="/tags/Vue2-x%E3%80%81%E6%8C%87%E4%BB%A4%E3%80%81v-model/" style="font-size: 10px;">Vue2.xã€æŒ‡ä»¤ã€v-model</a> <a href="/tags/Watcher%E7%AF%87/" style="font-size: 10px;">Watcherç¯‡</a> <a href="/tags/docker%E3%80%81node/" style="font-size: 20px;">dockerã€node</a> <a href="/tags/gitlab-ci/" style="font-size: 10px;">gitlab-ci</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/js%E3%80%81es6/" style="font-size: 10px;">jsã€es6</a> <a href="/tags/mvvm/" style="font-size: 10px;">mvvm</a> <a href="/tags/nodejs-%E9%94%81-%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">nodejs é” å¹¶å‘</a> <a href="/tags/qiankun%E3%80%81micro-frontend/" style="font-size: 10px;">qiankunã€micro-frontend</a> <a href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">react ref ç¬”è®°</a> <a href="/tags/redux%E3%80%81react/" style="font-size: 10px;">reduxã€react</a> <a href="/tags/redux%E3%80%81react-redux/" style="font-size: 10px;">reduxã€react-redux</a> <a href="/tags/vue/" style="font-size: 10px;">vue</a> <a href="/tags/vue2-x%E3%80%81Observer%E3%80%81Dep%E3%80%81Watcher%E3%80%81%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">vue2.xã€Observerã€Depã€Watcherã€ä¸ªäººç¬”è®°</a> <a href="/tags/vuex%E3%80%81takeLatest/" style="font-size: 10px;">vuexã€takeLatest</a> <a href="/tags/vue%E3%80%81lazyload/" style="font-size: 10px;">vueã€lazyload</a> <a href="/tags/vue%E3%80%81%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">vueã€ç¬”è®°</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/06/electron%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">Electronä½¿ç”¨æ•™ç¨‹</a>
          </li>
        
          <li>
            <a href="/2020/12/18/%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81/">æ‚²è§‚é”/ä¹è§‚é”</a>
          </li>
        
          <li>
            <a href="/2020/11/23/qiankun%E5%BE%AE%E5%89%8D%E7%AB%AF%E5%88%9D%E6%8E%A2/">qiankunå¾®å‰ç«¯å®è·µ</a>
          </li>
        
          <li>
            <a href="/2019/12/19/Vue2-x%E4%B9%8Bv-model%E8%AF%A6%E8%A7%A3/">Vue2.xä¹‹v-modelè¯¦è§£</a>
          </li>
        
          <li>
            <a href="/2019/12/18/Vue2-x-%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94Watcher%E7%AF%87%E8%AF%A6%E8%A7%A3/">Vue2.x-æ•°æ®å“åº”Watcherç¯‡è¯¦è§£</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 å‘¨å°eä¸¶<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>