<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>周小e丶的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="周小e丶的博客">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="周小e丶的博客">
<meta property="og:locale">
<meta property="article:author" content="周小e丶">
<meta property="article:tag" content="前端、吹比">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="周小e丶的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">周小e丶的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">coding...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-使用gitlab-ci集成前端项目" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/26/%E4%BD%BF%E7%94%A8gitlab-ci%E9%9B%86%E6%88%90%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time class="dt-published" datetime="2019-07-26T03:13:16.000Z" itemprop="datePublished">2019-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/26/%E4%BD%BF%E7%94%A8gitlab-ci%E9%9B%86%E6%88%90%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/">使用gitlab-ci集成前端项目</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>这几天正好有空（划水）在研究ci方面的一些基础知识 主要是对着官方文档做参考并加以实践<br>先介绍一下小弟对于gitlab-ci的认知（免责声明）</p>
<ol>
<li>开发者通过配置gitlab-ci.yml文件 在每次代码产生push或者有新的tag产生时触发ci脚本</li>
<li>gitlab-ci集成流程由多个job组成， 每个job跑在不同的gitlab-runner中， 也可以多个job形成依赖关系 这点倒跟docker有类似的地方</li>
</ol>
<h4 id="怎么用"><a href="#怎么用" class="headerlink" title="怎么用"></a>怎么用</h4><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/ci/yaml/README.html#tags">官方文档</a></p>
<p>文档讲解的很清楚 这里不多赘述了 主要就是几个参数的使用 如下图所示：<br><img src="https://esymeptoo.github.io/images/gitlab-ci1.png" alt="gitlab-ci"></p>
<p>本次我们以前端项目的自动化为例，做一个简要的介绍<br>我司的前端项目构建时主要有三个阶段 test、build、deploy</p>
<ol>
<li>test阶段主要负责做一些单元测试、代码lint检查等</li>
<li>build阶段负责将代码打包发到CDN 并根据打包文件生成项目配置文件</li>
<li>deploy阶段负责 从生成的配置文件中获取最新的静态资源地址 并保存到redis中 以便node服务器去获取最近一次的发版内容</li>
</ol>
<p>实际情况远比这些上述要复杂的多 但是本次我们讲的是gitlab-ci用法 下面我会举个demo 包教不包会嘿嘿😋<br>如图<br><img src="https://esymeptoo.github.io/images/gitlab-ci-pipeline.png" alt="gitlab-ci"></p>
<p>这是一个常规项目的ci流程<br>图中将ci分为三个阶段 Test、Build、Deploy 接下来我会依据这三个阶段实践一下</p>
<p>我们在项目中创建index.js<br>目标是达到能通过不同的分支去构建不同的环境变量从而打印出不同的env名<br>内容如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> env = process.<span class="property">env</span>.<span class="property">NODE_ENV</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;env&#125;</span>, 蔡徐坤`</span>)</span><br></pre></td></tr></table></figure>

<p>在package.json scripts中加入</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;export NODE_ENV=$CI_ENVIRONMENT_NAME &amp;&amp; node index.js&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>再新建.gitlab-ci.yml文件<br>内容如下:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">xxxx</span>    <span class="string">//</span> <span class="string">通常是docker-node镜像</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">2B</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master@xxxx</span></span><br></pre></td></tr></table></figure>

<p>上面的job 会在master分支push代码后触发npm run build命令<br>environment的name参数对应package.json中的$CI_ENVIRONMENT_NAME参数<br>所以我们可以进一步通过ci提供的模板功能来达到不同分支触发不同构建参数的目的</p>
<p>如下:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.build-template:</span> <span class="string">$build-template</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="string">script</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">2B</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">build-dev:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="string">*build-template</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">alpha</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dev@xxxx</span>  </span><br><span class="line">    </span><br><span class="line"><span class="attr">build-beta:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="string">*build-template</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">beta</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dev@xxxx</span>  </span><br></pre></td></tr></table></figure>

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>gitlab-ci的用法自由度非常高 这种持续集成方案的出现让开发者在部署方面节省了很多成本。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/26/%E4%BD%BF%E7%94%A8gitlab-ci%E9%9B%86%E6%88%90%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" data-id="cm54yagl4000lb3hggfz88cpv" data-title="使用gitlab-ci集成前端项目" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab-ci/" rel="tag">gitlab-ci</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-有关vue中key的使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/05/%E6%9C%89%E5%85%B3vue%E4%B8%ADkey%E7%9A%84%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2019-07-05T08:04:15.000Z" itemprop="datePublished">2019-07-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/05/%E6%9C%89%E5%85%B3vue%E4%B8%ADkey%E7%9A%84%E4%BD%BF%E7%94%A8/">有关vue中key的使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="关于key"><a href="#关于key" class="headerlink" title="关于key"></a>关于key</h4><p>上一张讲了vue的patch过程 有一点讲的还是很含糊的 就是key相关的<br>提到key这概念 在vue1.0中它的前身好像是v-track 作用不用说都知道 是为了优化diff操作 那它到底是如何做到这一点的呢<br>我们先看看代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldKeyToIdx)) &#123; oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx); &#125;</span><br><span class="line">idxInOld = <span class="title function_">isDef</span>(newStartVnode.<span class="property">key</span>)</span><br><span class="line">  ? oldKeyToIdx[newStartVnode.<span class="property">key</span>]</span><br><span class="line">  : <span class="title function_">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">  <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  vnodeToMove = oldCh[idxInOld];</span><br><span class="line">  <span class="comment">// 为什么不建议使用数组下标作为key 这里会判断出不是相同节点 并且会重新创建一个新节点</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">    <span class="title function_">patchVnode</span>(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">    oldCh[idxInOld] = <span class="literal">undefined</span>;</span><br><span class="line">    canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, vnodeToMove.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// same key but different element. treat as new element</span></span><br><span class="line">    <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">newStartVnode = newCh[++newStartIdx];        </span><br></pre></td></tr></table></figure>

<p>这段代码是updateChildren方法里的一个if-branch 上一章节有提到这部分 我就不多赘述了<br>这段代码是干嘛的呢 先是通过oldVnodeChildren计算出老的子节点对应的key 每次updateChildren只需要计算一次</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createKeyToOldIdx</span> (<span class="params">children, beginIdx, endIdx</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> i, key;</span><br><span class="line">  <span class="keyword">var</span> map = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (i = beginIdx; i &lt;= endIdx; ++i) &#123;</span><br><span class="line">    key = children[i].<span class="property">key</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(key)) &#123; map[key] = i; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说如果一个节点有key 就把这个key当做map里的key值 把这个节点所处的index 当做value<br>比如一群子节点A, B, C, D key分别是’A’, ‘B’, ‘C’, ‘D’<br>生成的oldKeyToIdx就是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">A</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">B</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">C</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">D</span>: <span class="number">3</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就算这些子节点的顺序变了 但是key没变 很容易能找到它在oldVnodesChildren中对应的节点 所以这才作为性能优化的一种手段</p>
<p>那为什么不推荐使用数组下标作为作为key呢<br>我们看看用数组下标作为key的oldKeyToIdx</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="number">0</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">1</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="number">2</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="number">3</span>: <span class="number">3</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样如果子节点顺序发生了变化 比如变成了BADC 此时B的key由1变成了0 实际上我们在oldVnodesChildren中找到的是A<br>这时候如果A和B经过sameVnode判断不是同一个节点 会调用createElm创建新节点 那我们岂不是得不偿失啦 这样的key就没有意义了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/05/%E6%9C%89%E5%85%B3vue%E4%B8%ADkey%E7%9A%84%E4%BD%BF%E7%94%A8/" data-id="cm54yagl60012b3hghejt5rnl" data-title="有关vue中key的使用" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-vue-patch" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/03/vue-patch/" class="article-date">
  <time class="dt-published" datetime="2019-07-03T06:53:02.000Z" itemprop="datePublished">2019-07-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/03/vue-patch/">vue-patch</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Virtual-Dom"><a href="#Virtual-Dom" class="headerlink" title="Virtual Dom"></a>Virtual Dom</h4><p>vue2.0从引入了Virtual dom的概念作为优化dom操作的手段, 下面我们就详细介绍这玩意儿。<br>中所周知， VNode是virtual dom的主要角色， 先看看VNode的组成</p>
<h3 id="VNode"><a href="#VNode" class="headerlink" title="VNode"></a>VNode</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;;</span><br><span class="line">  <span class="attr">text</span>: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">ns</span>: <span class="built_in">string</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="built_in">void</span>; <span class="comment">// rendered in this component&#x27;s scope</span></span><br><span class="line">  <span class="attr">key</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="built_in">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="built_in">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  <span class="attr">raw</span>: <span class="built_in">boolean</span>; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  <span class="attr">isStatic</span>: <span class="built_in">boolean</span>; <span class="comment">// hoisted static node</span></span><br><span class="line">  <span class="attr">isRootInsert</span>: <span class="built_in">boolean</span>; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  <span class="attr">isComment</span>: <span class="built_in">boolean</span>; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  <span class="attr">isCloned</span>: <span class="built_in">boolean</span>; <span class="comment">// is a cloned node?</span></span><br><span class="line">  <span class="attr">isOnce</span>: <span class="built_in">boolean</span>; <span class="comment">// is a v-once node?</span></span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="built_in">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="built_in">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span>; <span class="comment">// for SSR caching</span></span><br><span class="line">  <span class="attr">devtoolsMeta</span>: ?<span class="title class_">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?<span class="built_in">string</span>; <span class="comment">// functional scope id support</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">tag</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">data</span>?: <span class="title class_">VNodeData</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">children</span>?: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span></span><br><span class="line"><span class="params">    <span class="attr">text</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">elm</span>?: <span class="title class_">Node</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">context</span>?: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">componentOptions</span>?: <span class="title class_">VNodeComponentOptions</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">asyncFactory</span>?: <span class="title class_">Function</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DEPRECATED: alias for componentInstance for backwards compat.</span></span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  get <span class="title function_">child</span> (): <span class="title class_">Component</span> | <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">componentInstance</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上是VNode的结构 这比真实dom少了很多属性 所以在通过比对VDom的变化在映射到真实dom的过程中会节省很多性能开销</p>
<h4 id="Patch之前"><a href="#Patch之前" class="headerlink" title="Patch之前"></a>Patch之前</h4><p>本章主要讲vue在数据更新时是怎样及时的通过对比新旧virtual dom映射到真实dom的~<br>从源码来看， 有三个类极为重要 Observer类、Dep类和Watcher类<br>Observer实例负责给每个需要watch的对象添加getter和setter<br>Watcher实例则负责在数据变动的时候去收集依赖、触发patch等操作<br>而Dep实例则是observer和watch的桥梁 在数据变动的时候通知对应watcher执行更新操作</p>
<h4 id="那么在数据更新的过程中都发生了什么？"><a href="#那么在数据更新的过程中都发生了什么？" class="headerlink" title="那么在数据更新的过程中都发生了什么？"></a>那么在数据更新的过程中都发生了什么？</h4><p>observer.get -&gt; dep.notify -&gt; watcher.update -&gt; flushSchedulerQueue -&gt;<br>watcher.run -&gt; watch.get -&gt; updateComponent -&gt; _render -&gt; _update -&gt; patch<br>-&gt; patchVnode -&gt; updateChildren</p>
<p>本章主要从patch的过程开始讲</p>
<h4 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h4><p><img src="https://esymeptoo.github.io/images/diff.png" alt="diff"></p>
<p>patch的代码</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span> (<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode)) &#123; <span class="title function_">invokeDestroyHook</span>(oldVnode); &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isInitialPatch = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> insertedVnodeQueue = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">    <span class="comment">// empty mount (likely as component), create new root element</span></span><br><span class="line">    isInitialPatch = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">createElm</span>(vnode, insertedVnodeQueue);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>);</span><br><span class="line">    <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">      <span class="comment">// patch existing root node</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="literal">null</span>, <span class="literal">null</span>, removeOnly);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isRealElement) &#123;</span><br><span class="line">        <span class="comment">// mounting to a real element</span></span><br><span class="line">        <span class="comment">// check if this is server-rendered content and if we can perform</span></span><br><span class="line">        <span class="comment">// a successful hydration.</span></span><br><span class="line">        <span class="keyword">if</span> (oldVnode.<span class="property">nodeType</span> === <span class="number">1</span> &amp;&amp; oldVnode.<span class="title function_">hasAttribute</span>(<span class="variable constant_">SSR_ATTR</span>)) &#123;</span><br><span class="line">          oldVnode.<span class="title function_">removeAttribute</span>(<span class="variable constant_">SSR_ATTR</span>);</span><br><span class="line">          hydrating = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isTrue</span>(hydrating)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">hydrate</span>(oldVnode, vnode, insertedVnodeQueue)) &#123;</span><br><span class="line">            <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> oldVnode</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">&#x27;The client-side rendered virtual DOM tree is not matching &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;server-rendered content. This is likely caused by incorrect &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;HTML markup, for example nesting block-level elements inside &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;full client-side render.&#x27;</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// either not server-rendered, or hydration failed.</span></span><br><span class="line">        <span class="comment">// create an empty node and replace it</span></span><br><span class="line">        oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// replacing existing element</span></span><br><span class="line">      <span class="keyword">var</span> oldElm = oldVnode.<span class="property">elm</span>;</span><br><span class="line">      <span class="keyword">var</span> parentElm = nodeOps.<span class="title function_">parentNode</span>(oldElm);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// create new node</span></span><br><span class="line">      <span class="title function_">createElm</span>(</span><br><span class="line">        vnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        <span class="comment">// extremely rare edge case: do not insert if old element is in a</span></span><br><span class="line">        <span class="comment">// leaving transition. Only happens when combining transition +</span></span><br><span class="line">        <span class="comment">// keep-alive + HOCs. (#4590)</span></span><br><span class="line">        oldElm.<span class="property">_leaveCb</span> ? <span class="literal">null</span> : parentElm,</span><br><span class="line">        nodeOps.<span class="title function_">nextSibling</span>(oldElm)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="comment">// update parent placeholder node element, recursively</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">parent</span>)) &#123;</span><br><span class="line">        <span class="keyword">var</span> ancestor = vnode.<span class="property">parent</span>;</span><br><span class="line">        <span class="keyword">var</span> patchable = <span class="title function_">isPatchable</span>(vnode);</span><br><span class="line">        <span class="keyword">while</span> (ancestor) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cbs.<span class="property">destroy</span>.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">            cbs.<span class="property">destroy</span>[i](ancestor);</span><br><span class="line">          &#125;</span><br><span class="line">          ancestor.<span class="property">elm</span> = vnode.<span class="property">elm</span>;</span><br><span class="line">          <span class="keyword">if</span> (patchable) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i$1 = <span class="number">0</span>; i$1 &lt; cbs.<span class="property">create</span>.<span class="property">length</span>; ++i$1) &#123;</span><br><span class="line">              cbs.<span class="property">create</span>[i$1](emptyNode, ancestor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// #6513</span></span><br><span class="line">            <span class="comment">// invoke insert hooks that may have been merged by create hooks.</span></span><br><span class="line">            <span class="comment">// e.g. for directives that uses the &quot;inserted&quot; hook.</span></span><br><span class="line">            <span class="keyword">var</span> insert = ancestor.<span class="property">data</span>.<span class="property">hook</span>.<span class="property">insert</span>;</span><br><span class="line">            <span class="keyword">if</span> (insert.<span class="property">merged</span>) &#123;</span><br><span class="line">              <span class="comment">// start at index 1 to avoid re-invoking component mounted hook</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">var</span> i$2 = <span class="number">1</span>; i$2 &lt; insert.<span class="property">fns</span>.<span class="property">length</span>; i$2++) &#123;</span><br><span class="line">                insert.<span class="property">fns</span>[i$2]();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">registerRef</span>(ancestor);</span><br><span class="line">          &#125;</span><br><span class="line">          ancestor = ancestor.<span class="property">parent</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// destroy old node</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(parentElm)) &#123;</span><br><span class="line">        <span class="title function_">removeVnodes</span>(parentElm, [oldVnode], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">tag</span>)) &#123;</span><br><span class="line">        <span class="title function_">invokeDestroyHook</span>(oldVnode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch);</span><br><span class="line">  <span class="keyword">return</span> vnode.<span class="property">elm</span></span><br><span class="line">&#125;      </span><br></pre></td></tr></table></figure>

<ol>
<li>如果vnode不存在儿oldVnode存在 销毁oldVnode</li>
<li>如果oldVnode不存在而vnode存在 则调用createElm创建新的节点</li>
<li>如果oldVnode存在<blockquote>
<ol>
<li>如果oldVnode不是真实节点并且oldVnode和vnode是相同节点 则调用patchVnode进行比较</li>
<li>如果oldVnode是真实节点(说明是组件初始化的过程), 调用createElm创建新节点 并调用removeVnodes将oldVnode对应的老节点移除</li>
</ol>
</blockquote>
</li>
</ol>
<h4 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchVnode</span> (<span class="params"></span></span><br><span class="line"><span class="params">  oldVnode,</span></span><br><span class="line"><span class="params">  vnode,</span></span><br><span class="line"><span class="params">  insertedVnodeQueue,</span></span><br><span class="line"><span class="params">  ownerArray,</span></span><br><span class="line"><span class="params">  index,</span></span><br><span class="line"><span class="params">  removeOnly</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldVnode === vnode) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">elm</span>) &amp;&amp; <span class="title function_">isDef</span>(ownerArray)) &#123;</span><br><span class="line">    <span class="comment">// clone reused vnode</span></span><br><span class="line">    vnode = ownerArray[index] = <span class="title function_">cloneVNode</span>(vnode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> elm = vnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTrue</span>(oldVnode.<span class="property">isAsyncPlaceholder</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">asyncFactory</span>.<span class="property">resolved</span>)) &#123;</span><br><span class="line">      <span class="title function_">hydrate</span>(oldVnode.<span class="property">elm</span>, vnode, insertedVnodeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode.<span class="property">isAsyncPlaceholder</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// reuse element for static trees.</span></span><br><span class="line">  <span class="comment">// note we only do this if the vnode is cloned -</span></span><br><span class="line">  <span class="comment">// if the new node is not cloned it means the render functions have been</span></span><br><span class="line">  <span class="comment">// reset by the hot-reload-api and we need to do a proper re-render.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTrue</span>(vnode.<span class="property">isStatic</span>) &amp;&amp;</span><br><span class="line">    <span class="title function_">isTrue</span>(oldVnode.<span class="property">isStatic</span>) &amp;&amp;</span><br><span class="line">    vnode.<span class="property">key</span> === oldVnode.<span class="property">key</span> &amp;&amp;</span><br><span class="line">    (<span class="title function_">isTrue</span>(vnode.<span class="property">isCloned</span>) || <span class="title function_">isTrue</span>(vnode.<span class="property">isOnce</span>))</span><br><span class="line">  ) &#123;</span><br><span class="line">    vnode.<span class="property">componentInstance</span> = oldVnode.<span class="property">componentInstance</span>;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> i;</span><br><span class="line">  <span class="keyword">var</span> data = vnode.<span class="property">data</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">prepatch</span>)) &#123;</span><br><span class="line">    <span class="title function_">i</span>(oldVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> oldCh = oldVnode.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">var</span> ch = vnode.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isPatchable</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.<span class="property">update</span>.<span class="property">length</span>; ++i) &#123; cbs.<span class="property">update</span>[i](oldVnode, vnode); &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">update</span>)) &#123; <span class="title function_">i</span>(oldVnode, vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh) &amp;&amp; <span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldCh !== ch) &#123; <span class="title function_">updateChildren</span>(elm, oldCh, ch, insertedVnodeQueue, removeOnly); &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="title function_">checkDuplicateKeys</span>(ch);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123; nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>); &#125;</span><br><span class="line">      <span class="title function_">addVnodes</span>(elm, <span class="literal">null</span>, ch, <span class="number">0</span>, ch.<span class="property">length</span> - <span class="number">1</span>, insertedVnodeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh)) &#123;</span><br><span class="line">      <span class="title function_">removeVnodes</span>(elm, oldCh, <span class="number">0</span>, oldCh.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123;</span><br><span class="line">      nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== vnode.<span class="property">text</span>) &#123;</span><br><span class="line">    nodeOps.<span class="title function_">setTextContent</span>(elm, vnode.<span class="property">text</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">postpatch</span>)) &#123; <span class="title function_">i</span>(oldVnode, vnode); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>如果oldVnode完全等于vnode return</li>
<li>如果oldVnode和vnode都是静态节点，且vnode的key等于oldVnode的key，且vnode是克隆节点或者v-once控制的节点的时候 只需要把<br>oldVnode的componentInstance复制给vnode即可</li>
<li>如果vnode不是文本节点<blockquote>
<ol>
<li>如果oldVnode存在children且vnode存在children 且两个children 不完全相等 执行updateChildren</li>
<li>如果只有vnode存在children子节点， 调用addVnodes添加子节点</li>
<li>如果只有oldVnode存在子节点， 调用removeVnodes移除这些子节点</li>
<li>如果vnode和oldVnode都没有子节点，但是oldVnode是文本节点 则把oldVnode对应的真实dom的文本内容清空</li>
</ol>
</blockquote>
</li>
<li>如果vnode是文本节点且文本内容和oldnode的文本内容不一样， 则把vnode的文本内容赋值给oldVnode对应dom节点的文本</li>
</ol>
<h4 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateChildren</span> (<span class="params">parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> oldStartIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> newStartIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> oldStartVnode = oldCh[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> oldEndVnode = oldCh[oldEndIdx];</span><br><span class="line">  <span class="keyword">var</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> newStartVnode = newCh[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> newEndVnode = newCh[newEndIdx];</span><br><span class="line">  <span class="keyword">var</span> oldKeyToIdx, idxInOld, vnodeToMove, refElm;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removeOnly is a special flag used only by &lt;transition-group&gt;</span></span><br><span class="line">  <span class="comment">// to ensure removed elements stay in correct relative positions</span></span><br><span class="line">  <span class="comment">// during leaving transitions</span></span><br><span class="line">  <span class="keyword">var</span> canMove = !removeOnly;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="title function_">checkDuplicateKeys</span>(newCh);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldStartVnode)) &#123;</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]; <span class="comment">// Vnode has been moved left</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldEndVnode)) &#123;</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      newEndVnode = newCh[--newEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123; <span class="comment">// Vnode moved right</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);</span><br><span class="line">      canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldStartVnode.<span class="property">elm</span>, nodeOps.<span class="title function_">nextSibling</span>(oldEndVnode.<span class="property">elm</span>));</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">      newEndVnode = newCh[--newEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123; <span class="comment">// Vnode moved left</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">      canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldEndVnode.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldKeyToIdx)) &#123; oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx); &#125;</span><br><span class="line">      idxInOld = <span class="title function_">isDef</span>(newStartVnode.<span class="property">key</span>)</span><br><span class="line">        ? oldKeyToIdx[newStartVnode.<span class="property">key</span>]</span><br><span class="line">        : <span class="title function_">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">        <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vnodeToMove = oldCh[idxInOld];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">          <span class="title function_">patchVnode</span>(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);</span><br><span class="line">          oldCh[idxInOld] = <span class="literal">undefined</span>;</span><br><span class="line">          canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, vnodeToMove.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// same key but different element. treat as new element</span></span><br><span class="line">          <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">    refElm = <span class="title function_">isUndef</span>(newCh[newEndIdx + <span class="number">1</span>]) ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].<span class="property">elm</span>;</span><br><span class="line">    <span class="title function_">addVnodes</span>(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">    <span class="title function_">removeVnodes</span>(parentElm, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateChildren方法主要通过while循环去对比新旧两棵树的子节点来更新dom</p>
<ol>
<li>如果oldStartVnode不存在 则将oldStartVnode设置为下一个子节点 oldStartIdx也指向这个子节点</li>
<li>如果oldEndVnode不存在 oldEndVnode指向上一个子节点 oldEndIdx也指向这个子节点</li>
<li>如果oldStartVnode和newStartVnode是同一个子节点 调用patchVnode 进行比较 并且将oldStartVnode和newStartVnode设置为下一个子节点</li>
<li>如果oldEndVnode和newEndVnode是同一个节点， 调用patchVnode进行比对， 同时将他们设置为上一个节点</li>
<li>如果oldStartVnode和newEndVnode是同一个子节点， 调用patchVnode进行比对 将这个节点移到oldEndVnode下一个兄弟节点的前面 并将oldStartVnode指向下一个 newEndVnode指向下一个</li>
<li>如果oldEndVnode和newStartVnode是同一个子节点 调用patchVnode进行比对 将这个节点移到oldStartVnode对应节点的前面 并将oldEndVnode指向前一个节点 newStartVnode指向下一个节点</li>
<li>如果以上都不成立 根据newStartVnode的key值在oldVnodeChildren中进行查找<blockquote>
<ol>
<li>如果oldVnodeChildren中存在key值一样</li>
<li>如果oldVnodeChildren中找到的节点和newStartVnode是相同节点，调用patchVnode的比对并将目标节点移至oldStartVnode的前面</li>
<li>如果不是相同节点 则调用createElm创建新的节点</li>
<li>如果找不到和newStartVnode的key值一样的节点 则调用createElm创建新的节点</li>
</ol>
</blockquote>
</li>
</ol>
<p>跳出while循环后 还要针对oldStartIdx和oldEndIdx进行操作</p>
<ol>
<li>如果oldStartIdx 大于 oldEndIdx 说明newVnodesChildren没有遍历完 执行addVnodes</li>
<li>如果newStartIdx &gt; newEndIdx 说明oldVnodeChildren没有遍历完 执行removeVnodes</li>
</ol>
<p>以上就是整个patch过程， 尤其是updateChildren的逻辑还是很精妙的 通过不断缩减两条边界线去判断有无相同节点 不管是空间复杂度还是时间复杂度都减少了很多</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/03/vue-patch/" data-id="cm54yagl10009b3hg8g7y0n7a" data-title="vue-patch" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-简单实现一个mvvm" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/01/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmvvm/" class="article-date">
  <time class="dt-published" datetime="2019-07-01T09:09:55.000Z" itemprop="datePublished">2019-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/01/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmvvm/">简单实现一个mvvm</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="什么是MVVM"><a href="#什么是MVVM" class="headerlink" title="什么是MVVM"></a>什么是MVVM</h4><p>MVVM是Model-View-ViewModel的简写。它本质上就是MVC 的改进版。MVVM 就是将其中的View 的状态和行为抽象化，让我们将视图 UI 和业务逻辑分开。</p>
<h4 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">content</span>=<span class="string">&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h</span>&gt;</span>姓名:<span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h</span>&gt;</span>姓名:<span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h</span>&gt;</span>年龄:<span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;age&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> target = <span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">class</span> <span class="title class_">Mvvm</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">options</span> = options</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> root = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(options.<span class="property">el</span>)</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="title function_">observer</span>(options.<span class="property">data</span>)</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 初始化dom树 主要是填充绑定的值和触发各个值的getter</span></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="title function_">compile</span>(root)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">observer</span>(<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(data).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span></span><br><span class="line"><span class="language-javascript">        data[<span class="string">&#x27;_&#x27;</span> + key] = data[key]</span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            data[<span class="string">&#x27;_&#x27;</span> + key] = newVal</span></span><br><span class="line"><span class="language-javascript">            dep.<span class="title function_">update</span>(newVal)</span></span><br><span class="line"><span class="language-javascript">          &#125;,</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">get</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            target &amp;&amp; dep.<span class="title function_">addSub</span>(target)</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> data[<span class="string">&#x27;_&#x27;</span> + key]</span></span><br><span class="line"><span class="language-javascript">          &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">compile</span>(<span class="params">root</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span>.<span class="title function_">call</span>(root.<span class="property">childNodes</span>, <span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 判断该节点是不是最底层节点 是就执行 不是就递归继续找</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!child.<span class="property">firstElementChild</span> &amp;&amp; <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span>.<span class="title function_">test</span>(child.<span class="property">innerHTML</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 拿到RegExp的全局只读属性</span></span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> key = <span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="title function_">trim</span>()</span></span><br><span class="line"><span class="language-javascript">          child.<span class="property">innerHTML</span> = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">data</span>[key]</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 将该节点赋給target</span></span></span><br><span class="line"><span class="language-javascript">          target = child</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 触发这个key的get方法 将target以闭包的形式传到dep实例</span></span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">data</span>[key]</span></span><br><span class="line"><span class="language-javascript">          target = <span class="literal">null</span></span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="title function_">compile</span>(child)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">subs</span> = []</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addSub</span>(<span class="params">sub</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">update</span>(<span class="params">val</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        sub.<span class="property">innerHTML</span> = val</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> vm = <span class="keyword">new</span> <span class="title class_">Mvvm</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">name</span>: <span class="string">&#x27;暂无&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">age</span>: <span class="number">20</span>,</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    vm.<span class="property">options</span>.<span class="property">data</span>.<span class="property">name</span> = <span class="string">&#x27;demo&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    vm.<span class="property">options</span>.<span class="property">data</span>.<span class="property">age</span> = <span class="number">30</span></span></span><br><span class="line"><span class="language-javascript">  &#125;, <span class="number">2000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/01/%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmvvm/" data-id="cm54yagl60014b3hgg5sscatb" data-title="简单实现一个mvvm" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mvvm/" rel="tag">mvvm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-浏览器的event loop模型" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/06/06/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84event%20loop%E6%A8%A1%E5%9E%8B/" class="article-date">
  <time class="dt-published" datetime="2019-06-06T06:50:39.000Z" itemprop="datePublished">2019-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/06/06/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84event%20loop%E6%A8%A1%E5%9E%8B/">浏览器的event loop模型</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Event-Loop"><a href="#Event-Loop" class="headerlink" title="Event Loop"></a>Event Loop</h4><p>Event Loop即事件循环，是指浏览器或Node的一种解决javaScript单线程运行时不会阻塞的一种机制，也就是我们经常使用异步的原理。</p>
<h4 id="MacroTask-MicroTask"><a href="#MacroTask-MicroTask" class="headerlink" title="MacroTask&#x2F;MicroTask"></a>MacroTask&#x2F;MicroTask</h4><p>提到浏览器的事件循环就不得不提到宏任务(MacroTask)和微任务(MicroTask)的概念<br>宏任务的代表： setTimeout&#x2F;setInterval&#x2F;setImmediate等<br>微任务的代表： Promise&#x2F;MutationObserver 和node里的process.nextTick等</p>
<p>众所周知 js是单线程运行的 那它是如何处理异步逻辑的呢？</p>
<p>Javascript 有一个 main thread 主线程和 call-stack 调用栈(执行栈)，所有的任务都会被放到调用栈等待主线程执行<br>Javascript单线程任务被分为同步任务和异步任务，同步任务会在调用栈中按照顺序等待主线程依次执行，<br>异步任务会在异步任务有了结果后，将注册的回调函数放入任务队列中等待主线程空闲的时候（调用栈被清空），<br>被读取到栈内等待主线程的执行</p>
<p>主线程的任务会放在主线程队列<br>当主线程队列执行完毕后<br>会去check微任务队列 挨个执行其中的微任务<br>等到微任务队列没有可执行的任务后 会去check宏任务队列并执行存在的第一条宏任务<br>执行一条宏任务后 会再次check微任务队列是否存在待执行任务 存在就执行微任务 循环以上操作</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/06/06/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84event%20loop%E6%A8%A1%E5%9E%8B/" data-id="cm54yagl70016b3hg3uwt3mmk" data-title="浏览器的event loop模型" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-docker容器化部署前端项目" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/06/docker%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time class="dt-published" datetime="2019-05-06T06:22:05.000Z" itemprop="datePublished">2019-05-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/06/docker%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/">docker容器化部署前端项目</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这次我们整一下docker部署的问题 会涉及到docker、vue、nginx</p>
<h4 id="Step-One"><a href="#Step-One" class="headerlink" title="Step One"></a>Step One</h4><p>安装docker: 从docker官网下载 <a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-mac/">https://docs.docker.com/docker-for-mac/</a><br>安装步骤略过…</p>
<p>安装nginx: docker pull nginx   一顿操作balabala…<br>安装node: docker pull node</p>
<p>使用vue-cli3整一个vue项目  直接vue create docker-vue  又是一通balabala… </p>
<p>整个安装过程比较慢 先普及一下几个基本的docker命令 </p>
<ol>
<li>docker images: 查看镜像</li>
<li>docker ps: 查看容器</li>
<li>docker exec -it { containerId } &#x2F;bin&#x2F;bash: 进入某个容器的命令行</li>
<li>docker stop { containerId }: 停止某个容器</li>
<li>docker rm { containerId }: 移除某个容器</li>
<li>docker rmi { imageId }: 移除某个镜像 </li>
<li>docker build -t { imageName } .: 生成一个镜像</li>
<li>docker run -p {容器端口:宿主端口} -d { imageName }: 启动某个容器</li>
</ol>
<p>基本用到的命令就是以上几个了</p>
<h4 id="Step-Two"><a href="#Step-Two" class="headerlink" title="Step Two"></a>Step Two</h4><p>好了 该装的都装好了 我们直接开搞<br>在vue项目立新建Dockerfile文件 写入以下配置</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /docker-work/docker-vue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /docker-work/docker-vue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf dist/ node_modules/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置跨域</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /docker-work/docker-vue/nginx/default.conf /etc/nginx/conf.d/default.conf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /docker-work/docker-vue/dist /usr/share/nginx/html</span></span><br></pre></td></tr></table></figure>
<p>解释一下参数<br>FROM 表示使用docker的哪个镜像 可以是本地安装的 也可以是docker镜像库里的<br>COPY 表示将文件从本地拷贝到这个docker镜像对应的工作目录里 可以通过docker exec命令查看到<br>WORKDIR 表示当前的工作目录<br>RUN 需要启动的命令</p>
<p>一般COPY的操作都是用以拷贝当前项目文件或者覆盖镜像配置 我们也可以覆盖nginx的default.conf配置等</p>
<p>上面的操作就是将门项目拷贝到docker镜像的目录 通过装好的node 依次执行npm install和npm run build<br>打包完毕后呢再将打包后的dist目录拷贝到当前镜像工作目录的nginx配置静态资源的目录 启动nginx就行了</p>
<p>流程大概是这样<br>输入 docker build -t docker-vue . 构建镜像<br>构建完毕 docker images查看是否构建成功</p>
<p>输入 docker run -p 10000:80 -d docker-vue 启动容器 一个小流程就算完成啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/05/06/docker%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/" data-id="cm54yagl00004b3hgbhpo0gjc" data-title="docker容器化部署前端项目" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker%E3%80%81node/" rel="tag">docker、node</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-react之转发ref" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/04/02/react%E4%B9%8B%E8%BD%AC%E5%8F%91ref/" class="article-date">
  <time class="dt-published" datetime="2019-04-02T12:19:16.000Z" itemprop="datePublished">2019-04-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/04/02/react%E4%B9%8B%E8%BD%AC%E5%8F%91ref/">react之转发ref</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="React之转发ref"><a href="#React之转发ref" class="headerlink" title="React之转发ref"></a>React之转发ref</h4><p>react.16.3新增了forwardRef Api 用来转发ref到子组件上<br>这里大致说下两种情况</p>
<ol>
<li>纯组件不能使用ref</li>
<li>如何给使用了高阶函数包裹的组件加上ref</li>
</ol>
<p>针对以上两种情况 我们看看这个新的api</p>
<h5 id="纯组件"><a href="#纯组件" class="headerlink" title="纯组件"></a>纯组件</h5><p>纯组件是不需要ref属性的 我们可以使用React.forwardRef将父组件加的ref转发到input里</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ForwardRefButton</span> = <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="function">(<span class="params">props, ref</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line">))</span><br></pre></td></tr></table></figure>

<h5 id="高阶组件"><a href="#高阶组件" class="headerlink" title="高阶组件"></a>高阶组件</h5><p>我们先声明一个高阶组件hoc</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hoc</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">WrapperComponent</span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">HOC</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">      <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;hoc-wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">WrapperComponent</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#123;<span class="attr">...this.props</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&#123;this.props.forwardRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">HOC</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再写一个正常组件</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ButtonRef</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>测试高阶函数转发ref<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HocButton</span> = <span class="title function_">hoc</span>()(<span class="title class_">ButtonRef</span>)</span><br></pre></td></tr></table></figure>
<p>HocButton 是我们通过高阶组件包装过的组件<br>这时候高阶组件没有进行ref转发 导致我们给HocButton添加ref属性的时候 只能添加到HOC这个组件上<br>想要ButtonRef也拥有这个属性 我们得改一下高阶函数的返回值 如下:</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="function">(<span class="params">props, ref</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">HOC</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">forwardRef</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>这样就能正常访问到被高阶组件包裹的子组件啦</p>
<p>有没有办法不使用forwardRef就能做到ref转发呢？<br>当然有 可以把ref当做做个属性传进高阶函数 再经由高阶组件注册到子组件上 也能实现ref转发啦 还是上面的例子<br>我们再使用HocButton时</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">handleRef</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">buttonRef</span> = el</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">HocButton</span> <span class="attr">wrappedref</span>=<span class="string">&#123;this.handleRef.bind(this)&#125;</span> /&gt;</span></span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改一下高阶组件内部调用 如下:</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hoc</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">WrappedComponent</span>) &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">HOC</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">      <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;hoc-wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">WrappedComponent</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#123;<span class="attr">...this.props</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&#123;this.props.wrappedref&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">HOC</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样也是实现ref转发到WrappedComponent上啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/04/02/react%E4%B9%8B%E8%BD%AC%E5%8F%91ref/" data-id="cm54yagl2000db3hgbf3tg1nm" data-title="react之转发ref" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" rel="tag">react ref 笔记</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-react-redux源码解读" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/22/react-redux%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="article-date">
  <time class="dt-published" datetime="2019-03-22T06:43:31.000Z" itemprop="datePublished">2019-03-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/03/22/react-redux%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">react-redux源码解读</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="react-redux源码解读"><a href="#react-redux源码解读" class="headerlink" title="react-redux源码解读"></a>react-redux源码解读</h2><p>上一篇翻了一下redux的源码 这一篇就研究下react-redux吧<br>原理大家都知道 就是利用react的Context Api<br>那我们看看它是怎么在react应用中施展魔法的吧~~</p>
<p>看代码 先看index.js</p>
<h4 id="src-index-js"><a href="#src-index-js" class="headerlink" title="src&#x2F;index.js"></a>src&#x2F;index.js</h4><p>这个文件是主入口  暴露出 Provider&#x2F;connectAdvanced&#x2F;ReactReduxContext&#x2F;connect四个核心方法</p>
<ol>
<li>其中，Provider是个react组件 是存储store数的根节点</li>
<li>ReactReduxContext是个react context，所有子组件的都要从这个context获取store的数据</li>
<li>connect 是关联组件和store的方法</li>
<li>connectAdvanced 是一个高阶组件 负责将connect的参数进行封装添加到子组件的props上</li>
</ol>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Provider</span> <span class="keyword">from</span> <span class="string">&#x27;./components/Provider&#x27;</span></span><br><span class="line"><span class="keyword">import</span> connectAdvanced <span class="keyword">from</span> <span class="string">&#x27;./components/connectAdvanced&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReactReduxContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./components/Context&#x27;</span></span><br><span class="line"><span class="keyword">import</span> connect <span class="keyword">from</span> <span class="string">&#x27;./connect/connect&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; <span class="title class_">Provider</span>, connectAdvanced, <span class="title class_">ReactReduxContext</span>, connect &#125;</span><br></pre></td></tr></table></figure>

<p>看到这几个方法就能猜到react-redux到底做了什么？难点在哪里？怎么避免不必要的渲染？以及使用高阶函数时对于ref的转发？</p>
<p>我们不妨先看Provider这个组件吧 毕竟他也是react使用redux的入口 也是关联store的第一环</p>
<h4 id="src-components-Provider-js"><a href="#src-components-Provider-js" class="headerlink" title="src&#x2F;components&#x2F;Provider.js"></a>src&#x2F;components&#x2F;Provider.js</h4><p>Provider是一个react组件 接收三个props</p>
<ol>
<li>store</li>
<li>context</li>
<li>children<br>由此我们猜测 react-redux内部肯定会使用相当多的闭包进行缓存以避免不必要的渲染<br>结合connect的使用 推断会有根据storeState和ownProps进行判断是否进行渲染的逻辑 也理应会有</li>
</ol>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Provider</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 将store和store当前的state保存在组件的state上</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">      <span class="variable language_">super</span>(props)</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">const</span> &#123; store &#125; = props</span><br><span class="line">  </span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        <span class="attr">storeState</span>: store.<span class="title function_">getState</span>(),</span><br><span class="line">        store</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 组件加载完执行subscribe</span></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_isMounted</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">subscribe</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 组件卸载之前</span></span><br><span class="line">    <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 取消监听</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">unsubscribe</span>) <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>()</span><br><span class="line">  </span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_isMounted</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 组件更新结束 如果store的引用变了 如果已经有监听 取消监听 重新监听</span></span><br><span class="line">    <span class="comment">// 引用变了是指 执行reducer的过程中 redux/combineReducers里的hasChanged相对之前发生了变化</span></span><br><span class="line">    <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">store</span> !== prevProps.<span class="property">store</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">unsubscribe</span>) <span class="variable language_">this</span>.<span class="title function_">unsubscribe</span>()</span><br><span class="line">  </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">subscribe</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">subscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; store &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 对store添加监听</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">unsubscribe</span> = store.<span class="title function_">subscribe</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 更新后的store树</span></span><br><span class="line">        <span class="keyword">const</span> newStoreState = store.<span class="title function_">getState</span>()</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 如果组件在卸载前 return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_isMounted</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 比较新旧store 减少不必要的更新</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">providerState</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// If the value is the same, skip the unnecessary state update.</span></span><br><span class="line">          <span class="keyword">if</span> (providerState.<span class="property">storeState</span> === newStoreState) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="keyword">return</span> &#123; <span class="attr">storeState</span>: newStoreState &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// dispatch动作可能在render和componentDidUpdate之间进行 手动同步store</span></span><br><span class="line">      <span class="comment">// Actions might have been dispatched between render and mount - handle those</span></span><br><span class="line">      <span class="keyword">const</span> postMountStoreState = store.<span class="title function_">getState</span>()</span><br><span class="line">      <span class="keyword">if</span> (postMountStoreState !== <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">storeState</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">storeState</span>: postMountStoreState &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Context</span> = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span> || <span class="title class_">ReactReduxContext</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        <span class="comment">// 使用Context包裹children</span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;this.state&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;this.props.children&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="src-connect-connect-js"><a href="#src-connect-connect-js" class="headerlink" title="src&#x2F;connect&#x2F;connect.js"></a>src&#x2F;connect&#x2F;connect.js</h4><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createConnect</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  connectHOC = connectAdvanced,</span></span><br><span class="line"><span class="params">  mapStateToPropsFactories = defaultMapStateToPropsFactories,</span></span><br><span class="line"><span class="params">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,</span></span><br><span class="line"><span class="params">  mergePropsFactories = defaultMergePropsFactories,</span></span><br><span class="line"><span class="params">  selectorFactory = defaultSelectorFactory</span></span><br><span class="line"><span class="params">&#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// 这个connect方法正是我们用到的connect(mapStateToProps, mapDispatchToProps)(WrapperComponent)的真面目</span></span><br><span class="line">  <span class="comment">// mapStateToProps、mapDispatchToProps等参数我就不一一介绍了 请移步官网</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">connect</span>(<span class="params"></span></span><br><span class="line"><span class="params">    mapStateToProps,</span></span><br><span class="line"><span class="params">    mapDispatchToProps,</span></span><br><span class="line"><span class="params">    mergeProps,</span></span><br><span class="line"><span class="params">    &#123;</span></span><br><span class="line"><span class="params">      // 是否启用PureComponent模式</span></span><br><span class="line"><span class="params">      pure = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">      // 在调用selectorFactory的时候 为了使用缓存需要调用的比对方法</span></span><br><span class="line"><span class="params">      areStatesEqual = strictEqual,</span></span><br><span class="line"><span class="params">      // 同上</span></span><br><span class="line"><span class="params">      areOwnPropsEqual = shallowEqual,</span></span><br><span class="line"><span class="params">      // 同上</span></span><br><span class="line"><span class="params">      areStatePropsEqual = shallowEqual,</span></span><br><span class="line"><span class="params">      // 同上</span></span><br><span class="line"><span class="params">      areMergedPropsEqual = shallowEqual,</span></span><br><span class="line"><span class="params">      // 别的参数  getDisplayName/methodName/renderCountProp/shouldHandleStateChanges等...</span></span><br><span class="line"><span class="params">      ...extraOptions</span></span><br><span class="line"><span class="params">    &#125; = &#123;&#125;</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * wrapper的存在是为了让各种类型的返回值保持一致</span></span><br><span class="line"><span class="comment">    * 如果mapStateToProps是function类型 return (dispatch, &#123; displayName &#125;) =&gt; proxy</span></span><br><span class="line"><span class="comment">    * 如果不存在 return (dispatch, option) =&gt; constantSelector</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="comment">// 这三个情况类似 后面就看initMapStateToProps的执行过程就够了</span></span><br><span class="line">    <span class="keyword">const</span> initMapStateToProps = <span class="title function_">match</span>(</span><br><span class="line">      mapStateToProps,</span><br><span class="line">      mapStateToPropsFactories,</span><br><span class="line">      <span class="string">&#x27;mapStateToProps&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> initMapDispatchToProps = <span class="title function_">match</span>(</span><br><span class="line">      mapDispatchToProps,</span><br><span class="line">      mapDispatchToPropsFactories,</span><br><span class="line">      <span class="string">&#x27;mapDispatchToProps&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> initMergeProps = <span class="title function_">match</span>(mergeProps, mergePropsFactories, <span class="string">&#x27;mergeProps&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这个暂时可以看作 return function(WrapperComponent) &#123;&#125;这样一个接收一个组件的方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">connectHOC</span>(selectorFactory, &#123;</span><br><span class="line">      <span class="comment">// used in error messages</span></span><br><span class="line">      <span class="attr">methodName</span>: <span class="string">&#x27;connect&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// used to compute Connect&#x27;s displayName from the wrapped component&#x27;s displayName.</span></span><br><span class="line">      <span class="attr">getDisplayName</span>: <span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`Connect(<span class="subst">$&#123;name&#125;</span>)`</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if mapStateToProps is falsy, the Connect component doesn&#x27;t subscribe to store state changes</span></span><br><span class="line">      <span class="attr">shouldHandleStateChanges</span>: <span class="title class_">Boolean</span>(mapStateToProps),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// passed through to selectorFactory</span></span><br><span class="line">      initMapStateToProps,</span><br><span class="line">      initMapDispatchToProps,</span><br><span class="line">      initMergeProps,</span><br><span class="line">      pure,</span><br><span class="line">      areStatesEqual,</span><br><span class="line">      areOwnPropsEqual,</span><br><span class="line">      areStatePropsEqual,</span><br><span class="line">      areMergedPropsEqual,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// any extra options args can override defaults of connect or connectAdvanced</span></span><br><span class="line">      ...extraOptions</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认参数返回一个connect高阶函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createConnect</span>()</span><br></pre></td></tr></table></figure>
<p>这个createConnect方法接收5个参数</p>
<ol>
<li>connectHoc 默认值为一个高阶函数</li>
<li>mapStateToPropsFactories 为用户传入的mapStateToProps值准备的类型映射 每个类型对应不同的执行方法</li>
<li>mapDispatchToPropsFactories 同上</li>
<li>mergePropsFactories 同上</li>
<li>selectorFactory 这个是通过mapStateToProps和mapDispatchToProps获取最终stateProps, dispatchProps并将它们merge到组件props的过程</li>
</ol>
<p>match方法<br>match方法会依次执行第二个参数的每个元素 入参为第一个参数 只要有返回值 就return 否则抛出异常</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">match</span>(<span class="params">arg, factories, name</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = factories.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = factories[i](arg)</span><br><span class="line">    <span class="comment">// 此时result 的类型是 (dispatch, &#123;&#125;) =&gt; &#123;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">      <span class="string">`Invalid value of type <span class="subst">$&#123;<span class="keyword">typeof</span> arg&#125;</span> for <span class="subst">$&#123;name&#125;</span> argument when connecting component <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        options.wrappedComponentName</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span>.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看一下initMapStateToProps是怎么产生的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initMapStateToProps = <span class="title function_">match</span>(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapStateToPropsFactories,</span><br><span class="line">  <span class="string">&#x27;mapStateToProps&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>match的第一个参数为用户传入的mapStateToProps 通常是这样的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = state =&gt; (&#123;</span><br><span class="line">  <span class="attr">username</span>: state.<span class="property">profile</span>.<span class="property">username</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>第二个参数为mapStateToPropsFactories 默认值为defaultMapStateToPropsFactories 我们看看他是何方神圣</p>
<h4 id="src-connect-mapStateToProps-js"><a href="#src-connect-mapStateToProps-js" class="headerlink" title="src&#x2F;connect&#x2F;mapStateToProps.js"></a>src&#x2F;connect&#x2F;mapStateToProps.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; wrapMapToPropsConstant, wrapMapToPropsFunc &#125; <span class="keyword">from</span> <span class="string">&#x27;./wrapMapToProps&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">whenMapStateToPropsIsFunction</span>(<span class="params">mapStateToProps</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> mapStateToProps === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? <span class="title function_">wrapMapToPropsFunc</span>(mapStateToProps, <span class="string">&#x27;mapStateToProps&#x27;</span>)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">whenMapStateToPropsIsMissing</span>(<span class="params">mapStateToProps</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !mapStateToProps ? <span class="title function_">wrapMapToPropsConstant</span>(<span class="function">() =&gt;</span> (&#123;&#125;)) : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [whenMapStateToPropsIsFunction, whenMapStateToPropsIsMissing]</span><br></pre></td></tr></table></figure>
<p>从这个文件可以知道defaultMapStateToPropsFactories就是暴露出来的这个数组<br>上面我们提到过 这个东西是干嘛用的呢 这是个参数类型映射集合<br>从名字可以看出mapStateToProps可以是function 也可以为空</p>
<p>我们上面举了个function的🌰  先看是function的情况吧</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">whenMapStateToPropsIsFunction</span>(<span class="params">mapStateToProps</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> mapStateToProps === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? <span class="title function_">wrapMapToPropsFunc</span>(mapStateToProps, <span class="string">&#x27;mapStateToProps&#x27;</span>)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法判断如果mapStateToProps是function类型的就返回wrapMapToPropsFunc(mapStateToProps, ‘mapStateToProps’)的执行结果<br>我们移步看看wrapMapToPropsFunc是何方神圣吧</p>
<h4 id="src-connect-wrapMapToProps-js"><a href="#src-connect-wrapMapToProps-js" class="headerlink" title="src&#x2F;connect&#x2F;wrapMapToProps.js"></a>src&#x2F;connect&#x2F;wrapMapToProps.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">wrapMapToPropsFunc</span>(<span class="params">mapToProps, methodName</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">initProxySelector</span>(<span class="params">dispatch, &#123; displayName &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 这里暂时先省略</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次看这个代码有点懵逼，这是个啥，又没有什么上下文之类的 这个不用管<br>只需要知道返回的是一个(dispatch, options) &#x3D;&gt; {} 这样的initProxySelector函数就行了<br>当mapStateToProps传空的时候也是类似这种情况 代码就不贴了 下面我们会回顾这个代码的</p>
<h4 id="src-components-connectAdvanced-js"><a href="#src-components-connectAdvanced-js" class="headerlink" title="src&#x2F;components&#x2F;connectAdvanced.js"></a>src&#x2F;components&#x2F;connectAdvanced.js</h4><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">connectAdvanced</span>(<span class="params"></span></span><br><span class="line"><span class="params">  selectorFactory,</span></span><br><span class="line"><span class="params">  &#123;</span></span><br><span class="line"><span class="params">    getDisplayName = name =&gt; <span class="string">`ConnectAdvanced(<span class="subst">$&#123;name&#125;</span>)`</span>,</span></span><br><span class="line"><span class="params">    methodName = <span class="string">&#x27;connectAdvanced&#x27;</span>,</span></span><br><span class="line"><span class="params">    renderCountProp = <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">    shouldHandleStateChanges = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">    storeKey = <span class="string">&#x27;store&#x27;</span>,</span></span><br><span class="line"><span class="params">    withRef = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params">    forwardRef = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params">    context = ReactReduxContext,</span></span><br><span class="line"><span class="params">    ...connectOptions</span></span><br><span class="line"><span class="params">  &#125; = &#123;&#125;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    renderCountProp === <span class="literal">undefined</span>,</span><br><span class="line">    <span class="string">`renderCountProp is removed. render counting is built into the latest React dev tools profiling extension`</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    !withRef,</span><br><span class="line">    <span class="string">&#x27;withRef is removed. To access the wrapped instance, use a ref on the connected component&#x27;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> customStoreWarningMessage =</span><br><span class="line">    <span class="string">&#x27;To use a custom Redux store for specific components, create a custom React context with &#x27;</span> +</span><br><span class="line">    <span class="string">&quot;React.createContext(), and pass the context object to React Redux&#x27;s Provider and specific components&quot;</span> +</span><br><span class="line">    <span class="string">&#x27; like: &lt;Provider context=&#123;MyContext&#125;&gt;&lt;ConnectedComponent context=&#123;MyContext&#125; /&gt;&lt;/Provider&gt;. &#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;You may also pass a &#123;context : MyContext&#125; option to connect&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    storeKey === <span class="string">&#x27;store&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;storeKey has been removed and does not do anything. &#x27;</span> +</span><br><span class="line">      customStoreWarningMessage</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Context</span> = context</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">invariant</span>(</span><br><span class="line">        <span class="title function_">isValidElementType</span>(<span class="title class_">WrappedComponent</span>),</span><br><span class="line">        <span class="string">`You must pass a component to the function returned by `</span> +</span><br><span class="line">          <span class="string">`<span class="subst">$&#123;methodName&#125;</span>. Instead received <span class="subst">$&#123;stringifyComponent(</span></span></span><br><span class="line"><span class="subst"><span class="string">            WrappedComponent</span></span></span><br><span class="line"><span class="subst"><span class="string">          )&#125;</span>`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> wrappedComponentName =</span><br><span class="line">      <span class="title class_">WrappedComponent</span>.<span class="property">displayName</span> || <span class="title class_">WrappedComponent</span>.<span class="property">name</span> || <span class="string">&#x27;Component&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> displayName = <span class="title function_">getDisplayName</span>(wrappedComponentName)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> selectorFactoryOptions = &#123;</span><br><span class="line">      ...connectOptions,</span><br><span class="line">      getDisplayName,</span><br><span class="line">      methodName,</span><br><span class="line">      renderCountProp,</span><br><span class="line">      shouldHandleStateChanges,</span><br><span class="line">      storeKey,</span><br><span class="line">      displayName,</span><br><span class="line">      wrappedComponentName,</span><br><span class="line">      <span class="title class_">WrappedComponent</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; pure &#125; = connectOptions</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">OuterBaseComponent</span> = <span class="title class_">Component</span></span><br><span class="line">    <span class="comment">// 根据pure 选择使用Component还是PureComponent</span></span><br><span class="line">    <span class="keyword">if</span> (pure) &#123;</span><br><span class="line">      <span class="title class_">OuterBaseComponent</span> = <span class="title class_">PureComponent</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Connect</span> <span class="keyword">extends</span> <span class="title class_ inherited__">OuterBaseComponent</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Connect</span>.<span class="property">WrappedComponent</span> = <span class="title class_">WrappedComponent</span></span><br><span class="line">    <span class="title class_">Connect</span>.<span class="property">displayName</span> = displayName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (forwardRef) &#123;</span><br><span class="line">      <span class="comment">// 转发ref到Connect组件 将props转化为wrapperProps  ref转化为forwardedRef</span></span><br><span class="line">      <span class="keyword">const</span> forwarded = <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="keyword">function</span> <span class="title function_">forwardConnectRef</span>(<span class="params"></span></span><br><span class="line"><span class="params">        props,</span></span><br><span class="line"><span class="params">        ref</span></span><br><span class="line"><span class="params">      </span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Connect</span> <span class="attr">wrapperProps</span>=<span class="string">&#123;props&#125;</span> <span class="attr">forwardedRef</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      forwarded.<span class="property">displayName</span> = displayName</span><br><span class="line">      forwarded.<span class="property">WrappedComponent</span> = <span class="title class_">WrappedComponent</span></span><br><span class="line">      <span class="comment">// 合并static methods</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">hoistStatics</span>(forwarded, <span class="title class_">WrappedComponent</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hoistStatics</span>(<span class="title class_">Connect</span>, <span class="title class_">WrappedComponent</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的作用主要是就是返回一个新的组件<br>重点看 Connect组件</p>
<figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Connect</span> <span class="keyword">extends</span> <span class="title class_ inherited__">OuterBaseComponent</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      forwardRef ? !props.<span class="property">wrapperProps</span>[storeKey] : !props[storeKey],</span><br><span class="line">      <span class="string">&#x27;Passing redux store in props has been removed and does not do anything. &#x27;</span> +</span><br><span class="line">        customStoreWarningMessage</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">selectDerivedProps</span> = <span class="title function_">makeDerivedPropsSelector</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">selectChildElement</span> = <span class="title function_">makeChildElementSelector</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">indirectRenderWrappedComponent</span> = <span class="variable language_">this</span>.<span class="property">indirectRenderWrappedComponent</span>.<span class="title function_">bind</span>(</span><br><span class="line">      <span class="variable language_">this</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Context.Consumer的children</span></span><br><span class="line">  <span class="title function_">indirectRenderWrappedComponent</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="comment">// calling renderWrappedComponent on prototype from indirectRenderWrappedComponent bound to `this`</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">renderWrappedComponent</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">renderWrappedComponent</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      value,</span><br><span class="line">      <span class="string">`Could not find &quot;store&quot; in the context of `</span> +</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;displayName&#125;</span>&quot;. Either wrap the root component in a &lt;Provider&gt;, `</span> +</span><br><span class="line">        <span class="string">`or pass a custom React context provider to &lt;Provider&gt; and the corresponding `</span> +</span><br><span class="line">        <span class="string">`React context consumer to <span class="subst">$&#123;displayName&#125;</span> in connect options.`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> &#123; storeState, store &#125; = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> wrapperProps = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">    <span class="keyword">let</span> forwardedRef</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (forwardRef) &#123;</span><br><span class="line">      wrapperProps = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">wrapperProps</span></span><br><span class="line">      forwardedRef = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">forwardedRef</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> derivedProps = <span class="variable language_">this</span>.<span class="title function_">selectDerivedProps</span>(</span><br><span class="line">      storeState,</span><br><span class="line">      wrapperProps,</span><br><span class="line">      store,</span><br><span class="line">      selectorFactoryOptions</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">selectChildElement</span>(</span><br><span class="line">      <span class="title class_">WrappedComponent</span>,</span><br><span class="line">      derivedProps,</span><br><span class="line">      forwardedRef</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 使用默认的context源还是 外部传入的context</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">ContextToUse</span> =</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span> &amp;&amp;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span>.<span class="property">Consumer</span> &amp;&amp;</span><br><span class="line">      <span class="title function_">isContextConsumer</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">this.props.context.Consumer</span> /&gt;</span></span>)</span><br><span class="line">        ? <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">context</span></span><br><span class="line">        : <span class="title class_">Context</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">ContextToUse.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;this.indirectRenderWrappedComponent&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ContextToUse.Consumer</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先从构造函数看起</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">selectDerivedProps</span> = <span class="title function_">makeDerivedPropsSelector</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">selectChildElement</span> = <span class="title function_">makeChildElementSelector</span>()</span><br></pre></td></tr></table></figure>
<p>makeDerivedPropsSelector、makeChildElementSelector方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeDerivedPropsSelector</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastProps</span><br><span class="line">  <span class="keyword">let</span> lastState</span><br><span class="line">  <span class="keyword">let</span> lastDerivedProps</span><br><span class="line">  <span class="keyword">let</span> lastStore</span><br><span class="line">  <span class="keyword">let</span> lastSelectorFactoryOptions</span><br><span class="line">  <span class="keyword">let</span> sourceSelector</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">selectDerivedProps</span>(<span class="params"></span></span><br><span class="line"><span class="params">    state,</span></span><br><span class="line"><span class="params">    props,</span></span><br><span class="line"><span class="params">    store,</span></span><br><span class="line"><span class="params">    selectorFactoryOptions</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pure &amp;&amp; lastProps === props &amp;&amp; lastState === state) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastDerivedProps</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      store !== lastStore ||</span><br><span class="line">      lastSelectorFactoryOptions !== selectorFactoryOptions</span><br><span class="line">    ) &#123;</span><br><span class="line">      lastStore = store</span><br><span class="line">      lastSelectorFactoryOptions = selectorFactoryOptions</span><br><span class="line">      sourceSelector = <span class="title function_">selectorFactory</span>(</span><br><span class="line">        store.<span class="property">dispatch</span>,</span><br><span class="line">        selectorFactoryOptions</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastProps = props</span><br><span class="line">    lastState = state</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> nextProps = <span class="title function_">sourceSelector</span>(state, props)</span><br><span class="line"></span><br><span class="line">    lastDerivedProps = nextProps</span><br><span class="line">    <span class="keyword">return</span> lastDerivedProps</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeChildElementSelector</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastChildProps, lastForwardRef, lastChildElement, lastComponent</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">selectChildElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">    WrappedComponent,</span></span><br><span class="line"><span class="params">    childProps,</span></span><br><span class="line"><span class="params">    forwardRef</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      childProps !== lastChildProps ||</span><br><span class="line">      forwardRef !== lastForwardRef ||</span><br><span class="line">      lastComponent !== <span class="title class_">WrappedComponent</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      lastChildProps = childProps</span><br><span class="line">      lastForwardRef = forwardRef</span><br><span class="line">      lastComponent = <span class="title class_">WrappedComponent</span></span><br><span class="line">      lastChildElement = (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...childProps</span>&#125; <span class="attr">ref</span>=<span class="string">&#123;forwardRef&#125;</span> /&gt;</span></span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lastChildElement</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>makeDerivedPropsSelector<br>这个方法这就要是给组件接收从store衍生的props做了一层缓存 细节可以自己去看 这边主要看一下用到的selectorFactory方法 这个方法是connectAdvanced的入参<br>回到src&#x2F;connect&#x2F;connect.js 这个selectorFactory有一个默认值为defaultSelectorFactory 我们看一下src&#x2F;connect&#x2F;selectorFactory.js</li>
</ol>
<h4 id="src-connect-selectorFactory-js"><a href="#src-connect-selectorFactory-js" class="headerlink" title="src&#x2F;connect&#x2F;selectorFactory.js"></a>src&#x2F;connect&#x2F;selectorFactory.js</h4><p>接收dispatch和options作为参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">finalPropsSelectorFactory</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatch,</span></span><br><span class="line"><span class="params">  &#123; initMapStateToProps, initMapDispatchToProps, initMergeProps, ...options &#125;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// initMapStateToProps、initMapDispatchToProps、initMergeProps就是在createConnect中 经由match计算的结果initProxySelector</span></span><br><span class="line">  <span class="comment">// 所以我们在下面回顾一下这个方法</span></span><br><span class="line">  <span class="keyword">const</span> mapStateToProps = <span class="title function_">initMapStateToProps</span>(dispatch, options)</span><br><span class="line">  <span class="comment">// 同上</span></span><br><span class="line">  <span class="keyword">const</span> mapDispatchToProps = <span class="title function_">initMapDispatchToProps</span>(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mergeProps = <span class="title function_">initMergeProps</span>(dispatch, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">verifySubselectors</span>(</span><br><span class="line">      mapStateToProps,</span><br><span class="line">      mapDispatchToProps,</span><br><span class="line">      mergeProps,</span><br><span class="line">      options.<span class="property">displayName</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据pure选择不同的计算方法</span></span><br><span class="line">  <span class="comment">// 如果pure为false 无脑根据mapStateToProps和mapDispatchToProps的值计算merge到组件props的结果</span></span><br><span class="line">  <span class="comment">// 如果为true 会依据组件props是否改变或者stateStore是否变化相应的计算最终结果</span></span><br><span class="line">  <span class="keyword">const</span> selectorFactory = options.<span class="property">pure</span></span><br><span class="line">    ? pureFinalPropsSelectorFactory</span><br><span class="line">    : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">selectorFactory</span>(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch,</span><br><span class="line">    options</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initProxySelector方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initProxySelector</span>(<span class="params">dispatch, &#123; displayName &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回一个proxy方法 带有mapToProps属性</span></span><br><span class="line">    <span class="comment">// 在高阶组收集statsToProps或者dispatchToPros的时候会触发这个函数</span></span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="keyword">function</span> <span class="title function_">mapToPropsProxy</span>(<span class="params">stateOrDispatch, ownProps</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> proxy.<span class="property">dependsOnOwnProps</span></span><br><span class="line">        ? proxy.<span class="title function_">mapToProps</span>(stateOrDispatch, ownProps)</span><br><span class="line">        : proxy.<span class="title function_">mapToProps</span>(stateOrDispatch)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow detectFactoryAndVerify to get ownProps</span></span><br><span class="line">    proxy.<span class="property">dependsOnOwnProps</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    proxy.<span class="property">mapToProps</span> = <span class="keyword">function</span> <span class="title function_">detectFactoryAndVerify</span>(<span class="params"></span></span><br><span class="line"><span class="params">      stateOrDispatch,</span></span><br><span class="line"><span class="params">      ownProps</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">      <span class="comment">// 将mapToProps赋值给proxy.mapToProps 这样下面的proxy(stateOrDispatch, ownProps) 实际上跑的就是传入的mapToProps了</span></span><br><span class="line">      proxy.<span class="property">mapToProps</span> = mapToProps</span><br><span class="line">      <span class="comment">// dependsOnOwnProps属性是为了后面避免重复计算的判断依据之一 也根据这个属性判断是否需要传入组件自身的props到mapStateToProps和mapDispatchToProps里</span></span><br><span class="line">      proxy.<span class="property">dependsOnOwnProps</span> = <span class="title function_">getDependsOnOwnProps</span>(mapToProps)</span><br><span class="line">      <span class="keyword">let</span> props = <span class="title function_">proxy</span>(stateOrDispatch, ownProps)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 为了防止用户手动使用了缓存机制 判断是否存在闭包 做一层递归处理 知道得到最终mapStateToProps和mapDispatchToProps计算后的值</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> props === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 此时props就是新的mapToProps方法</span></span><br><span class="line">        proxy.<span class="property">mapToProps</span> = props</span><br><span class="line">        proxy.<span class="property">dependsOnOwnProps</span> = <span class="title function_">getDependsOnOwnProps</span>(props)</span><br><span class="line">        props = <span class="title function_">proxy</span>(stateOrDispatch, ownProps)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>)</span><br><span class="line">        <span class="title function_">verifyPlainObject</span>(props, displayName, methodName)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> props</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>回到Connect的构造函数 还有一个makeChildElementSelector方法<br>这个方法是的作用是对组件进行缓存 判断组件props ref和wrapperComponent返回新旧组件</p>
<p>以上就是简要的介绍了react-redux的源码 后续还会有补充…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/22/react-redux%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" data-id="cm54yagl10008b3hgfhrfhbpj" data-title="react-redux源码解读" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redux%E3%80%81react-redux/" rel="tag">redux、react-redux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-读redux源码" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/20/%E8%AF%BBredux%E6%BA%90%E7%A0%81/" class="article-date">
  <time class="dt-published" datetime="2019-03-20T06:07:53.000Z" itemprop="datePublished">2019-03-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/03/20/%E8%AF%BBredux%E6%BA%90%E7%A0%81/">读redux源码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Redux源码解读"><a href="#Redux源码解读" class="headerlink" title="Redux源码解读"></a>Redux源码解读</h3><p>早就想找个时间看看react全家桶的源码了 这次先从redux看起，后续还会有react-redux和react-router-redux</p>
<p>下面看代码<br>目录结构如下:</p>
<ol>
<li>applyMiddleware.js</li>
<li>bindActionCreator.js</li>
<li>combineReducers.js</li>
<li>compose.js</li>
<li>createStore.js</li>
<li>index.js</li>
</ol>
<p>先看入口文件</p>
<h4 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h4><p>入口文件主要是暴露1-5的核心方法 代码就不贴了</p>
<h4 id="createStore-js"><a href="#createStore-js" class="headerlink" title="createStore.js"></a>createStore.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reducer是一个函数， 接收一个单独的reducer或者经过combineRedeucers组合的多个reducer</span></span><br><span class="line"><span class="comment">// preloadedState 是指需要提前加载的state 会和各store的state一起整合到state树里</span></span><br><span class="line"><span class="comment">// enhancer 是store的增强器 下面会重点讲  会涉及到compose和applyMiddleware这两个核心函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果第二个参数是个函数 并且没有第三个参数 就默认没有穿preloadedState 直接传了增强器函数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果有增强器但是增强器不是函数 抛出异常</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the enhancer to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存在函数类型的增强器就返回执行增强器执行后的结果</span></span><br><span class="line">    <span class="comment">// 这里可以推测出增强器的函数结构应该是这样的</span></span><br><span class="line">    <span class="comment">// const enhancer = createStore =&gt; (reducer, preloadedState, enhancer) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//   const store = createStore(reducer, preloadedState, enhancer)</span></span><br><span class="line">    <span class="comment">//   return &#123;</span></span><br><span class="line">    <span class="comment">//     ...store,</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// 所以可以猜测enhancer是为了通过覆盖达到增强store的某一个属性  下面再细说</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">enhancer</span>(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果reducer不是函数 抛异常</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> reducer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the reducer to be a function.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> currentReducer = reducer</span><br><span class="line">  <span class="comment">// 当前的state树</span></span><br><span class="line">  <span class="keyword">let</span> currentState = preloadedState</span><br><span class="line">  <span class="comment">// 这里为什么药声明两个监听队列呢？</span></span><br><span class="line">  <span class="comment">// 作者是为了在dispatch的时候能够完整的执行所有的事件监听 </span></span><br><span class="line">  <span class="comment">// 有人试验过 在一个监听里面取消另一个监听 这个一个无效操作  feature or bug???</span></span><br><span class="line">  <span class="keyword">let</span> currentListeners = []</span><br><span class="line">  <span class="keyword">let</span> nextListeners = currentListeners</span><br><span class="line">  <span class="comment">// 是否正在dispatch过程</span></span><br><span class="line">  <span class="keyword">let</span> isDispatching = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 确保nextListeners 和 currentListeners没有引用关系</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">ensureCanMutateNextListeners</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.<span class="title function_">slice</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个是获取到最新state内容</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.getState() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;The reducer has already received the state as an argument. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Pass it down from the top reducer instead of reading it from the store.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 这个subscribe是为了给currentListener增加监听事件 下面的dispatch函数中 在执行完dispatch操作后 会遍历这个监听队列依次订阅的监听事件</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the listener to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保证不能再dispatch的过程中触发监听事件</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.subscribe() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;If you would like to be notified after the store has been updated, subscribe from a &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;component and invoke store.getState() in the callback to access the latest state. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribe(listener) for more details.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">    <span class="comment">// 监听事件入栈</span></span><br><span class="line">    nextListeners.<span class="title function_">push</span>(listener)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这种写法还是比较常见且妙的 添加监听事件后 通过闭包返回一个移除当前监听事件的方法</span></span><br><span class="line">    <span class="comment">// 用法如下</span></span><br><span class="line">    <span class="comment">// const store = createStore(...)</span></span><br><span class="line">    <span class="comment">// const subscribe = store.subscribe(() =&gt; &#123;&#125;)</span></span><br><span class="line">    <span class="comment">// 移除只需要执行subscribe()就行了</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 如果该监听被取消</span></span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 无法再dispatch过程中移除监听事件</span></span><br><span class="line">      <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">          <span class="string">&#x27;You may not unsubscribe from a store listener while the reducer is executing. &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribe(listener) for more details.&#x27;</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 监听取消的标志</span></span><br><span class="line">      isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">      <span class="keyword">const</span> index = nextListeners.<span class="title function_">indexOf</span>(listener)</span><br><span class="line">      <span class="comment">// 监听事件移除</span></span><br><span class="line">      nextListeners.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每个redux middleware都是一个对dispatch的一个增强</span></span><br><span class="line">  <span class="comment">// 是redux的dispatch方法 也是页面修改树状态的唯一途径</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">    <span class="comment">// 首先判断action是不是一个纯对象 即通过&#123;&#125;或者new Object()创建</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(action)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Actions must be plain objects. &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;Use custom middleware for async actions.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 保证每个action必须有type属性</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action.<span class="property">type</span> === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Actions may not have an undefined &quot;type&quot; property. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Have you misspelled a constant?&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 一个action结束才能调用下一个</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Reducers may not dispatch actions.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      <span class="comment">// 这是执行reducer的函数 下面讲到combineReducers的时候再重点讲</span></span><br><span class="line">      currentState = <span class="title function_">currentReducer</span>(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历触发subscribe添加的监听</span></span><br><span class="line">    <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      <span class="title function_">listener</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 替换当前reducer 这个只在热更新上用过</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">replaceReducer</span>(<span class="params">nextReducer</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the nextReducer to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">REPLACE</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个待看 暂时不知道是干嘛的</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">observable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> outerSubscribe = subscribe</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * The minimal observable subscription method.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; observer Any object that can be used as an observer.</span></span><br><span class="line"><span class="comment">       * The observer object should have a `next` method.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@returns</span> &#123;<span class="type">subscription</span>&#125; An object with an `unsubscribe` method that can</span></span><br><span class="line"><span class="comment">       * be used to unsubscribe the observable from the store, and prevent further</span></span><br><span class="line"><span class="comment">       * emission of values from the observable.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="title function_">subscribe</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> observer !== <span class="string">&#x27;object&#x27;</span> || observer === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Expected the observer to be an object.&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">observeState</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (observer.<span class="property">next</span>) &#123;</span><br><span class="line">            observer.<span class="title function_">next</span>(<span class="title function_">getState</span>())</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">observeState</span>()</span><br><span class="line">        <span class="keyword">const</span> unsubscribe = <span class="title function_">outerSubscribe</span>(observeState)</span><br><span class="line">        <span class="keyword">return</span> &#123; unsubscribe &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      [$$observable]() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 初始化store</span></span><br><span class="line">  <span class="comment">// 收集每个独立store上的state  因为每个store都default返回自身的state</span></span><br><span class="line">  <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">INIT</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer,</span><br><span class="line">    [$$observable]: observable</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面我们看看combineReducers做了什么</p>
<h4 id="combineReducers-js"><a href="#combineReducers-js" class="headerlink" title="combineReducers.js"></a>combineReducers.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 看这个文件名字就知道是一个组合多个reducer的方法</span></span><br><span class="line"><span class="comment">// reducers的结构如下</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* &#123;</span></span><br><span class="line"><span class="comment">*   demo1: function(state, action) &#123;</span></span><br><span class="line"><span class="comment">*     switch(action.type) &#123;&#125;</span></span><br><span class="line"><span class="comment">*   &#125;,</span></span><br><span class="line"><span class="comment">*   demo2: function(state, action) &#123;</span></span><br><span class="line"><span class="comment">*     switch(action.type) &#123;&#125;</span></span><br><span class="line"><span class="comment">*   &#125;,</span></span><br><span class="line"><span class="comment">* &#125;</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">combineReducers</span>(<span class="params">reducers</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warning</span>(<span class="string">`No reducer provided for key &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 保证每个reducer对应的value都是函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unexpectedKeyCache</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> shapeAssertionError</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 这个方法是为了保证每个自定义reducer至少有一个初始的state和兜底返回值</span></span><br><span class="line">    <span class="title function_">assertReducerShape</span>(finalReducers)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;s</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这一步才是重点</span></span><br><span class="line">  <span class="comment">// 返回createStore/dispatch方法中有一行: currentState = currentReducer(currentState, action)</span></span><br><span class="line">  <span class="comment">// 所以这个方法才是真正修改状态树的方法</span></span><br><span class="line">  <span class="comment">// combination方法会遍历传进来的多个reducers组成的对象 依次执行每个reducer 得到每个reducer相应的state</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">combination</span>(<span class="params">state = &#123;&#125;, action</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> warningMessage = <span class="title function_">getUnexpectedStateShapeWarningMessage</span>(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (warningMessage) &#123;</span><br><span class="line">        <span class="title function_">warning</span>(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每次dispatch的都会遍历reducer树让每个小reducer执行这个action</span></span><br><span class="line">    <span class="comment">// 保证每次dispatch 都是根据上次的state进行操作的</span></span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = <span class="title function_">reducer</span>(previousStateForKey, action)</span><br><span class="line">      <span class="comment">// 该type没有定义 抛异常</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> errorMessage = <span class="title function_">getUndefinedStateErrorMessage</span>(key, action)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看完以上代码我们先举个小例子介绍一下enhancer到底是何方神圣</p>
<ol>
<li>touch index.js</li>
<li>开始写demo</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createStore, combineReducers, applyMiddleware, compose &#125; = <span class="built_in">require</span>(<span class="string">&#x27;redux&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count1</span>(<span class="params">state = initialState, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(count1)</span><br><span class="line"><span class="keyword">const</span> action1 = &#123; <span class="attr">type</span>: <span class="string">&#x27;ADD&#x27;</span> &#125;</span><br><span class="line">store.<span class="title function_">dispatch</span>(action1)</span><br><span class="line"><span class="comment">// 我们打印store.getStore()</span></span><br><span class="line"><span class="comment">// 结果是 &#123; count1: &#123; count: 2 &#125; &#125;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 上面是redux的基本使用 我们主要讲的是store增强器</span></span><br><span class="line"><span class="comment">* 以上也有提到增强器的主要结构</span></span><br><span class="line"><span class="comment">* 我们再做个小demo</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个每次dispatch前后打印日志的增强器</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loggerEnhancer</span> = createStore =&gt; <span class="function">(<span class="params">reducer, proloadedState</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> store = <span class="title function_">createStore</span>(reducer, proloadedState)</span><br><span class="line">  <span class="comment">// 重写dispatch方法 或者说是在原有的dispatch上包了一层</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dispatch action type: <span class="subst">$&#123;action.type&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> _action = store.<span class="title function_">dispatch</span>(action)</span><br><span class="line">    <span class="keyword">const</span> nextState = store.<span class="title function_">getState</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;new state is:&#x27;</span>, nextState)</span><br><span class="line">    <span class="comment">// 原来的dispatch就是个纯函数  所以这里的_action就是入参action</span></span><br><span class="line">    <span class="keyword">return</span> _action</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...store,</span><br><span class="line">    dispatch,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> storeWithLogger = <span class="title function_">createStore</span>(count1, loggerEnhancer)</span><br><span class="line">storeWithLogger.<span class="title function_">dispatch</span>(action1)</span><br><span class="line"><span class="comment">// 这样在dispatch的时候就会出现我们的logger内容</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 写到这儿的时候我在想 咦 这玩意儿怎么和redux中间件这么像 肯定compose和applyMiddleware有关系</span></span><br><span class="line"><span class="comment">// 好奇心驱使下 去看了compose和applyMiddleware</span></span><br></pre></td></tr></table></figure>

<p>接着我们看看compose和applyMiddleware做了什么吧~</p>
<h4 id="compose-js"><a href="#compose-js" class="headerlink" title="compose.js"></a>compose.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">compose</span>(<span class="params">...funcs</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> funcs.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">a</span>(<span class="title function_">b</span>(...args)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>compose的代码很少 通过reduce方法将各中间件形成一个执行链 前一个中间件套在后一个的外层 并接受后一个函数的执行结果作为自己的入参<br>举个栗子吧</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> b = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="title function_">compose</span>([a, b, c])</span><br><span class="line"><span class="comment">// 先处理a和b 返回 </span></span><br><span class="line"><span class="keyword">const</span> ab = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">a</span>(<span class="title function_">b</span>(...args))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 再处理ab和c 返回 </span></span><br><span class="line"><span class="keyword">const</span> abc = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">ab</span>(<span class="title function_">c</span>(...args))</span><br><span class="line">  <span class="comment">// 这个c(...args)执行结果就是ab的入参</span></span><br><span class="line">  <span class="comment">// 所以我们可以换个写法</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">a</span>(<span class="title function_">b</span>(<span class="title function_">c</span>(...args)))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 换而言之compose的返回值就是 (...args) =&gt; a(b(c(...args))) </span></span><br></pre></td></tr></table></figure>

<h4 id="applyMiddleware-js"><a href="#applyMiddleware-js" class="headerlink" title="applyMiddleware.js"></a>applyMiddleware.js</h4><p>我们看看applyMiddleware是怎么实现的 找找他是怎么通过compose组合成enhancer的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 看到这段代码 我觉得猜测是对的 是不是有点像上面的loggerEnhancer的结构 重写dispatch方法</span></span><br><span class="line"><span class="comment">// 所以得出结论 与其说增强器是对store的增强不如说是对dispatch的增强</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">applyMiddleware</span>(<span class="params">...middlewares</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里的...args是 reducers、preloadedState、enhancer</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">createStore</span>(...args)</span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">dispatch</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`Dispatching while constructing your middleware is not allowed. `</span> +</span><br><span class="line">          <span class="string">`Other middleware would not be applied to this dispatch.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      <span class="attr">getState</span>: store.<span class="property">getState</span>,</span><br><span class="line">      <span class="attr">dispatch</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">dispatch</span>(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.<span class="title function_">map</span>(<span class="function"><span class="params">middleware</span> =&gt;</span> <span class="title function_">middleware</span>(middlewareAPI))</span><br><span class="line">    <span class="comment">// 这里的compose的作用是包裹所有dispatch操作</span></span><br><span class="line">    dispatch = <span class="title function_">compose</span>(...chain)(store.<span class="property">dispatch</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再写个使用applyMiddleware小demo 通过demo我们再进行设想</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createStore, applyMiddleware, compose &#125; = <span class="built_in">require</span>(<span class="string">&#x27;redux&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count1</span>(<span class="params">state = initialState, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(count1, <span class="title function_">applyMiddleware</span>(fn1, fn2))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面两个fn1和fn2我们都没定义 现在我们根据applyMiddleware猜测一下fn1和fn2是啥样子的</span></span><br><span class="line"><span class="comment">// 根据loggerEnhancer的设想 </span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">enhancer</span> = createStore =&gt; <span class="function">(<span class="params">reducers, preloadedState, enhancer</span>) =&gt;</span> &#123;&#125; </span><br><span class="line"><span class="comment">// applyMiddleware也应该是这样的函数体</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chain = middlewares.<span class="title function_">map</span>(<span class="function"><span class="params">middleware</span> =&gt;</span> <span class="title function_">middleware</span>(middlewareAPI))</span><br><span class="line"><span class="comment">// 这行代码可以看出 fn1的雏形 应该是这样的</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = (<span class="params">&#123; dispatch, getState &#125;</span>) =&gt; &#123;&#125;</span><br><span class="line"><span class="comment">// 但是通过compose方法还能接受store.dispatch作为入参 说明fn1应该是这样的</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = (<span class="params">&#123; dispatch, getState &#125;</span>) =&gt; <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="comment">// 通过返回的是一个dispatch 我可以知道fn1原来是这样的</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = (<span class="params">&#123; dispatch, getState &#125;</span>) =&gt; <span class="function"><span class="params">dispatch</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="comment">// 举个栗子</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">a</span> = dispatch =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">b</span> = dispatch =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="comment">// compose([a, b])的结果为 (...args) =&gt; a(b(...args))</span></span><br><span class="line"><span class="comment">// compose([a, b])(store.dispatch) 结果为 a(b(dispatch)) 再做简化就是a(action =&gt; &#123;&#125;)</span></span><br><span class="line"><span class="comment">// 从这里可以看出 a执行的dispatch其实就是 b(dispatch)的结果 </span></span><br><span class="line"><span class="comment">// 如果还有c c执行dispatch就是a(dispatch) 从而达到中间件的作用</span></span><br><span class="line"><span class="comment">// a执行的dispatch就是dispatch</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 举个更确切的栗子</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn1</span> = store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;next1&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>(action)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fn2</span> = store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;next2&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>(action)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 在执行applyMiddleware时  执行了compose(...chain)(store.sidpatch) 执行顺序是 next2 、 next1  这是中间件入栈的顺序</span></span><br><span class="line"><span class="comment">* 但是调用的顺序不一样  有兴趣可以了解一下洋葱模型</span></span><br><span class="line"><span class="comment">* 执行store.dispatch(action1) 实际打印顺序是 fn1、fn2、fn2、fn1</span></span><br><span class="line"><span class="comment">* fn2在传入store.dispatch的时候 会将</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">dispatchFromStore</span> = action =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">  <span class="title function_">next</span>(action)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn2&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 当做返回值传给fn1的next</span></span><br><span class="line"><span class="comment">* 那fn1的执行过程就是</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">dispatchFromFn2</span> = action =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">  <span class="title function_">dispatchFromStore</span>(action)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fn1&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 所以打印顺序是fn1、fn2、fn2、fn1就不奇怪了</span></span><br></pre></td></tr></table></figure>

<h4 id="bindActionCreators-js"><a href="#bindActionCreators-js" class="headerlink" title="bindActionCreators.js"></a>bindActionCreators.js</h4><p>这个文件没有被主函数用到 是被暴露给开发者使用的一个工具函数 用来更方便的组合你的action</p>
<h4 id="createStore-observer方法"><a href="#createStore-observer方法" class="headerlink" title="createStore&#x2F;observer方法"></a>createStore&#x2F;observer方法</h4><p>这个方法上面没有讲到 也是暴露给开发者的API 我们放到以后讲</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>这一遍过下来基本就能熟练使用redux的大部分特性了 也感叹代码的精妙 尤其是组合中间件的代码 nb~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/20/%E8%AF%BBredux%E6%BA%90%E7%A0%81/" data-id="cm54yagl70017b3hg8h1f88kl" data-title="读redux源码" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redux%E3%80%81react/" rel="tag">redux、react</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-vuex的takeLatest化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/03/19/vuex%E7%9A%84takeLatest%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2019-03-19T05:04:04.000Z" itemprop="datePublished">2019-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/03/19/vuex%E7%9A%84takeLatest%E5%8C%96/">vuex的takeLatest化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="vuex异步调用的takeLatest化-记一次项目中遇到的小问题"><a href="#vuex异步调用的takeLatest化-记一次项目中遇到的小问题" class="headerlink" title="vuex异步调用的takeLatest化(记一次项目中遇到的小问题)"></a>vuex异步调用的takeLatest化(记一次项目中遇到的小问题)</h3><ul>
<li><p>前言: 第一次接触到takeLatest是在redux-saga, 包括takeLatest&#x2F;takeEvery等</p>
</li>
<li><p>问题描述: 在一个有多级品类选择的页面 点击一个标签查询一次<br>后端接口在数据量比较大的情况下查询时间可能比较慢 并且接口的返回顺序不一定是前端页面调用的顺序<br>这个问题困扰了很久 解决办法有以下几种</p>
<blockquote>
<ol>
<li>跟产品沟通，用户每选择一个品类，让用户手动点击查询按钮，并提供loading蒙层 使用户没法在数据未返回之前继续操作</li>
<li>前端参数hash化 将请求参数hash化 将页面所有请求的数据通过参数的hash值保存在store 通过getter得到本次hash对应的数据</li>
</ol>
</blockquote>
</li>
<li><p>以上两种方法 都很麻烦 第一个是需要更换用户体验 第二个会存储很多不需要的数据 且在特定场景下可能会造成性能问题</p>
</li>
<li><p>于是参考了redux-saga的takeLatest实现一下代码</p>
</li>
</ul>
<h4 id="代码如下"><a href="#代码如下" class="headerlink" title="代码如下"></a>代码如下</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">takeLatest</span>(<span class="params">action</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastRun = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">async</span> (context, payload) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 用户每次点击进来都会将当前时间赋給lastRun</span></span><br><span class="line">    <span class="keyword">const</span> currentRun = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    lastRun = currentRun</span><br><span class="line">    <span class="keyword">const</span> &#123; commit, dispatch &#125; = context</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">commitLatest</span> = (<span class="params">...args</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastRun !== currentRun) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;ActionOutdatedError&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">commit</span>(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">dispatchLatest</span> = (<span class="params">...args</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastRun !== currentRun) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;ActionOutdatedError&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">dispatch</span>(...args)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">action</span>(&#123;</span><br><span class="line">        ...context,</span><br><span class="line">        <span class="attr">commit</span>: commitLatest,</span><br><span class="line">        <span class="attr">dispatch</span>: dispatchLatest,</span><br><span class="line">      &#125;, payload)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.<span class="property">message</span> === <span class="string">&#x27;ActionOutdatedError&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">/* eslint-ignore */</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;actions aborted, latest action work&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 接口层报错抛出</span></span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">actions</span>: &#123;</span><br><span class="line"> <span class="attr">getData</span>: <span class="title function_">takeLatest</span>(<span class="comment">/*参数为请求函数*/</span></span><br><span class="line">  <span class="title function_">async</span> (&#123; commit &#125;, payload) =&gt; &#123;</span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"> ), </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="如果我不用vuex怎么办呢？"><a href="#如果我不用vuex怎么办呢？" class="headerlink" title="如果我不用vuex怎么办呢？"></a>如果我不用vuex怎么办呢？</h3><p>当然在页面上使用也是一样的 唯一不同的是在页面上我们需要考虑做下this的指向问题</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">takeLatest</span>(<span class="params">action, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> latest = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    latest = current</span><br><span class="line">    <span class="keyword">const</span> context = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> commit = <span class="keyword">function</span> (<span class="params">...commitArgs</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (current !== latest) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;actionTakeLatest&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> cb.<span class="title function_">apply</span>(context, commitArgs)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> action.<span class="title function_">call</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">        <span class="attr">originArgs</span>: args,</span><br><span class="line">        commit,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.<span class="property">message</span> === <span class="string">&#x27;actionTakeLatest&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;action aborted&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面我们看个小demo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123; text &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;button @click=&quot;handleClick&quot;&gt;点击测试takeLatest&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      text: &#x27;&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    /* takeLatest的参数尽量不要是使用箭头函数 因为箭头函数一旦定义this就已经确定了 */</span><br><span class="line">    handleClick: takeLatest(</span><br><span class="line">      async function (&#123; originArgs, commit &#125;) &#123;</span><br><span class="line">        const res = await new Promise(resolve =&gt; setTimeout(() =&gt; resolve(Math.random()), Math.floor(Math.random() * 5000)))</span><br><span class="line">        commit(res)</span><br><span class="line">      &#125;,</span><br><span class="line">      function (payload)&#123;</span><br><span class="line">         this.text = payload</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/19/vuex%E7%9A%84takeLatest%E5%8C%96/" data-id="cm54yagl3000hb3hg5qeddm5g" data-title="vuex的takeLatest化" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vuex%E3%80%81takeLatest/" rel="tag">vuex、takeLatest</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; zurück</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/React%E3%80%81SSR/" rel="tag">React、SSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue2-x%E3%80%81%E6%8C%87%E4%BB%A4%E3%80%81v-model/" rel="tag">Vue2.x、指令、v-model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Watcher%E7%AF%87/" rel="tag">Watcher篇</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker%E3%80%81node/" rel="tag">docker、node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab-ci/" rel="tag">gitlab-ci</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js%E3%80%81es6/" rel="tag">js、es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvvm/" rel="tag">mvvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs-%E9%94%81-%E5%B9%B6%E5%8F%91/" rel="tag">nodejs 锁 并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qiankun%E3%80%81micro-frontend/" rel="tag">qiankun、micro-frontend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" rel="tag">react ref 笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redux%E3%80%81react/" rel="tag">redux、react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redux%E3%80%81react-redux/" rel="tag">redux、react-redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue2-x%E3%80%81Observer%E3%80%81Dep%E3%80%81Watcher%E3%80%81%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" rel="tag">vue2.x、Observer、Dep、Watcher、个人笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuex%E3%80%81takeLatest/" rel="tag">vuex、takeLatest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue%E3%80%81lazyload/" rel="tag">vue、lazyload</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue%E3%80%81%E7%AC%94%E8%AE%B0/" rel="tag">vue、笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/React%E3%80%81SSR/" style="font-size: 10px;">React、SSR</a> <a href="/tags/Vue2-x%E3%80%81%E6%8C%87%E4%BB%A4%E3%80%81v-model/" style="font-size: 10px;">Vue2.x、指令、v-model</a> <a href="/tags/Watcher%E7%AF%87/" style="font-size: 10px;">Watcher篇</a> <a href="/tags/docker%E3%80%81node/" style="font-size: 20px;">docker、node</a> <a href="/tags/gitlab-ci/" style="font-size: 10px;">gitlab-ci</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/js%E3%80%81es6/" style="font-size: 10px;">js、es6</a> <a href="/tags/mvvm/" style="font-size: 10px;">mvvm</a> <a href="/tags/nodejs-%E9%94%81-%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">nodejs 锁 并发</a> <a href="/tags/qiankun%E3%80%81micro-frontend/" style="font-size: 10px;">qiankun、micro-frontend</a> <a href="/tags/react-ref-%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">react ref 笔记</a> <a href="/tags/redux%E3%80%81react/" style="font-size: 10px;">redux、react</a> <a href="/tags/redux%E3%80%81react-redux/" style="font-size: 10px;">redux、react-redux</a> <a href="/tags/vue/" style="font-size: 10px;">vue</a> <a href="/tags/vue2-x%E3%80%81Observer%E3%80%81Dep%E3%80%81Watcher%E3%80%81%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">vue2.x、Observer、Dep、Watcher、个人笔记</a> <a href="/tags/vuex%E3%80%81takeLatest/" style="font-size: 10px;">vuex、takeLatest</a> <a href="/tags/vue%E3%80%81lazyload/" style="font-size: 10px;">vue、lazyload</a> <a href="/tags/vue%E3%80%81%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">vue、笔记</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/06/electron%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">Electron使用教程</a>
          </li>
        
          <li>
            <a href="/2020/12/18/%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81/">悲观锁/乐观锁</a>
          </li>
        
          <li>
            <a href="/2020/11/23/qiankun%E5%BE%AE%E5%89%8D%E7%AB%AF%E5%88%9D%E6%8E%A2/">qiankun微前端实践</a>
          </li>
        
          <li>
            <a href="/2019/12/19/Vue2-x%E4%B9%8Bv-model%E8%AF%A6%E8%A7%A3/">Vue2.x之v-model详解</a>
          </li>
        
          <li>
            <a href="/2019/12/18/Vue2-x-%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94Watcher%E7%AF%87%E8%AF%A6%E8%A7%A3/">Vue2.x-数据响应Watcher篇详解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 周小e丶<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>